<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>20160205-06e29e-HTTP2-codec-may-not-always-call-Http2ConnectiononStreamRemoved.html</title>
<meta name="Generator" content="Vim/7.4">
<meta name="plugin-version" content="vim7.4_v1">
<meta name="syntax" content="git">
<meta name="settings" content="number_lines,use_css,pre_wrap,no_foldcolumn,expand_tabs,line_ids,prevent_copy=">
<meta name="colorscheme" content="none">
<style type="text/css">
<!--
pre { white-space: pre-wrap; font-family: monospace; color: #000000; background-color: #ffffff; }
body { font-family: monospace; color: #000000; background-color: #ffffff; }
* { font-size: 1em; }
.Special { color: #c000c0; }
.Constant { color: #c00000; }
.LineNr { color: #af5f00; }
.Identifier { color: #008080; }
.Statement { color: #af5f00; }
.PreProc { color: #c000c0; }
.Type { color: #008000; }
.comment {
  font-weight: bold;
  font-size: 16px;
  background: #00FF00;
}
p {
  font-weight: bold;
  background: #00FF00;
}
.defect {
  font-weight: bold;
  background: #FF00FF;
}
-->
</style>

<script type='text/javascript'>
<!--

/* function to open any folds containing a jumped-to line before jumping to it */
function JumpToLine()
{
  var lineNum;
  lineNum = window.location.hash;
  lineNum = lineNum.substr(1); /* strip off '#' */

  if (lineNum.indexOf('L') == -1) {
    lineNum = 'L'+lineNum;
  }
  lineElem = document.getElementById(lineNum);
  /* Always jump to new location even if the line was hidden inside a fold, or
   * we corrected the raw number to a line ID.
   */
  if (lineElem) {
    lineElem.scrollIntoView(true);
  }
  return true;
}
if ('onhashchange' in window) {
  window.onhashchange = JumpToLine;
}

-->
</script>
</head>
<body onload='JumpToLine();'>
<pre id='vimCodeElement'>
<p>github page: <a href="https://github.com/netty/netty/pull/4860">https://github.com/netty/netty/pull/4860</a></p>
<span id="L1" class="LineNr">  1 </span><span class="Statement">commit</span> <span class="Identifier">06e29e0d1b4ebf16b47969d5fbc71bdaf19fe3e8</span>
<span id="L2" class="LineNr">  2 </span><span class="Statement">Author:</span> <span class="Constant">Scott Mitchell </span><span class="Special">&lt;</span><span class="Special">scott_mitchell@apple.com</span><span class="Special">&gt;</span>
<span id="L3" class="LineNr">  3 </span><span class="Statement">Date:</span>   <span class="Constant">Fri Feb 5 19:02:49 2016 -0800</span>
<span id="L4" class="LineNr">  4 </span>
<span id="L5" class="LineNr">  5 </span>    HTTP/2 codec may not always call Http2Connection.onStreamRemoved
<span id="L6" class="LineNr">  6 </span>
<span id="L7" class="LineNr">  7 </span>    Motivation:
<span id="L8" class="LineNr">  8 </span>    Http2Connection.onStreamRemoved is not always called if Http2Connection.onStreamAdded is called. This is problematic as users may rely on the onStreamRemoved method to be called to release ByteBuf objects and do other cleanup.
  <a class="defect">[TODO: elaborate on the 'not always called' part.]</a>
<span id="L9" class="LineNr">  9 </span>
<span id="L10" class="LineNr"> 10 </span>    Modifications:
<span id="L11" class="LineNr"> 11 </span>    - Http2Connection.close will remove all streams existing streams and prevent new ones from being created
<span id="L12" class="LineNr"> 12 </span>    - Http2ConnectionHandler will call the new close method in channelInactive
  <p>It is unbelievable that the original impl. of the Http2Connection does not have a close() method. Question: how to spot such deficiencies?</p>
<span id="L13" class="LineNr"> 13 </span>
<span id="L14" class="LineNr"> 14 </span>    Result:
<span id="L15" class="LineNr"> 15 </span>    Http2Connection.onStreamRemoved is always called when Http2Connection.onStreamRemoved is called to preserve the Http2Connection guarantees.
<span id="L16" class="LineNr"> 16 </span>    Fixes <a href="https://github.com/netty/netty/issues/4838">https://github.com/netty/netty/issues/4838</a>
<span id="L17" class="LineNr"> 17 </span>---
<span id="L18" class="LineNr"> 18 </span> codec-http2/src/main/java/io/netty/handler/codec/http2/DefaultHttp2Connection.java     | 147 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-------------------------------
<span id="L19" class="LineNr"> 19 </span> codec-http2/src/main/java/io/netty/handler/codec/http2/Http2Connection.java            |  12 ++++++++++++
<span id="L20" class="LineNr"> 20 </span> codec-http2/src/main/java/io/netty/handler/codec/http2/Http2ConnectionHandler.java     |  15 +++------------
<span id="L21" class="LineNr"> 21 </span> codec-http2/src/test/java/io/netty/handler/codec/http2/DefaultHttp2ConnectionTest.java | 174 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-------------------
<span id="L22" class="LineNr"> 22 </span> codec-http2/src/test/java/io/netty/handler/codec/http2/Http2ConnectionHandlerTest.java |   4 +++-
<span id="L23" class="LineNr"> 23 </span> 5 files changed, 289 insertions(+), 63 deletions(-)
<span id="L24" class="LineNr"> 24 </span>
<span id="L25" class="LineNr"> 25 </span><span class="Type">diff --git a/codec-http2/src/main/java/io/netty/handler/codec/http2/DefaultHttp2Connection.java b/codec-http2/src/main/java/io/netty/handler/codec/http2/DefaultHttp2Connection.java</span>
<span id="L26" class="LineNr"> 26 </span>index 589546d..6dae971 100644
<span id="L27" class="LineNr"> 27 </span><span class="Type">--- a/codec-http2/src/main/java/io/netty/handler/codec/http2/DefaultHttp2Connection.java</span>
<span id="L28" class="LineNr"> 28 </span><span class="Type">+++ b/codec-http2/src/main/java/io/netty/handler/codec/http2/DefaultHttp2Connection.java</span>
<span id="L29" class="LineNr"> 29 </span><span class="Statement">@@ -15,28 +15,16 @@</span>
<span id="L30" class="LineNr"> 30 </span>
<span id="L31" class="LineNr"> 31 </span> package io.netty.handler.codec.http2;
<span id="L32" class="LineNr"> 32 </span>
<span id="L33" class="LineNr"> 33 </span><span class="Special">-import static io.netty.handler.codec.http2.Http2CodecUtil.CONNECTION_STREAM_ID;</span>
<span id="L34" class="LineNr"> 34 </span><span class="Special">-import static io.netty.handler.codec.http2.Http2CodecUtil.DEFAULT_PRIORITY_WEIGHT;</span>
<span id="L35" class="LineNr"> 35 </span><span class="Special">-import static io.netty.handler.codec.http2.Http2CodecUtil.MAX_WEIGHT;</span>
<span id="L36" class="LineNr"> 36 </span><span class="Special">-import static io.netty.handler.codec.http2.Http2CodecUtil.MIN_WEIGHT;</span>
<span id="L37" class="LineNr"> 37 </span><span class="Special">-import static io.netty.handler.codec.http2.Http2Error.PROTOCOL_ERROR;</span>
<span id="L38" class="LineNr"> 38 </span><span class="Special">-import static io.netty.handler.codec.http2.Http2Error.REFUSED_STREAM;</span>
<span id="L39" class="LineNr"> 39 </span><span class="Special">-import static io.netty.handler.codec.http2.Http2Exception.closedStreamError;</span>
<span id="L40" class="LineNr"> 40 </span><span class="Special">-import static io.netty.handler.codec.http2.Http2Exception.connectionError;</span>
<span id="L41" class="LineNr"> 41 </span><span class="Special">-import static io.netty.handler.codec.http2.Http2Exception.streamError;</span>
<span id="L42" class="LineNr"> 42 </span><span class="Special">-import static io.netty.handler.codec.http2.Http2Stream.State.CLOSED;</span>
<span id="L43" class="LineNr"> 43 </span><span class="Special">-import static io.netty.handler.codec.http2.Http2Stream.State.HALF_CLOSED_LOCAL;</span>
<span id="L44" class="LineNr"> 44 </span><span class="Special">-import static io.netty.handler.codec.http2.Http2Stream.State.HALF_CLOSED_REMOTE;</span>
<span id="L45" class="LineNr"> 45 </span><span class="Special">-import static io.netty.handler.codec.http2.Http2Stream.State.IDLE;</span>
<span id="L46" class="LineNr"> 46 </span><span class="Special">-import static io.netty.handler.codec.http2.Http2Stream.State.OPEN;</span>
<span id="L47" class="LineNr"> 47 </span><span class="Special">-import static io.netty.handler.codec.http2.Http2Stream.State.RESERVED_LOCAL;</span>
<span id="L48" class="LineNr"> 48 </span><span class="Special">-import static io.netty.handler.codec.http2.Http2Stream.State.RESERVED_REMOTE;</span>
<span id="L49" class="LineNr"> 49 </span><span class="Special">-import static io.netty.util.internal.ObjectUtil.checkNotNull;</span>
<span id="L50" class="LineNr"> 50 </span> import io.netty.buffer.ByteBuf;
<span id="L51" class="LineNr"> 51 </span><span class="Identifier">+import io.netty.channel.ChannelPromise;</span>
<span id="L52" class="LineNr"> 52 </span> import io.netty.handler.codec.http2.Http2Stream.State;
<span id="L53" class="LineNr"> 53 </span> import io.netty.util.collection.IntCollections;
<span id="L54" class="LineNr"> 54 </span> import io.netty.util.collection.IntObjectHashMap;
<span id="L55" class="LineNr"> 55 </span> import io.netty.util.collection.IntObjectMap;
<span id="L56" class="LineNr"> 56 </span><span class="Identifier">+import io.netty.util.collection.IntObjectMap.PrimitiveEntry;</span>
<span id="L57" class="LineNr"> 57 </span><span class="Identifier">+import io.netty.util.concurrent.Future;</span>
<span id="L58" class="LineNr"> 58 </span><span class="Identifier">+import io.netty.util.concurrent.FutureListener;</span>
<span id="L59" class="LineNr"> 59 </span><span class="Identifier">+import io.netty.util.concurrent.Promise;</span>
<span id="L60" class="LineNr"> 60 </span> import io.netty.util.internal.EmptyArrays;
<span id="L61" class="LineNr"> 61 </span> import io.netty.util.internal.PlatformDependent;
<span id="L62" class="LineNr"> 62 </span> import io.netty.util.internal.SystemPropertyUtil;
<span id="L63" class="LineNr"> 63 </span><span class="Statement">@@ -51,6 +39,25 @@</span><span class="PreProc"> import java.util.LinkedHashSet;</span>
<span id="L64" class="LineNr"> 64 </span> import java.util.List;
<span id="L65" class="LineNr"> 65 </span> import java.util.Queue;
<span id="L66" class="LineNr"> 66 </span> import java.util.Set;
<span id="L67" class="LineNr"> 67 </span><span class="Identifier">+</span>
<span id="L68" class="LineNr"> 68 </span><span class="Identifier">+import static io.netty.handler.codec.http2.Http2CodecUtil.CONNECTION_STREAM_ID;</span>
<span id="L69" class="LineNr"> 69 </span><span class="Identifier">+import static io.netty.handler.codec.http2.Http2CodecUtil.DEFAULT_PRIORITY_WEIGHT;</span>
<span id="L70" class="LineNr"> 70 </span><span class="Identifier">+import static io.netty.handler.codec.http2.Http2CodecUtil.MAX_WEIGHT;</span>
<span id="L71" class="LineNr"> 71 </span><span class="Identifier">+import static io.netty.handler.codec.http2.Http2CodecUtil.MIN_WEIGHT;</span>
<span id="L72" class="LineNr"> 72 </span><span class="Identifier">+import static io.netty.handler.codec.http2.Http2Error.INTERNAL_ERROR;</span>
<span id="L73" class="LineNr"> 73 </span><span class="Identifier">+import static io.netty.handler.codec.http2.Http2Error.PROTOCOL_ERROR;</span>
<span id="L74" class="LineNr"> 74 </span><span class="Identifier">+import static io.netty.handler.codec.http2.Http2Error.REFUSED_STREAM;</span>
<span id="L75" class="LineNr"> 75 </span><span class="Identifier">+import static io.netty.handler.codec.http2.Http2Exception.closedStreamError;</span>
<span id="L76" class="LineNr"> 76 </span><span class="Identifier">+import static io.netty.handler.codec.http2.Http2Exception.connectionError;</span>
<span id="L77" class="LineNr"> 77 </span><span class="Identifier">+import static io.netty.handler.codec.http2.Http2Exception.streamError;</span>
<span id="L78" class="LineNr"> 78 </span><span class="Identifier">+import static io.netty.handler.codec.http2.Http2Stream.State.CLOSED;</span>
<span id="L79" class="LineNr"> 79 </span><span class="Identifier">+import static io.netty.handler.codec.http2.Http2Stream.State.HALF_CLOSED_LOCAL;</span>
<span id="L80" class="LineNr"> 80 </span><span class="Identifier">+import static io.netty.handler.codec.http2.Http2Stream.State.HALF_CLOSED_REMOTE;</span>
<span id="L81" class="LineNr"> 81 </span><span class="Identifier">+import static io.netty.handler.codec.http2.Http2Stream.State.IDLE;</span>
<span id="L82" class="LineNr"> 82 </span><span class="Identifier">+import static io.netty.handler.codec.http2.Http2Stream.State.OPEN;</span>
<span id="L83" class="LineNr"> 83 </span><span class="Identifier">+import static io.netty.handler.codec.http2.Http2Stream.State.RESERVED_LOCAL;</span>
<span id="L84" class="LineNr"> 84 </span><span class="Identifier">+import static io.netty.handler.codec.http2.Http2Stream.State.RESERVED_REMOTE;</span>
<span id="L85" class="LineNr"> 85 </span><span class="Identifier">+import static io.netty.util.internal.ObjectUtil.checkNotNull;</span>
<span id="L86" class="LineNr"> 86 </span> import static java.lang.Math.max;
<span id="L87" class="LineNr"> 87 </span>
<span id="L88" class="LineNr"> 88 </span> /**
<span id="L89" class="LineNr"> 89 </span><span class="Statement">@@ -80,6 +87,7 @@</span><span class="PreProc"> public class DefaultHttp2Connection implements Http2Connection {</span>
<span id="L90" class="LineNr"> 90 </span>      */
<span id="L91" class="LineNr"> 91 </span>     final List&lt;Listener&gt; listeners = new ArrayList&lt;Listener&gt;(4);
<span id="L92" class="LineNr"> 92 </span>     final ActiveStreams activeStreams;
<span id="L93" class="LineNr"> 93 </span><span class="Identifier">+    Promise&lt;Void&gt; closePromise;</span>
<span id="L94" class="LineNr"> 94 </span>
<span id="L95" class="LineNr"> 95 </span>     /**
<span id="L96" class="LineNr"> 96 </span>      * Creates a new connection with the given settings.
<span id="L97" class="LineNr"> 97 </span><span class="Statement">@@ -96,6 +104,71 @@</span><span class="PreProc"> public class DefaultHttp2Connection implements Http2Connection {</span>
<span id="L98" class="LineNr"> 98 </span>         streamMap.put(connectionStream.id(), connectionStream);
<span id="L99" class="LineNr"> 99 </span>     }
<span id="L100" class="LineNr">100 </span>
<span id="L101" class="LineNr">101 </span><span class="Identifier">+    /**</span>
<span id="L102" class="LineNr">102 </span><span class="Identifier">+     * Determine if {@link #close(Promise)} has been called and no more streams are allowed to be created.</span>
<span id="L103" class="LineNr">103 </span><span class="Identifier">+     */</span>
<span id="L104" class="LineNr">104 </span><span class="Identifier">+    final boolean isClosed() {</span>
<span id="L105" class="LineNr">105 </span><span class="Identifier">+        return closePromise != null;</span>
<span id="L106" class="LineNr">106 </span><span class="Identifier">+    }</span>
<span id="L107" class="LineNr">107 </span><span class="Identifier">+</span>
<p>
  The member closePromise is introduced to notify all relevant parties that close() is called.
  The caller gives a promise and expects it to be fulfilled whenever the connection is to be
  finally closed.
  [intro.] future vs. promise: they are largely two sides of coin. The producer creates a promise, which the
  consumer takes as a future. Then producer performs computation, fulfills the promise with the final result. Finally,
  the consumer will be able to know that the future is done and result is available.
  [question: why not use ChannelPromise? see the github issue page]
</p>
  <a class="defect">[TODO who will call it? At least the close() function does not care about that]</a>
<span id="L108" class="LineNr">108 </span><span class="Identifier">+    @Override</span>
<span id="L109" class="LineNr">109 </span><span class="Identifier">+    public Future&lt;Void&gt; close(final Promise&lt;Void&gt; promise) {</span>
<span id="L110" class="LineNr">110 </span><span class="Identifier">+        checkNotNull(promise, &quot;promise&quot;);</span>
<span id="L111" class="LineNr">111 </span><span class="Identifier">+        // Since we allow this method to be called multiple times, we must make sure that all the promises are notified</span>
<span id="L112" class="LineNr">112 </span><span class="Identifier">+        // when all streams are removed and the close operation completes.</span>
<span id="L113" class="LineNr">113 </span><span class="Identifier">+        if (closePromise != null) {</span>
<span id="L114" class="LineNr">114 </span><span class="Identifier">+            if (closePromise == promise) {</span>
<span id="L115" class="LineNr">115 </span><span class="Identifier">+                // Do nothing</span>
<span id="L116" class="LineNr">116 </span><span class="Identifier">+            } else if ((promise instanceof ChannelPromise) &amp;&amp; ((ChannelPromise) closePromise).isVoid()) {</span>
<span id="L117" class="LineNr">117 </span><span class="Identifier">+                closePromise = promise;</span>
<span id="L118" class="LineNr">118 </span><span class="Identifier">+            } else {</span>
<span id="L119" class="LineNr">119 </span><span class="Identifier">+                closePromise.addListener(new FutureListener&lt;Void&gt;() {</span>
  <p>If closePromise is void, it will simply be replaced with the incoming promise.
    Otherwise, it will chain (by adding a listener to closePromise) the promise to the closePromise,
    such that they will all be fulfilled automatically when closePromise is fulfilled.</p>
<span id="L120" class="LineNr">120 </span><span class="Identifier">+                    @Override</span>
<span id="L121" class="LineNr">121 </span><span class="Identifier">+                    public void operationComplete(Future&lt;Void&gt; future) throws Exception {</span>
<span id="L122" class="LineNr">122 </span><span class="Identifier">+                        if (future.isSuccess()) {</span>
<span id="L123" class="LineNr">123 </span><span class="Identifier">+                            promise.trySuccess(null);</span>
<span id="L124" class="LineNr">124 </span><span class="Identifier">+                        } else if (future.isCancelled()) {</span>
<span id="L125" class="LineNr">125 </span><span class="Identifier">+                            promise.cancel(false);</span>
<span id="L126" class="LineNr">126 </span><span class="Identifier">+                        } else {</span>
<span id="L127" class="LineNr">127 </span><span class="Identifier">+                            promise.tryFailure(future.cause());</span>
<span id="L128" class="LineNr">128 </span><span class="Identifier">+                        }</span>
<span id="L129" class="LineNr">129 </span><span class="Identifier">+                    }</span>
<span id="L130" class="LineNr">130 </span><span class="Identifier">+                });</span>
<span id="L131" class="LineNr">131 </span><span class="Identifier">+            }</span>
<span id="L132" class="LineNr">132 </span><span class="Identifier">+        } else {</span>
<span id="L133" class="LineNr">133 </span><span class="Identifier">+            closePromise = promise;</span>
<span id="L134" class="LineNr">134 </span><span class="Identifier">+        }</span>
<span id="L135" class="LineNr">135 </span><span class="Identifier">+        if (isStreamMapEmpty()) {</span>
<span id="L136" class="LineNr">136 </span><span class="Identifier">+            promise.trySuccess(null);</span>
<span id="L137" class="LineNr">137 </span><span class="Identifier">+            return promise;</span>
<span id="L138" class="LineNr">138 </span><span class="Identifier">+        }</span>
<span id="L139" class="LineNr">139 </span><span class="Identifier">+        Iterator&lt;PrimitiveEntry&lt;Http2Stream&gt;&gt; itr = streamMap.entries().iterator();</span>
<span id="L140" class="LineNr">140 </span><span class="Identifier">+        // We must take care while iterating the streamMap as to not modify while iterating in case there are other code</span>
<a class="defect">This is wierd. Remove item in iteration does not address concurrent access. What are the other code paths?
The good news is that this method is unlikely to be called concurrently (see the above code).</a>
<span id="L141" class="LineNr">141 </span><span class="Identifier">+        // paths iterating over the active streams.</span>
<span id="L142" class="LineNr">142 </span><span class="Identifier">+        if (activeStreams.allowModifications()) {</span>
<span id="L143" class="LineNr">143 </span><span class="Identifier">+            while (itr.hasNext()) {</span>
<span id="L144" class="LineNr">144 </span><span class="Identifier">+                Http2Stream stream = itr.next().value();</span>
<span id="L145" class="LineNr">145 </span><span class="Identifier">+                if (stream.id() != CONNECTION_STREAM_ID) {</span>
<span id="L146" class="LineNr">146 </span><span class="Identifier">+                    // If modifications of the activeStream map is allowed, then a stream close operation will also</span>
<span id="L147" class="LineNr">147 </span><span class="Identifier">+                    // modify the streamMap. We must prevent concurrent modifications to the streamMap, so use the</span>
<span id="L148" class="LineNr">148 </span><span class="Identifier">+                    // iterator to remove the current stream.</span>
<span id="L149" class="LineNr">149 </span><span class="Identifier">+                    itr.remove();</span>
<span id="L150" class="LineNr">150 </span><span class="Identifier">+                    stream.close();</span>
<span id="L151" class="LineNr">151 </span><span class="Identifier">+                }</span>
<span id="L152" class="LineNr">152 </span><span class="Identifier">+            }</span>
<span id="L153" class="LineNr">153 </span><span class="Identifier">+        } else {</span>
<span id="L154" class="LineNr">154 </span><span class="Identifier">+            while (itr.hasNext()) {</span>
<span id="L155" class="LineNr">155 </span><span class="Identifier">+                Http2Stream stream = itr.next().value();</span>
<span id="L156" class="LineNr">156 </span><span class="Identifier">+                if (stream.id() != CONNECTION_STREAM_ID) {</span>
<span id="L157" class="LineNr">157 </span><span class="Identifier">+                    // We are not allowed to make modifications, so the close calls will be executed after this</span>
<span id="L158" class="LineNr">158 </span><span class="Identifier">+                    // iteration completes.</span>
<span id="L159" class="LineNr">159 </span><span class="Identifier">+                    stream.close();</span>
<span id="L160" class="LineNr">160 </span><span class="Identifier">+                }</span>
<span id="L161" class="LineNr">161 </span><span class="Identifier">+            }</span>
<span id="L162" class="LineNr">162 </span><span class="Identifier">+        }</span>
<span id="L163" class="LineNr">163 </span><span class="Identifier">+        return closePromise;</span>
<span id="L164" class="LineNr">164 </span><span class="Identifier">+    }</span>
<span id="L165" class="LineNr">165 </span><span class="Identifier">+</span>
<span id="L166" class="LineNr">166 </span>     @Override
<span id="L167" class="LineNr">167 </span>     public void addListener(Listener listener) {
<span id="L168" class="LineNr">168 </span>         listeners.add(listener);
<span id="L169" class="LineNr">169 </span><span class="Statement">@@ -209,6 +282,13 @@</span><span class="PreProc"> public class DefaultHttp2Connection implements Http2Connection {</span>
<span id="L170" class="LineNr">170 </span>     }
<span id="L171" class="LineNr">171 </span>
<span id="L172" class="LineNr">172 </span>     /**
<span id="L173" class="LineNr">173 </span><span class="Identifier">+     * Determine if {@link #streamMap} only contains the connection stream.</span>
<span id="L174" class="LineNr">174 </span><span class="Identifier">+     */</span>
<span id="L175" class="LineNr">175 </span><span class="Identifier">+    private boolean isStreamMapEmpty() {</span>
<span id="L176" class="LineNr">176 </span><span class="Identifier">+        return streamMap.size() == 1;</span>
<span id="L177" class="LineNr">177 </span><span class="Identifier">+    }</span>
<span id="L178" class="LineNr">178 </span><span class="Identifier">+</span>
<span id="L179" class="LineNr">179 </span><span class="Identifier">+    /**</span>
<span id="L180" class="LineNr">180 </span>      * Closed streams may stay in the priority tree if they have dependents that are in prioritizable states.
<span id="L181" class="LineNr">181 </span>      * When a stream is requested to be removed we can only actually remove that stream when there are no more
<span id="L182" class="LineNr">182 </span>      * prioritizable children.
<span id="L183" class="LineNr">183 </span><span class="Statement">@@ -220,7 +300,6 @@</span><span class="PreProc"> public class DefaultHttp2Connection implements Http2Connection {</span>
<span id="L184" class="LineNr">184 </span>     void removeStream(DefaultStream stream) {
<span id="L185" class="LineNr">185 </span>         // [1] Check if this stream can be removed because it has no prioritizable descendants.
<span id="L186" class="LineNr">186 </span>         if (stream.parent().removeChild(stream)) {
<span id="L187" class="LineNr">187 </span><span class="Special">-            // Remove it from the map and priority tree.</span>
<span id="L188" class="LineNr">188 </span>             streamMap.remove(stream.id());
<span id="L189" class="LineNr">189 </span>
<span id="L190" class="LineNr">190 </span>             for (int i = 0; i &lt; listeners.size(); i++) {
<span id="L191" class="LineNr">191 </span><span class="Statement">@@ -230,6 +309,10 @@</span><span class="PreProc"> public class DefaultHttp2Connection implements Http2Connection {</span>
<span id="L192" class="LineNr">192 </span>                     logger.error(&quot;Caught RuntimeException from listener onStreamRemoved.&quot;, e);
<span id="L193" class="LineNr">193 </span>                 }
<span id="L194" class="LineNr">194 </span>             }
<span id="L195" class="LineNr">195 </span><span class="Identifier">+</span>
<span id="L196" class="LineNr">196 </span><span class="Identifier">+            if (closePromise != null &amp;&amp; isStreamMapEmpty()) {</span>
<span id="L197" class="LineNr">197 </span><span class="Identifier">+                closePromise.trySuccess(null);</span>
<span id="L198" class="LineNr">198 </span><span class="Identifier">+            }</span>
<span id="L199" class="LineNr">199 </span>         }
<span id="L200" class="LineNr">200 </span>     }
<span id="L201" class="LineNr">201 </span>
<span id="L202" class="LineNr">202 </span><span class="Statement">@@ -604,17 +687,16 @@</span><span class="PreProc"> public class DefaultHttp2Connection implements Http2Connection {</span>
<span id="L203" class="LineNr">203 </span>                 // path is updated with the correct child.prioritizableForTree() value. Note that the removal operation
<span id="L204" class="LineNr">204 </span>                 // may not be successful and may return null. This is because when an exclusive dependency is processed
<span id="L205" class="LineNr">205 </span>                 // the children are removed in a previous recursive call but the child's parent link is updated here.
<span id="L206" class="LineNr">206 </span><span class="Special">-                if (oldParent != null &amp;&amp; oldParent.children.remove(child.id()) != null) {</span>
<span id="L207" class="LineNr">207 </span><span class="Special">-                    if (!child.isDescendantOf(oldParent)) {</span>
<span id="L208" class="LineNr">208 </span><span class="Special">-                        oldParent.decrementPrioritizableForTree(child.prioritizableForTree());</span>
<span id="L209" class="LineNr">209 </span><span class="Special">-                        if (oldParent.prioritizableForTree() == 0) {</span>
<span id="L210" class="LineNr">210 </span><span class="Special">-                            // There are a few risks with immediately removing nodes from the priority tree:</span>
<span id="L211" class="LineNr">211 </span><span class="Special">-                            // 1. We are removing nodes while we are potentially shifting the tree. There are no</span>
<span id="L212" class="LineNr">212 </span><span class="Special">-                            // concrete cases known but is risky because it could invalidate the data structure.</span>
<span id="L213" class="LineNr">213 </span><span class="Special">-                            // 2. We are notifying listeners of the removal while the tree is in flux. Currently the</span>
<span id="L214" class="LineNr">214 </span><span class="Special">-                            // codec listeners make no assumptions about priority tree structure when being notified.</span>
<span id="L215" class="LineNr">215 </span><span class="Special">-                            removeStream(oldParent);</span>
<span id="L216" class="LineNr">216 </span><span class="Special">-                        }</span>
<span id="L217" class="LineNr">217 </span><span class="Identifier">+                if (oldParent != null &amp;&amp; oldParent.children.remove(child.id()) != null &amp;&amp;</span>
<span id="L218" class="LineNr">218 </span><span class="Identifier">+                        !child.isDescendantOf(oldParent)) {</span>
<span id="L219" class="LineNr">219 </span><span class="Identifier">+                    oldParent.decrementPrioritizableForTree(child.prioritizableForTree());</span>
<span id="L220" class="LineNr">220 </span><span class="Identifier">+                    if (oldParent.prioritizableForTree() == 0) {</span>
<span id="L221" class="LineNr">221 </span><span class="Identifier">+                        // There are a few risks with immediately removing nodes from the priority tree:</span>
<span id="L222" class="LineNr">222 </span><span class="Identifier">+                        // 1. We are removing nodes while we are potentially shifting the tree. There are no</span>
<span id="L223" class="LineNr">223 </span><span class="Identifier">+                        // concrete cases known but is risky because it could invalidate the data structure.</span>
<span id="L224" class="LineNr">224 </span><span class="Identifier">+                        // 2. We are notifying listeners of the removal while the tree is in flux. Currently the</span>
<span id="L225" class="LineNr">225 </span><span class="Identifier">+                        // codec listeners make no assumptions about priority tree structure when being notified.</span>
<span id="L226" class="LineNr">226 </span><span class="Identifier">+                        removeStream(oldParent);</span>
  <p>Only format changes here.</p>
<span id="L227" class="LineNr">227 </span>                     }
<span id="L228" class="LineNr">228 </span>                 }
<span id="L229" class="LineNr">229 </span>
<span id="L230" class="LineNr">230 </span><span class="Statement">@@ -1040,6 +1122,10 @@</span><span class="PreProc"> public class DefaultHttp2Connection implements Http2Connection {</span>
<span id="L231" class="LineNr">231 </span>             if ((state.localSideOpen() || state.remoteSideOpen()) &amp;&amp; !canOpenStream()) {
<span id="L232" class="LineNr">232 </span>                 throw connectionError(REFUSED_STREAM, &quot;Maximum active streams violated for this endpoint.&quot;);
<span id="L233" class="LineNr">233 </span>             }
<span id="L234" class="LineNr">234 </span><span class="Identifier">+            if (isClosed()) {</span>
<span id="L235" class="LineNr">235 </span><span class="Identifier">+                throw connectionError(INTERNAL_ERROR, &quot;Attempted to create stream id %d after connection was closed&quot;,</span>
<span id="L236" class="LineNr">236 </span><span class="Identifier">+                                      streamId);</span>
<span id="L237" class="LineNr">237 </span><span class="Identifier">+            }</span>
<span id="L238" class="LineNr">238 </span>         }
<span id="L239" class="LineNr">239 </span>
<span id="L240" class="LineNr">240 </span>         private boolean isLocal() {
<span id="L241" class="LineNr">241 </span><span class="Statement">@@ -1066,7 +1152,6 @@</span><span class="PreProc"> public class DefaultHttp2Connection implements Http2Connection {</span>
<span id="L242" class="LineNr">242 </span>      * active streams in order to prevent modification while iterating.
<span id="L243" class="LineNr">243 </span>      */
<span id="L244" class="LineNr">244 </span>     private final class ActiveStreams {
<span id="L245" class="LineNr">245 </span><span class="Special">-</span>
<span id="L246" class="LineNr">246 </span>         private final List&lt;Listener&gt; listeners;
<span id="L247" class="LineNr">247 </span>         private final Queue&lt;Event&gt; pendingEvents = new ArrayDeque&lt;Event&gt;(4);
<span id="L248" class="LineNr">248 </span>         private final Set&lt;Http2Stream&gt; streams = new LinkedHashSet&lt;Http2Stream&gt;();
<span id="L249" class="LineNr">249 </span><span class="Statement">@@ -1157,7 +1242,7 @@</span><span class="PreProc"> public class DefaultHttp2Connection implements Http2Connection {</span>
<span id="L250" class="LineNr">250 </span>             removeStream(stream);
<span id="L251" class="LineNr">251 </span>         }
<span id="L252" class="LineNr">252 </span>
<span id="L253" class="LineNr">253 </span><span class="Special">-        private boolean allowModifications() {</span>
<span id="L254" class="LineNr">254 </span><span class="Identifier">+        boolean allowModifications() {</span>
<span id="L255" class="LineNr">255 </span>             return pendingIterations == 0;
<span id="L256" class="LineNr">256 </span>         }
<span id="L257" class="LineNr">257 </span>     }
<span id="L258" class="LineNr">258 </span><span class="Type">diff --git a/codec-http2/src/main/java/io/netty/handler/codec/http2/Http2Connection.java b/codec-http2/src/main/java/io/netty/handler/codec/http2/Http2Connection.java</span>
<span id="L259" class="LineNr">259 </span>index 380ab32..419e216 100644
<span id="L260" class="LineNr">260 </span><span class="Type">--- a/codec-http2/src/main/java/io/netty/handler/codec/http2/Http2Connection.java</span>
<span id="L261" class="LineNr">261 </span><span class="Type">+++ b/codec-http2/src/main/java/io/netty/handler/codec/http2/Http2Connection.java</span>
<span id="L262" class="LineNr">262 </span><span class="Statement">@@ -16,6 +16,8 @@</span>
<span id="L263" class="LineNr">263 </span> package io.netty.handler.codec.http2;
<span id="L264" class="LineNr">264 </span>
<span id="L265" class="LineNr">265 </span> import io.netty.buffer.ByteBuf;
<span id="L266" class="LineNr">266 </span><span class="Identifier">+import io.netty.util.concurrent.Future;</span>
<span id="L267" class="LineNr">267 </span><span class="Identifier">+import io.netty.util.concurrent.Promise;</span>
<span id="L268" class="LineNr">268 </span>
<span id="L269" class="LineNr">269 </span> /**
<span id="L270" class="LineNr">270 </span>  * Manager for the state of an HTTP/2 connection with the remote end-point.
<span id="L271" class="LineNr">271 </span><span class="Statement">@@ -293,6 +295,16 @@</span><span class="PreProc"> public interface Http2Connection {</span>
<span id="L272" class="LineNr">272 </span>     }
<span id="L273" class="LineNr">273 </span>
<span id="L274" class="LineNr">274 </span>     /**
<span id="L275" class="LineNr">275 </span><span class="Identifier">+     * Close this connection. No more new streams can be created after this point and</span>
<span id="L276" class="LineNr">276 </span><span class="Identifier">+     * all streams that exists (active or otherwise) will be closed and removed.</span>
<span id="L277" class="LineNr">277 </span><span class="Identifier">+     * &lt;p&gt;Note if iterating active streams via {@link #forEachActiveStream(Http2StreamVisitor)} and an exception is</span>
<span id="L278" class="LineNr">278 </span><span class="Identifier">+     * thrown it is necessary to call this method again to ensure the close completes.</span>
<span id="L279" class="LineNr">279 </span><span class="Identifier">+     * @param promise Will be completed when all streams have been removed, and listeners have been notified.</span>
<span id="L280" class="LineNr">280 </span><span class="Identifier">+     * @return A future that will be completed when all streams have been removed, and listeners have been notified.</span>
<span id="L281" class="LineNr">281 </span><span class="Identifier">+     */</span>
<span id="L282" class="LineNr">282 </span><span class="Identifier">+    Future&lt;Void&gt; close(Promise&lt;Void&gt; promise);</span>
<span id="L283" class="LineNr">283 </span><span class="Identifier">+</span>
<span id="L284" class="LineNr">284 </span><span class="Identifier">+    /**</span>
<span id="L285" class="LineNr">285 </span>      * Creates a new key that is unique within this {@link Http2Connection}.
<span id="L286" class="LineNr">286 </span>      */
<span id="L287" class="LineNr">287 </span>     PropertyKey newKey();
<span id="L288" class="LineNr">288 </span><span class="Type">diff --git a/codec-http2/src/main/java/io/netty/handler/codec/http2/Http2ConnectionHandler.java b/codec-http2/src/main/java/io/netty/handler/codec/http2/Http2ConnectionHandler.java</span>
<span id="L289" class="LineNr">289 </span>index e8f92c1..5c975af 100644
<span id="L290" class="LineNr">290 </span><span class="Type">--- a/codec-http2/src/main/java/io/netty/handler/codec/http2/Http2ConnectionHandler.java</span>
<span id="L291" class="LineNr">291 </span><span class="Type">+++ b/codec-http2/src/main/java/io/netty/handler/codec/http2/Http2ConnectionHandler.java</span>
<span id="L292" class="LineNr">292 </span><span class="Statement">@@ -175,18 +175,9 @@</span><span class="PreProc"> public class Http2ConnectionHandler extends ByteToMessageDecoder implements Http</span>
<span id="L293" class="LineNr">293 </span>             encoder().close();
<span id="L294" class="LineNr">294 </span>             decoder().close();
<span id="L295" class="LineNr">295 </span>
<span id="L296" class="LineNr">296 </span><span class="Special">-            final Http2Connection connection = connection();</span>
<span id="L297" class="LineNr">297 </span><span class="Special">-            // Check if there are streams to avoid the overhead of creating the ChannelFuture.</span>
<span id="L298" class="LineNr">298 </span><span class="Special">-            if (connection.numActiveStreams() &gt; 0) {</span>
<span id="L299" class="LineNr">299 </span><span class="Special">-                final ChannelFuture future = ctx.newSucceededFuture();</span>
<span id="L300" class="LineNr">300 </span><span class="Special">-                connection.forEachActiveStream(new Http2StreamVisitor() {</span>
<span id="L301" class="LineNr">301 </span><span class="Special">-                    @Override</span>
<span id="L302" class="LineNr">302 </span><span class="Special">-                    public boolean visit(Http2Stream stream) throws Http2Exception {</span>
<span id="L303" class="LineNr">303 </span><span class="Special">-                        closeStream(stream, future);</span>
<span id="L304" class="LineNr">304 </span><span class="Special">-                        return true;</span>
<span id="L305" class="LineNr">305 </span><span class="Special">-                    }</span>
<span id="L306" class="LineNr">306 </span><span class="Special">-                });</span>
<span id="L307" class="LineNr">307 </span><span class="Special">-            }</span>
<span id="L308" class="LineNr">308 </span><span class="Identifier">+            // We need to remove all streams (not just the active ones).</span>
<span id="L309" class="LineNr">309 </span><span class="Identifier">+            // See <a href="https://github.com/netty/netty/issues/4838.">https://github.com/netty/netty/issues/4838.</a></span>
<span id="L310" class="LineNr">310 </span><span class="Identifier">+            connection().close(ctx.voidPromise());</span>
  <a class="defect">Question: Why the original code does not remove all streams?</a>
<span id="L311" class="LineNr">311 </span>         }
<span id="L312" class="LineNr">312 </span>
  <a class="defect">TODO: we haven't read the test code changes yet.</a>
<span id="L313" class="LineNr">313 </span>         /**
<span id="L314" class="LineNr">314 </span><span class="Type">diff --git a/codec-http2/src/test/java/io/netty/handler/codec/http2/DefaultHttp2ConnectionTest.java b/codec-http2/src/test/java/io/netty/handler/codec/http2/DefaultHttp2ConnectionTest.java</span>
<span id="L315" class="LineNr">315 </span>index 2e68c39..bb4ace3 100644
<span id="L316" class="LineNr">316 </span><span class="Type">--- a/codec-http2/src/test/java/io/netty/handler/codec/http2/DefaultHttp2ConnectionTest.java</span>
<span id="L317" class="LineNr">317 </span><span class="Type">+++ b/codec-http2/src/test/java/io/netty/handler/codec/http2/DefaultHttp2ConnectionTest.java</span>
<span id="L318" class="LineNr">318 </span><span class="Statement">@@ -15,6 +15,33 @@</span>
<span id="L319" class="LineNr">319 </span>
<span id="L320" class="LineNr">320 </span> package io.netty.handler.codec.http2;
<span id="L321" class="LineNr">321 </span>
<span id="L322" class="LineNr">322 </span><span class="Identifier">+import io.netty.buffer.ByteBuf;</span>
<span id="L323" class="LineNr">323 </span><span class="Identifier">+import io.netty.buffer.Unpooled;</span>
<span id="L324" class="LineNr">324 </span><span class="Identifier">+import io.netty.channel.DefaultEventLoopGroup;</span>
<span id="L325" class="LineNr">325 </span><span class="Identifier">+import io.netty.handler.codec.http2.Http2Connection.Endpoint;</span>
<span id="L326" class="LineNr">326 </span><span class="Identifier">+import io.netty.handler.codec.http2.Http2Stream.State;</span>
<span id="L327" class="LineNr">327 </span><span class="Identifier">+import io.netty.util.concurrent.Future;</span>
<span id="L328" class="LineNr">328 </span><span class="Identifier">+import io.netty.util.concurrent.FutureListener;</span>
<span id="L329" class="LineNr">329 </span><span class="Identifier">+import io.netty.util.concurrent.Promise;</span>
<span id="L330" class="LineNr">330 </span><span class="Identifier">+import io.netty.util.internal.PlatformDependent;</span>
<span id="L331" class="LineNr">331 </span><span class="Identifier">+import org.junit.AfterClass;</span>
<span id="L332" class="LineNr">332 </span><span class="Identifier">+import org.junit.Before;</span>
<span id="L333" class="LineNr">333 </span><span class="Identifier">+import org.junit.BeforeClass;</span>
<span id="L334" class="LineNr">334 </span><span class="Identifier">+import org.junit.Rule;</span>
<span id="L335" class="LineNr">335 </span><span class="Identifier">+import org.junit.Test;</span>
<span id="L336" class="LineNr">336 </span><span class="Identifier">+import org.junit.rules.ExpectedException;</span>
<span id="L337" class="LineNr">337 </span><span class="Identifier">+import org.mockito.ArgumentCaptor;</span>
<span id="L338" class="LineNr">338 </span><span class="Identifier">+import org.mockito.Mock;</span>
<span id="L339" class="LineNr">339 </span><span class="Identifier">+import org.mockito.MockitoAnnotations;</span>
<span id="L340" class="LineNr">340 </span><span class="Identifier">+import org.mockito.invocation.InvocationOnMock;</span>
<span id="L341" class="LineNr">341 </span><span class="Identifier">+import org.mockito.stubbing.Answer;</span>
<span id="L342" class="LineNr">342 </span><span class="Identifier">+</span>
<span id="L343" class="LineNr">343 </span><span class="Identifier">+import java.util.Arrays;</span>
<span id="L344" class="LineNr">344 </span><span class="Identifier">+import java.util.List;</span>
<span id="L345" class="LineNr">345 </span><span class="Identifier">+import java.util.concurrent.CountDownLatch;</span>
<span id="L346" class="LineNr">346 </span><span class="Identifier">+import java.util.concurrent.TimeUnit;</span>
<span id="L347" class="LineNr">347 </span><span class="Identifier">+import java.util.concurrent.atomic.AtomicReference;</span>
<span id="L348" class="LineNr">348 </span><span class="Identifier">+</span>
<span id="L349" class="LineNr">349 </span> import static io.netty.handler.codec.http2.Http2CodecUtil.DEFAULT_PRIORITY_WEIGHT;
<span id="L350" class="LineNr">350 </span> import static io.netty.handler.codec.http2.Http2CodecUtil.MIN_WEIGHT;
<span id="L351" class="LineNr">351 </span> import static org.junit.Assert.assertEquals;
<span id="L352" class="LineNr">352 </span><span class="Statement">@@ -35,25 +62,6 @@</span><span class="PreProc"> import static org.mockito.Mockito.reset;</span>
<span id="L353" class="LineNr">353 </span> import static org.mockito.Mockito.times;
<span id="L354" class="LineNr">354 </span> import static org.mockito.Mockito.verify;
<span id="L355" class="LineNr">355 </span>
<span id="L356" class="LineNr">356 </span><span class="Special">-import io.netty.buffer.ByteBuf;</span>
<span id="L357" class="LineNr">357 </span><span class="Special">-import io.netty.buffer.Unpooled;</span>
<span id="L358" class="LineNr">358 </span><span class="Special">-import io.netty.handler.codec.http2.Http2Connection.Endpoint;</span>
<span id="L359" class="LineNr">359 </span><span class="Special">-import io.netty.handler.codec.http2.Http2Stream.State;</span>
<span id="L360" class="LineNr">360 </span><span class="Special">-import io.netty.util.internal.PlatformDependent;</span>
<span id="L361" class="LineNr">361 </span><span class="Special">-import org.junit.Before;</span>
<span id="L362" class="LineNr">362 </span><span class="Special">-import org.junit.Rule;</span>
<span id="L363" class="LineNr">363 </span><span class="Special">-import org.junit.Test;</span>
<span id="L364" class="LineNr">364 </span><span class="Special">-import org.junit.rules.ExpectedException;</span>
<span id="L365" class="LineNr">365 </span><span class="Special">-import org.mockito.ArgumentCaptor;</span>
<span id="L366" class="LineNr">366 </span><span class="Special">-import org.mockito.Mock;</span>
<span id="L367" class="LineNr">367 </span><span class="Special">-import org.mockito.MockitoAnnotations;</span>
<span id="L368" class="LineNr">368 </span><span class="Special">-import org.mockito.invocation.InvocationOnMock;</span>
<span id="L369" class="LineNr">369 </span><span class="Special">-import org.mockito.stubbing.Answer;</span>
<span id="L370" class="LineNr">370 </span><span class="Special">-</span>
<span id="L371" class="LineNr">371 </span><span class="Special">-import java.util.Arrays;</span>
<span id="L372" class="LineNr">372 </span><span class="Special">-import java.util.List;</span>
<span id="L373" class="LineNr">373 </span><span class="Special">-import java.util.concurrent.atomic.AtomicReference;</span>
<span id="L374" class="LineNr">374 </span><span class="Special">-</span>
<span id="L375" class="LineNr">375 </span> /**
<span id="L376" class="LineNr">376 </span>  * Tests for {@link DefaultHttp2Connection}.
<span id="L377" class="LineNr">377 </span>  */
<span id="L378" class="LineNr">378 </span><span class="Statement">@@ -63,6 +71,7 @@</span><span class="PreProc"> public class DefaultHttp2ConnectionTest {</span>
<span id="L379" class="LineNr">379 </span>
<span id="L380" class="LineNr">380 </span>     private DefaultHttp2Connection server;
<span id="L381" class="LineNr">381 </span>     private DefaultHttp2Connection client;
<span id="L382" class="LineNr">382 </span><span class="Identifier">+    private static DefaultEventLoopGroup group;</span>
<span id="L383" class="LineNr">383 </span>
<span id="L384" class="LineNr">384 </span>     @Mock
<span id="L385" class="LineNr">385 </span>     private Http2Connection.Listener clientListener;
<span id="L386" class="LineNr">386 </span><span class="Statement">@@ -70,6 +79,16 @@</span><span class="PreProc"> public class DefaultHttp2ConnectionTest {</span>
<span id="L387" class="LineNr">387 </span>     @Mock
<span id="L388" class="LineNr">388 </span>     private Http2Connection.Listener clientListener2;
<span id="L389" class="LineNr">389 </span>
<span id="L390" class="LineNr">390 </span><span class="Identifier">+    @BeforeClass</span>
<span id="L391" class="LineNr">391 </span><span class="Identifier">+    public static void beforeClass() {</span>
<span id="L392" class="LineNr">392 </span><span class="Identifier">+        group = new DefaultEventLoopGroup(2);</span>
<span id="L393" class="LineNr">393 </span><span class="Identifier">+    }</span>
<span id="L394" class="LineNr">394 </span><span class="Identifier">+</span>
<span id="L395" class="LineNr">395 </span><span class="Identifier">+    @AfterClass</span>
<span id="L396" class="LineNr">396 </span><span class="Identifier">+    public static void afterClass() {</span>
<span id="L397" class="LineNr">397 </span><span class="Identifier">+        group.shutdownGracefully();</span>
<span id="L398" class="LineNr">398 </span><span class="Identifier">+    }</span>
<span id="L399" class="LineNr">399 </span><span class="Identifier">+</span>
<span id="L400" class="LineNr">400 </span>     @Before
<span id="L401" class="LineNr">401 </span>     public void setup() {
<span id="L402" class="LineNr">402 </span>         MockitoAnnotations.initMocks(this);
<span id="L403" class="LineNr">403 </span><span class="Statement">@@ -85,6 +104,110 @@</span><span class="PreProc"> public class DefaultHttp2ConnectionTest {</span>
<span id="L404" class="LineNr">404 </span>     }
<span id="L405" class="LineNr">405 </span>
<span id="L406" class="LineNr">406 </span>     @Test
<span id="L407" class="LineNr">407 </span><span class="Identifier">+    public void removeAllStreamsWithEmptyStreams() throws InterruptedException {</span>
<span id="L408" class="LineNr">408 </span><span class="Identifier">+        testRemoveAllStreams();</span>
<span id="L409" class="LineNr">409 </span><span class="Identifier">+    }</span>
<span id="L410" class="LineNr">410 </span><span class="Identifier">+</span>
<span id="L411" class="LineNr">411 </span><span class="Identifier">+    @Test</span>
<span id="L412" class="LineNr">412 </span><span class="Identifier">+    public void removeAllStreamsWithJustOneLocalStream() throws InterruptedException, Http2Exception {</span>
<span id="L413" class="LineNr">413 </span><span class="Identifier">+        client.local().createStream(3, false);</span>
<span id="L414" class="LineNr">414 </span><span class="Identifier">+        testRemoveAllStreams();</span>
<span id="L415" class="LineNr">415 </span><span class="Identifier">+    }</span>
<span id="L416" class="LineNr">416 </span><span class="Identifier">+</span>
<span id="L417" class="LineNr">417 </span><span class="Identifier">+    @Test</span>
<span id="L418" class="LineNr">418 </span><span class="Identifier">+    public void removeAllStreamsWithJustOneRemoveStream() throws InterruptedException, Http2Exception {</span>
<span id="L419" class="LineNr">419 </span><span class="Identifier">+        client.remote().createStream(2, false);</span>
<span id="L420" class="LineNr">420 </span><span class="Identifier">+        testRemoveAllStreams();</span>
<span id="L421" class="LineNr">421 </span><span class="Identifier">+    }</span>
<span id="L422" class="LineNr">422 </span><span class="Identifier">+</span>
<span id="L423" class="LineNr">423 </span><span class="Identifier">+    @Test</span>
<span id="L424" class="LineNr">424 </span><span class="Identifier">+    public void removeAllStreamsWithManyActiveStreams() throws InterruptedException, Http2Exception {</span>
<span id="L425" class="LineNr">425 </span><span class="Identifier">+        Endpoint&lt;Http2RemoteFlowController&gt; remote = client.remote();</span>
<span id="L426" class="LineNr">426 </span><span class="Identifier">+        Endpoint&lt;Http2LocalFlowController&gt; local = client.local();</span>
<span id="L427" class="LineNr">427 </span><span class="Identifier">+        for (int c = 3, s = 2; c &lt; 5000; c += 2, s += 2) {</span>
<span id="L428" class="LineNr">428 </span><span class="Identifier">+            local.createStream(c, false);</span>
<span id="L429" class="LineNr">429 </span><span class="Identifier">+            remote.createStream(s, false);</span>
<span id="L430" class="LineNr">430 </span><span class="Identifier">+        }</span>
<span id="L431" class="LineNr">431 </span><span class="Identifier">+        testRemoveAllStreams();</span>
<span id="L432" class="LineNr">432 </span><span class="Identifier">+    }</span>
<span id="L433" class="LineNr">433 </span><span class="Identifier">+</span>
<span id="L434" class="LineNr">434 </span><span class="Identifier">+    @Test</span>
<span id="L435" class="LineNr">435 </span><span class="Identifier">+    public void removeAllStreamsWithNonActiveStreams() throws InterruptedException, Http2Exception {</span>
<span id="L436" class="LineNr">436 </span><span class="Identifier">+        client.local().createIdleStream(3);</span>
<span id="L437" class="LineNr">437 </span><span class="Identifier">+        client.remote().createIdleStream(2);</span>
<span id="L438" class="LineNr">438 </span><span class="Identifier">+        testRemoveAllStreams();</span>
<span id="L439" class="LineNr">439 </span><span class="Identifier">+    }</span>
<span id="L440" class="LineNr">440 </span><span class="Identifier">+</span>
<span id="L441" class="LineNr">441 </span><span class="Identifier">+    @Test</span>
<span id="L442" class="LineNr">442 </span><span class="Identifier">+    public void removeAllStreamsWithNonActiveAndActiveStreams() throws InterruptedException, Http2Exception {</span>
<span id="L443" class="LineNr">443 </span><span class="Identifier">+        client.local().createIdleStream(3);</span>
<span id="L444" class="LineNr">444 </span><span class="Identifier">+        client.remote().createIdleStream(2);</span>
<span id="L445" class="LineNr">445 </span><span class="Identifier">+        client.local().createStream(5, false);</span>
<span id="L446" class="LineNr">446 </span><span class="Identifier">+        client.remote().createStream(4, true);</span>
<span id="L447" class="LineNr">447 </span><span class="Identifier">+        testRemoveAllStreams();</span>
<span id="L448" class="LineNr">448 </span><span class="Identifier">+    }</span>
<span id="L449" class="LineNr">449 </span><span class="Identifier">+</span>
<span id="L450" class="LineNr">450 </span><span class="Identifier">+    @Test</span>
<span id="L451" class="LineNr">451 </span><span class="Identifier">+    public void removeAllStreamsWhileIteratingActiveStreams() throws InterruptedException, Http2Exception {</span>
<span id="L452" class="LineNr">452 </span><span class="Identifier">+        final Endpoint&lt;Http2RemoteFlowController&gt; remote = client.remote();</span>
<span id="L453" class="LineNr">453 </span><span class="Identifier">+        final Endpoint&lt;Http2LocalFlowController&gt; local = client.local();</span>
<span id="L454" class="LineNr">454 </span><span class="Identifier">+        for (int c = 3, s = 2; c &lt; 5000; c += 2, s += 2) {</span>
<span id="L455" class="LineNr">455 </span><span class="Identifier">+            local.createStream(c, false);</span>
<span id="L456" class="LineNr">456 </span><span class="Identifier">+            remote.createStream(s, false);</span>
<span id="L457" class="LineNr">457 </span><span class="Identifier">+        }</span>
<span id="L458" class="LineNr">458 </span><span class="Identifier">+        final Promise&lt;Void&gt; promise = group.next().newPromise();</span>
<span id="L459" class="LineNr">459 </span><span class="Identifier">+        final CountDownLatch latch = new CountDownLatch(client.numActiveStreams());</span>
<span id="L460" class="LineNr">460 </span><span class="Identifier">+        client.forEachActiveStream(new Http2StreamVisitor() {</span>
<span id="L461" class="LineNr">461 </span><span class="Identifier">+            @Override</span>
<span id="L462" class="LineNr">462 </span><span class="Identifier">+            public boolean visit(Http2Stream stream) throws Http2Exception {</span>
<span id="L463" class="LineNr">463 </span><span class="Identifier">+                client.close(promise).addListener(new FutureListener&lt;Void&gt;() {</span>
<span id="L464" class="LineNr">464 </span><span class="Identifier">+                    @Override</span>
<span id="L465" class="LineNr">465 </span><span class="Identifier">+                    public void operationComplete(Future&lt;Void&gt; future) throws Exception {</span>
<span id="L466" class="LineNr">466 </span><span class="Identifier">+                        assertTrue(promise.isDone());</span>
<span id="L467" class="LineNr">467 </span><span class="Identifier">+                        latch.countDown();</span>
<span id="L468" class="LineNr">468 </span><span class="Identifier">+                    }</span>
<span id="L469" class="LineNr">469 </span><span class="Identifier">+                });</span>
<span id="L470" class="LineNr">470 </span><span class="Identifier">+                return true;</span>
<span id="L471" class="LineNr">471 </span><span class="Identifier">+            }</span>
<span id="L472" class="LineNr">472 </span><span class="Identifier">+        });</span>
<span id="L473" class="LineNr">473 </span><span class="Identifier">+        assertTrue(latch.await(2, TimeUnit.SECONDS));</span>
<span id="L474" class="LineNr">474 </span><span class="Identifier">+    }</span>
<span id="L475" class="LineNr">475 </span><span class="Identifier">+</span>
<span id="L476" class="LineNr">476 </span><span class="Identifier">+    @Test</span>
<span id="L477" class="LineNr">477 </span><span class="Identifier">+    public void removeAllStreamsWhileIteratingActiveStreamsAndExceptionOccurs()</span>
<span id="L478" class="LineNr">478 </span><span class="Identifier">+            throws InterruptedException, Http2Exception {</span>
<span id="L479" class="LineNr">479 </span><span class="Identifier">+        final Endpoint&lt;Http2RemoteFlowController&gt; remote = client.remote();</span>
<span id="L480" class="LineNr">480 </span><span class="Identifier">+        final Endpoint&lt;Http2LocalFlowController&gt; local = client.local();</span>
<span id="L481" class="LineNr">481 </span><span class="Identifier">+        for (int c = 3, s = 2; c &lt; 5000; c += 2, s += 2) {</span>
<span id="L482" class="LineNr">482 </span><span class="Identifier">+            local.createStream(c, false);</span>
<span id="L483" class="LineNr">483 </span><span class="Identifier">+            remote.createStream(s, false);</span>
<span id="L484" class="LineNr">484 </span><span class="Identifier">+        }</span>
<span id="L485" class="LineNr">485 </span><span class="Identifier">+        final Promise&lt;Void&gt; promise = group.next().newPromise();</span>
<span id="L486" class="LineNr">486 </span><span class="Identifier">+        final CountDownLatch latch = new CountDownLatch(1);</span>
<span id="L487" class="LineNr">487 </span><span class="Identifier">+        try {</span>
<span id="L488" class="LineNr">488 </span><span class="Identifier">+            client.forEachActiveStream(new Http2StreamVisitor() {</span>
<span id="L489" class="LineNr">489 </span><span class="Identifier">+                @Override</span>
<span id="L490" class="LineNr">490 </span><span class="Identifier">+                public boolean visit(Http2Stream stream) throws Http2Exception {</span>
<span id="L491" class="LineNr">491 </span><span class="Identifier">+                    // This close call is basically a noop, because the following statement will throw an exception.</span>
<span id="L492" class="LineNr">492 </span><span class="Identifier">+                    client.close(promise);</span>
<span id="L493" class="LineNr">493 </span><span class="Identifier">+                    // Do an invalid operation while iterating.</span>
<span id="L494" class="LineNr">494 </span><span class="Identifier">+                    remote.createStream(3, false);</span>
<span id="L495" class="LineNr">495 </span><span class="Identifier">+                    return true;</span>
<span id="L496" class="LineNr">496 </span><span class="Identifier">+                }</span>
<span id="L497" class="LineNr">497 </span><span class="Identifier">+            });</span>
<span id="L498" class="LineNr">498 </span><span class="Identifier">+        } catch (Http2Exception ignored) {</span>
<span id="L499" class="LineNr">499 </span><span class="Identifier">+            client.close(promise).addListener(new FutureListener&lt;Void&gt;() {</span>
<span id="L500" class="LineNr">500 </span><span class="Identifier">+                @Override</span>
<span id="L501" class="LineNr">501 </span><span class="Identifier">+                public void operationComplete(Future&lt;Void&gt; future) throws Exception {</span>
<span id="L502" class="LineNr">502 </span><span class="Identifier">+                    assertTrue(promise.isDone());</span>
<span id="L503" class="LineNr">503 </span><span class="Identifier">+                    latch.countDown();</span>
<span id="L504" class="LineNr">504 </span><span class="Identifier">+                }</span>
<span id="L505" class="LineNr">505 </span><span class="Identifier">+            });</span>
<span id="L506" class="LineNr">506 </span><span class="Identifier">+        }</span>
<span id="L507" class="LineNr">507 </span><span class="Identifier">+        assertTrue(latch.await(2, TimeUnit.SECONDS));</span>
<span id="L508" class="LineNr">508 </span><span class="Identifier">+    }</span>
<span id="L509" class="LineNr">509 </span><span class="Identifier">+</span>
<span id="L510" class="LineNr">510 </span><span class="Identifier">+    @Test</span>
<span id="L511" class="LineNr">511 </span>     public void goAwayReceivedShouldCloseStreamsGreaterThanLastStream() throws Exception {
<span id="L512" class="LineNr">512 </span>         Http2Stream stream1 = client.local().createStream(3, false);
<span id="L513" class="LineNr">513 </span>         Http2Stream stream2 = client.local().createStream(5, false);
<span id="L514" class="LineNr">514 </span><span class="Statement">@@ -1107,6 +1230,19 @@</span><span class="PreProc"> public class DefaultHttp2ConnectionTest {</span>
<span id="L515" class="LineNr">515 </span>         }
<span id="L516" class="LineNr">516 </span>     }
<span id="L517" class="LineNr">517 </span>
<span id="L518" class="LineNr">518 </span><span class="Identifier">+    private void testRemoveAllStreams() throws InterruptedException {</span>
<span id="L519" class="LineNr">519 </span><span class="Identifier">+        final CountDownLatch latch = new CountDownLatch(1);</span>
<span id="L520" class="LineNr">520 </span><span class="Identifier">+        final Promise&lt;Void&gt; promise = group.next().newPromise();</span>
<span id="L521" class="LineNr">521 </span><span class="Identifier">+        client.close(promise).addListener(new FutureListener&lt;Void&gt;() {</span>
<span id="L522" class="LineNr">522 </span><span class="Identifier">+            @Override</span>
<span id="L523" class="LineNr">523 </span><span class="Identifier">+            public void operationComplete(Future&lt;Void&gt; future) throws Exception {</span>
<span id="L524" class="LineNr">524 </span><span class="Identifier">+                assertTrue(promise.isDone());</span>
<span id="L525" class="LineNr">525 </span><span class="Identifier">+                latch.countDown();</span>
<span id="L526" class="LineNr">526 </span><span class="Identifier">+            }</span>
<span id="L527" class="LineNr">527 </span><span class="Identifier">+        });</span>
<span id="L528" class="LineNr">528 </span><span class="Identifier">+        assertTrue(latch.await(2, TimeUnit.SECONDS));</span>
<span id="L529" class="LineNr">529 </span><span class="Identifier">+    }</span>
<span id="L530" class="LineNr">530 </span><span class="Identifier">+</span>
<span id="L531" class="LineNr">531 </span>     private void incrementAndGetStreamShouldRespectOverflow(Endpoint&lt;?&gt; endpoint, int streamId) throws Http2Exception {
<span id="L532" class="LineNr">532 </span>         assertTrue(streamId &gt; 0);
<span id="L533" class="LineNr">533 </span>         try {
<span id="L534" class="LineNr">534 </span><span class="Type">diff --git a/codec-http2/src/test/java/io/netty/handler/codec/http2/Http2ConnectionHandlerTest.java b/codec-http2/src/test/java/io/netty/handler/codec/http2/Http2ConnectionHandlerTest.java</span>
<span id="L535" class="LineNr">535 </span>index c17cc4d..ed9d1c0 100644
<span id="L536" class="LineNr">536 </span><span class="Type">--- a/codec-http2/src/test/java/io/netty/handler/codec/http2/Http2ConnectionHandlerTest.java</span>
<span id="L537" class="LineNr">537 </span><span class="Type">+++ b/codec-http2/src/test/java/io/netty/handler/codec/http2/Http2ConnectionHandlerTest.java</span>
<span id="L538" class="LineNr">538 </span><span class="Statement">@@ -26,6 +26,7 @@</span><span class="PreProc"> import io.netty.channel.ChannelPromise;</span>
<span id="L539" class="LineNr">539 </span> import io.netty.channel.DefaultChannelPromise;
<span id="L540" class="LineNr">540 </span> import io.netty.util.concurrent.EventExecutor;
<span id="L541" class="LineNr">541 </span> import io.netty.util.concurrent.GenericFutureListener;
<span id="L542" class="LineNr">542 </span><span class="Identifier">+import io.netty.util.concurrent.Promise;</span>
<span id="L543" class="LineNr">543 </span> import org.junit.After;
<span id="L544" class="LineNr">544 </span> import org.junit.Before;
<span id="L545" class="LineNr">545 </span> import org.junit.Test;
<span id="L546" class="LineNr">546 </span><span class="Statement">@@ -269,11 +270,12 @@</span><span class="PreProc"> public class Http2ConnectionHandlerTest {</span>
<span id="L547" class="LineNr">547 </span>         verify(decoder, atLeastOnce()).decodeFrame(eq(ctx), any(ByteBuf.class), Matchers.&lt;List&lt;Object&gt;&gt;any());
<span id="L548" class="LineNr">548 </span>     }
<span id="L549" class="LineNr">549 </span>
<span id="L550" class="LineNr">550 </span><span class="Identifier">+    @SuppressWarnings(&quot;unchecked&quot;)</span>
<span id="L551" class="LineNr">551 </span>     @Test
<span id="L552" class="LineNr">552 </span>     public void channelInactiveShouldCloseStreams() throws Exception {
<span id="L553" class="LineNr">553 </span>         handler = newHandler();
<span id="L554" class="LineNr">554 </span>         handler.channelInactive(ctx);
<span id="L555" class="LineNr">555 </span><span class="Special">-        verify(stream).close();</span>
<span id="L556" class="LineNr">556 </span><span class="Identifier">+        verify(connection).close(any(Promise.class));</span>
<span id="L557" class="LineNr">557 </span>     }
<span id="L558" class="LineNr">558 </span>
<span id="L559" class="LineNr">559 </span>     @Test
</pre>
</body>
</html>
<!-- vim: set foldmethod=manual : -->
