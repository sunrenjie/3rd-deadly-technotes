<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>20150601-077508-Replace-SpdyOrHttpChooser-and-Http2OrHttpChooser-with-ApplicationProtocolNegotiationHandler.html</title>
<meta name="Generator" content="Vim/7.4">
<meta name="plugin-version" content="vim7.4_v1">
<meta name="syntax" content="git">
<meta name="settings" content="number_lines,use_css,pre_wrap,no_foldcolumn,expand_tabs,line_ids,prevent_copy=">
<meta name="colorscheme" content="none">
<style type="text/css">
<!--
pre { white-space: pre-wrap; font-family: monospace; color: #000000; background-color: #ffffff; }
body { font-family: monospace; color: #000000; background-color: #ffffff; }
* { font-size: 1em; }
.Special { color: #c000c0; }
.Constant { color: #c00000; }
.LineNr { color: #af5f00; }
.Identifier { color: #008080; }
.Statement { color: #af5f00; }
.PreProc { color: #c000c0; }
.Type { color: #008000; }
.comment {
  font-weight: bold;
  font-size: 16px;
  background: #00FF00;
}
p {
  font-weight: bold;
  background: #00FF00;
}
.defect {
  font-weight: bold;
  background: #FF00FF;
}
-->
</style>

<script type='text/javascript'>
<!--

/* function to open any folds containing a jumped-to line before jumping to it */
function JumpToLine()
{
  var lineNum;
  lineNum = window.location.hash;
  lineNum = lineNum.substr(1); /* strip off '#' */

  if (lineNum.indexOf('L') == -1) {
    lineNum = 'L'+lineNum;
  }
  lineElem = document.getElementById(lineNum);
  /* Always jump to new location even if the line was hidden inside a fold, or
   * we corrected the raw number to a line ID.
   */
  if (lineElem) {
    lineElem.scrollIntoView(true);
  }
  return true;
}
if ('onhashchange' in window) {
  window.onhashchange = JumpToLine;
}

-->
</script>
</head>
<body onload='JumpToLine();'>
<pre id='vimCodeElement'>
  <h3>This commit merges SpdyOrHttpChooser and Http2OrHttpChooser into a more generic protocol negotiation class.
  This reflects the potential of generalizing the protocol upgrading handling logic.
  But it seems that even code here can be merged with clear-text protocol code handling.</h3>
<span id="L1" class="LineNr">   1 </span><span class="Statement">commit</span> <span class="Identifier">077508949638bd90c11d81ec1ce3b0ab257e5eb6</span>
<span id="L2" class="LineNr">   2 </span><span class="Statement">Author:</span> <span class="Constant">Trustin Lee </span><span class="Special">&lt;</span><span class="Special">t@motd.kr</span><span class="Special">&gt;</span>
<span id="L3" class="LineNr">   3 </span><span class="Statement">Date:</span>   <span class="Constant">Mon Jun 1 16:05:00 2015 +0900</span>
<span id="L4" class="LineNr">   4 </span>
<span id="L5" class="LineNr">   5 </span>    Replace SpdyOrHttpChooser and Http2OrHttpChooser with ApplicationProtocolNegotiationHandler
<span id="L6" class="LineNr">   6 </span>
<span id="L7" class="LineNr">   7 </span>    Motivation:
<span id="L8" class="LineNr">   8 </span>
<span id="L9" class="LineNr">   9 </span>    SpdyOrHttpChooser and Http2OrHttpChooser duplicate fair amount code with each other.
<span id="L10" class="LineNr">  10 </span>
<span id="L11" class="LineNr">  11 </span>    Modification:
<span id="L12" class="LineNr">  12 </span>
<span id="L13" class="LineNr">  13 </span>    - Replace SpdyOrHttpChooser and Http2OrHttpChooser with ApplicationProtocolNegotiationHandler
<span id="L14" class="LineNr">  14 </span>    - Add ApplicationProtocolNames to define the known application-level protocol names
<span id="L15" class="LineNr">  15 </span>
<span id="L16" class="LineNr">  16 </span>    Result:
<span id="L17" class="LineNr">  17 </span>
<span id="L18" class="LineNr">  18 </span>    - Less code duplication
<span id="L19" class="LineNr">  19 </span>    - A user can perform dynamic pipeline configuration that follows ALPN/NPN for any protocols.
<span id="L20" class="LineNr">  20 </span>---
<span id="L21" class="LineNr">  21 </span> codec-http/src/main/java/io/netty/handler/codec/spdy/SpdyOrHttpChooser.java            | 177 ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
<span id="L22" class="LineNr">  22 </span> codec-http2/src/main/java/io/netty/handler/codec/http2/Http2CodecUtil.java             |   3 ++-
<span id="L23" class="LineNr">  23 </span> codec-http2/src/main/java/io/netty/handler/codec/http2/Http2OrHttpChooser.java         | 170 --------------------------------------------------------------------------------------------------------------------------------------------------------------------------
<span id="L24" class="LineNr">  24 </span> example/src/main/java/io/netty/example/http2/helloworld/client/Http2Client.java        |   6 +++---
<span id="L25" class="LineNr">  25 </span> example/src/main/java/io/netty/example/http2/helloworld/server/Http2OrHttpHandler.java |  28 +++++++++++++++++++---------
<span id="L26" class="LineNr">  26 </span> example/src/main/java/io/netty/example/http2/helloworld/server/Http2Server.java        |   6 +++---
<span id="L27" class="LineNr">  27 </span> example/src/main/java/io/netty/example/http2/tiles/Http2OrHttpHandler.java             |  37 ++++++++++++++++++++++++++++---------
<span id="L28" class="LineNr">  28 </span> example/src/main/java/io/netty/example/http2/tiles/Http2Server.java                    |  23 ++++++++++++-----------
<span id="L29" class="LineNr">  29 </span> example/src/main/java/io/netty/example/spdy/client/SpdyClient.java                     |   6 +++---
<span id="L30" class="LineNr">  30 </span> example/src/main/java/io/netty/example/spdy/server/SpdyOrHttpHandler.java              |  28 +++++++++++++++++++++++-----
<span id="L31" class="LineNr">  31 </span> example/src/main/java/io/netty/example/spdy/server/SpdyServer.java                     |   6 +++---
<span id="L32" class="LineNr">  32 </span> handler/src/main/java/io/netty/handler/ssl/ApplicationProtocolAccessor.java            |   6 ++++++
<span id="L33" class="LineNr">  33 </span> handler/src/main/java/io/netty/handler/ssl/ApplicationProtocolNames.java               |  59 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    <a class="defect">It is wierd to define the protocols (including http 1!) in ssl sub-dir.
      In addition, h2c is missing (see also class Http2CodecUtil).</a>
<span id="L34" class="LineNr">  34 </span> handler/src/main/java/io/netty/handler/ssl/ApplicationProtocolNegotiationHandler.java  | 125 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
<span id="L35" class="LineNr">  35 </span> handler/src/main/java/io/netty/handler/ssl/ApplicationProtocolUtil.java                |   1 -
<span id="L36" class="LineNr">  36 </span> handler/src/main/java/io/netty/handler/ssl/SslHandshakeCompletionEvent.java            |   8 ++------
<span id="L37" class="LineNr">  37 </span> 16 files changed, 288 insertions(+), 401 deletions(-)
<span id="L38" class="LineNr">  38 </span>
<span id="L39" class="LineNr">  39 </span><span class="Type">diff --git a/codec-http/src/main/java/io/netty/handler/codec/spdy/SpdyOrHttpChooser.java b/codec-http/src/main/java/io/netty/handler/codec/spdy/SpdyOrHttpChooser.java</span>
<span id="L40" class="LineNr">  40 </span>deleted file mode 100644
<span id="L41" class="LineNr">  41 </span>index e176ef1..0000000
<span id="L42" class="LineNr">  42 </span><span class="Type">--- a/codec-http/src/main/java/io/netty/handler/codec/spdy/SpdyOrHttpChooser.java</span>
<span id="L43" class="LineNr">  43 </span><span class="Type">+++ /dev/null</span>
<span id="L44" class="LineNr">  44 </span><span class="Statement">@@ -1,177 +0,0 @@</span>
<span id="L45" class="LineNr">  45 </span><span class="Special">-/*</span>
<span id="L46" class="LineNr">  46 </span><span class="Special">- * Copyright 2014 The Netty Project</span>
<span id="L47" class="LineNr">  47 </span><span class="Special">- *</span>
<span id="L48" class="LineNr">  48 </span><span class="Special">- * The Netty Project licenses this file to you under the Apache License,</span>
<span id="L49" class="LineNr">  49 </span><span class="Special">- * version 2.0 (the &quot;License&quot;); you may not use this file except in compliance</span>
<span id="L50" class="LineNr">  50 </span><span class="Special">- * with the License. You may obtain a copy of the License at:</span>
<span id="L51" class="LineNr">  51 </span><span class="Special">- *</span>
<span id="L52" class="LineNr">  52 </span><span class="Special">- *   <a href="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</a></span>
<span id="L53" class="LineNr">  53 </span><span class="Special">- *</span>
<span id="L54" class="LineNr">  54 </span><span class="Special">- * Unless required by applicable law or agreed to in writing, software</span>
<span id="L55" class="LineNr">  55 </span><span class="Special">- * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT</span>
<span id="L56" class="LineNr">  56 </span><span class="Special">- * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the</span>
<span id="L57" class="LineNr">  57 </span><span class="Special">- * License for the specific language governing permissions and limitations</span>
<span id="L58" class="LineNr">  58 </span><span class="Special">- * under the License.</span>
<span id="L59" class="LineNr">  59 </span><span class="Special">- */</span>
<span id="L60" class="LineNr">  60 </span><span class="Special">-package io.netty.handler.codec.spdy;</span>
<span id="L61" class="LineNr">  61 </span><span class="Special">-</span>
<span id="L62" class="LineNr">  62 </span><span class="Special">-import io.netty.buffer.ByteBuf;</span>
<span id="L63" class="LineNr">  63 </span><span class="Special">-import io.netty.channel.Channel;</span>
<span id="L64" class="LineNr">  64 </span><span class="Special">-import io.netty.channel.ChannelHandlerContext;</span>
<span id="L65" class="LineNr">  65 </span><span class="Special">-import io.netty.channel.ChannelInboundHandler;</span>
<span id="L66" class="LineNr">  66 </span><span class="Special">-import io.netty.channel.ChannelPipeline;</span>
<span id="L67" class="LineNr">  67 </span><span class="Special">-import io.netty.handler.codec.ByteToMessageDecoder;</span>
<span id="L68" class="LineNr">  68 </span><span class="Special">-import io.netty.handler.codec.http.HttpServerCodec;</span>
<span id="L69" class="LineNr">  69 </span><span class="Special">-import io.netty.handler.ssl.SslHandler;</span>
<span id="L70" class="LineNr">  70 </span><span class="Special">-import io.netty.util.internal.logging.InternalLogger;</span>
<span id="L71" class="LineNr">  71 </span><span class="Special">-import io.netty.util.internal.logging.InternalLoggerFactory;</span>
<span id="L72" class="LineNr">  72 </span><span class="Special">-</span>
<span id="L73" class="LineNr">  73 </span><span class="Special">-import java.util.List;</span>
<span id="L74" class="LineNr">  74 </span><span class="Special">-</span>
<span id="L75" class="LineNr">  75 </span><span class="Special">-/**</span>
<span id="L76" class="LineNr">  76 </span><span class="Special">- * {@link ChannelInboundHandler} which is responsible to setup the {@link ChannelPipeline} either for</span>
<span id="L77" class="LineNr">  77 </span><span class="Special">- * HTTP or SPDY. This offers an easy way for users to support both at the same time while not care to</span>
<span id="L78" class="LineNr">  78 </span><span class="Special">- * much about the low-level details.</span>
<span id="L79" class="LineNr">  79 </span><span class="Special">- */</span>
<span id="L80" class="LineNr">  80 </span><span class="Special">-public abstract class SpdyOrHttpChooser extends ByteToMessageDecoder {</span>
<span id="L81" class="LineNr">  81 </span><span class="Special">-</span>
<span id="L82" class="LineNr">  82 </span><span class="Special">-    private static final InternalLogger logger = InternalLoggerFactory.getInstance(SpdyOrHttpChooser.class);</span>
<span id="L83" class="LineNr">  83 </span><span class="Special">-</span>
<span id="L84" class="LineNr">  84 </span><span class="Special">-    // TODO: Replace with generic NPN handler</span>
<span id="L85" class="LineNr">  85 </span><span class="Special">-</span>
<span id="L86" class="LineNr">  86 </span><span class="Special">-    public enum SelectedProtocol {</span>
<span id="L87" class="LineNr">  87 </span><span class="Special">-        SPDY_3_1(&quot;spdy/3.1&quot;),</span>
<span id="L88" class="LineNr">  88 </span><span class="Special">-        HTTP_1_1(&quot;http/1.1&quot;),</span>
<span id="L89" class="LineNr">  89 </span><span class="Special">-        HTTP_1_0(&quot;http/1.0&quot;);</span>
<span id="L90" class="LineNr">  90 </span><span class="Special">-</span>
<span id="L91" class="LineNr">  91 </span><span class="Special">-        private final String name;</span>
<span id="L92" class="LineNr">  92 </span><span class="Special">-</span>
<span id="L93" class="LineNr">  93 </span><span class="Special">-        SelectedProtocol(String defaultName) {</span>
<span id="L94" class="LineNr">  94 </span><span class="Special">-            name = defaultName;</span>
<span id="L95" class="LineNr">  95 </span><span class="Special">-        }</span>
<span id="L96" class="LineNr">  96 </span><span class="Special">-</span>
<span id="L97" class="LineNr">  97 </span><span class="Special">-        public String protocolName() {</span>
<span id="L98" class="LineNr">  98 </span><span class="Special">-            return name;</span>
<span id="L99" class="LineNr">  99 </span><span class="Special">-        }</span>
<span id="L100" class="LineNr"> 100 </span><span class="Special">-</span>
<span id="L101" class="LineNr"> 101 </span><span class="Special">-        /**</span>
<span id="L102" class="LineNr"> 102 </span><span class="Special">-         * Get an instance of this enum based on the protocol name returned by the NPN server provider</span>
<span id="L103" class="LineNr"> 103 </span><span class="Special">-         *</span>
<span id="L104" class="LineNr"> 104 </span><span class="Special">-         * @param name the protocol name</span>
<span id="L105" class="LineNr"> 105 </span><span class="Special">-         * @return the selected protocol or {@code null} if there is no match</span>
<span id="L106" class="LineNr"> 106 </span><span class="Special">-         */</span>
<span id="L107" class="LineNr"> 107 </span><span class="Special">-        public static SelectedProtocol protocol(String name) {</span>
<span id="L108" class="LineNr"> 108 </span><span class="Special">-            for (SelectedProtocol protocol : SelectedProtocol.values()) {</span>
<span id="L109" class="LineNr"> 109 </span><span class="Special">-                if (protocol.protocolName().equals(name)) {</span>
<span id="L110" class="LineNr"> 110 </span><span class="Special">-                    return protocol;</span>
<span id="L111" class="LineNr"> 111 </span><span class="Special">-                }</span>
<span id="L112" class="LineNr"> 112 </span><span class="Special">-            }</span>
<span id="L113" class="LineNr"> 113 </span><span class="Special">-            return null;</span>
<span id="L114" class="LineNr"> 114 </span><span class="Special">-        }</span>
<span id="L115" class="LineNr"> 115 </span><span class="Special">-    }</span>
<span id="L116" class="LineNr"> 116 </span><span class="Special">-</span>
<span id="L117" class="LineNr"> 117 </span><span class="Special">-    protected SpdyOrHttpChooser() { }</span>
<span id="L118" class="LineNr"> 118 </span><span class="Special">-</span>
<span id="L119" class="LineNr"> 119 </span><span class="Special">-    @Override</span>
<span id="L120" class="LineNr"> 120 </span><span class="Special">-    protected void decode(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out) throws Exception {</span>
<span id="L121" class="LineNr"> 121 </span><span class="Special">-        if (configurePipeline(ctx)) {</span>
<span id="L122" class="LineNr"> 122 </span><span class="Special">-            // When we reached here we can remove this handler as its now clear</span>
<span id="L123" class="LineNr"> 123 </span><span class="Special">-            // what protocol we want to use</span>
<span id="L124" class="LineNr"> 124 </span><span class="Special">-            // from this point on. This will also take care of forward all</span>
<span id="L125" class="LineNr"> 125 </span><span class="Special">-            // messages.</span>
<span id="L126" class="LineNr"> 126 </span><span class="Special">-            ctx.pipeline().remove(this);</span>
<span id="L127" class="LineNr"> 127 </span><span class="Special">-        }</span>
<span id="L128" class="LineNr"> 128 </span><span class="Special">-    }</span>
<span id="L129" class="LineNr"> 129 </span><span class="Special">-</span>
<span id="L130" class="LineNr"> 130 </span><span class="Special">-    private boolean configurePipeline(ChannelHandlerContext ctx) {</span>
<span id="L131" class="LineNr"> 131 </span><span class="Special">-        // Get the SslHandler from the ChannelPipeline so we can obtain the</span>
<span id="L132" class="LineNr"> 132 </span><span class="Special">-        // SslEngine from it.</span>
<span id="L133" class="LineNr"> 133 </span><span class="Special">-        SslHandler handler = ctx.pipeline().get(SslHandler.class);</span>
<span id="L134" class="LineNr"> 134 </span><span class="Special">-        if (handler == null) {</span>
<span id="L135" class="LineNr"> 135 </span><span class="Special">-            // SslHandler is needed by SPDY by design.</span>
<span id="L136" class="LineNr"> 136 </span><span class="Special">-            throw new IllegalStateException(&quot;cannot find a SslHandler in the pipeline (required for SPDY)&quot;);</span>
<span id="L137" class="LineNr"> 137 </span><span class="Special">-        }</span>
<span id="L138" class="LineNr"> 138 </span><span class="Special">-</span>
<span id="L139" class="LineNr"> 139 </span><span class="Special">-        if (!handler.handshakeFuture().isDone()) {</span>
<span id="L140" class="LineNr"> 140 </span><span class="Special">-            return false;</span>
<span id="L141" class="LineNr"> 141 </span><span class="Special">-        }</span>
<span id="L142" class="LineNr"> 142 </span><span class="Special">-</span>
<span id="L143" class="LineNr"> 143 </span><span class="Special">-        SelectedProtocol protocol;</span>
<span id="L144" class="LineNr"> 144 </span><span class="Special">-        try {</span>
<span id="L145" class="LineNr"> 145 </span><span class="Special">-            protocol = selectProtocol(handler);</span>
<span id="L146" class="LineNr"> 146 </span><span class="Special">-        } catch (Exception e) {</span>
<span id="L147" class="LineNr"> 147 </span><span class="Special">-            throw new IllegalStateException(&quot;failed to get the selected protocol&quot;, e);</span>
<span id="L148" class="LineNr"> 148 </span><span class="Special">-        }</span>
<span id="L149" class="LineNr"> 149 </span><span class="Special">-</span>
<span id="L150" class="LineNr"> 150 </span><span class="Special">-        if (protocol == null) {</span>
<span id="L151" class="LineNr"> 151 </span><span class="Special">-            throw new IllegalStateException(&quot;unknown protocol&quot;);</span>
<span id="L152" class="LineNr"> 152 </span><span class="Special">-        }</span>
<span id="L153" class="LineNr"> 153 </span><span class="Special">-</span>
<span id="L154" class="LineNr"> 154 </span><span class="Special">-        switch (protocol) {</span>
<span id="L155" class="LineNr"> 155 </span><span class="Special">-        case SPDY_3_1:</span>
<span id="L156" class="LineNr"> 156 </span><span class="Special">-            try {</span>
<span id="L157" class="LineNr"> 157 </span><span class="Special">-                configureSpdy(ctx, SpdyVersion.SPDY_3_1);</span>
<span id="L158" class="LineNr"> 158 </span><span class="Special">-            } catch (Exception e) {</span>
<span id="L159" class="LineNr"> 159 </span><span class="Special">-                throw new IllegalStateException(&quot;failed to configure a SPDY pipeline&quot;, e);</span>
<span id="L160" class="LineNr"> 160 </span><span class="Special">-            }</span>
<span id="L161" class="LineNr"> 161 </span><span class="Special">-            break;</span>
<span id="L162" class="LineNr"> 162 </span><span class="Special">-        case HTTP_1_0:</span>
<span id="L163" class="LineNr"> 163 </span><span class="Special">-        case HTTP_1_1:</span>
<span id="L164" class="LineNr"> 164 </span><span class="Special">-            try {</span>
<span id="L165" class="LineNr"> 165 </span><span class="Special">-                configureHttp1(ctx);</span>
<span id="L166" class="LineNr"> 166 </span><span class="Special">-            } catch (Exception e) {</span>
<span id="L167" class="LineNr"> 167 </span><span class="Special">-                throw new IllegalStateException(&quot;failed to configure a HTTP/1 pipeline&quot;, e);</span>
<span id="L168" class="LineNr"> 168 </span><span class="Special">-            }</span>
<span id="L169" class="LineNr"> 169 </span><span class="Special">-            break;</span>
<span id="L170" class="LineNr"> 170 </span><span class="Special">-        }</span>
<span id="L171" class="LineNr"> 171 </span><span class="Special">-        return true;</span>
<span id="L172" class="LineNr"> 172 </span><span class="Special">-    }</span>
<span id="L173" class="LineNr"> 173 </span><span class="Special">-</span>
<span id="L174" class="LineNr"> 174 </span><span class="Special">-    /**</span>
<span id="L175" class="LineNr"> 175 </span><span class="Special">-     * Returns the {@link SelectedProtocol} for the current SSL session.  By default, this method returns the first</span>
<span id="L176" class="LineNr"> 176 </span><span class="Special">-     * known protocol.</span>
<span id="L177" class="LineNr"> 177 </span><span class="Special">-     *</span>
<span id="L178" class="LineNr"> 178 </span><span class="Special">-     * @return the selected application-level protocol, or {@code null} if the application-level protocol name of</span>
<span id="L179" class="LineNr"> 179 </span><span class="Special">-     *         the specified {@code sslHandler} is neither {@code &quot;http/1.1&quot;}, {@code &quot;http/1.0&quot;} nor {@code &quot;spdy/3.1&quot;}</span>
<span id="L180" class="LineNr"> 180 </span><span class="Special">-     */</span>
<span id="L181" class="LineNr"> 181 </span><span class="Special">-    protected SelectedProtocol selectProtocol(SslHandler sslHandler) throws Exception {</span>
<span id="L182" class="LineNr"> 182 </span><span class="Special">-        final String appProto = sslHandler.applicationProtocol();</span>
<span id="L183" class="LineNr"> 183 </span><span class="Special">-        return appProto != null? SelectedProtocol.protocol(appProto) : SelectedProtocol.HTTP_1_1;</span>
<span id="L184" class="LineNr"> 184 </span><span class="Special">-    }</span>
<span id="L185" class="LineNr"> 185 </span><span class="Special">-</span>
<span id="L186" class="LineNr"> 186 </span><span class="Special">-    /**</span>
<span id="L187" class="LineNr"> 187 </span><span class="Special">-     * Configures the {@link Channel} of the specified {@code ctx} for HTTP/2.</span>
<span id="L188" class="LineNr"> 188 </span><span class="Special">-     * &lt;p&gt;</span>
<span id="L189" class="LineNr"> 189 </span><span class="Special">-     * A typical implementation of this method will look like the following:</span>
<span id="L190" class="LineNr"> 190 </span><span class="Special">-     * &lt;pre&gt;</span>
<span id="L191" class="LineNr"> 191 </span><span class="Special">-     * {@link ChannelPipeline} p = ctx.pipeline();</span>
<span id="L192" class="LineNr"> 192 </span><span class="Special">-     * p.addLast(new {@link SpdyFrameCodec}(version));</span>
<span id="L193" class="LineNr"> 193 </span><span class="Special">-     * p.addLast(new {@link SpdySessionHandler}(version, true));</span>
<span id="L194" class="LineNr"> 194 </span><span class="Special">-     * p.addLast(new {@link SpdyHttpEncoder}(version));</span>
<span id="L195" class="LineNr"> 195 </span><span class="Special">-     * p.addLast(new {@link SpdyHttpDecoder}(version, &lt;i&gt;maxSpdyContentLength&lt;/i&gt;));</span>
<span id="L196" class="LineNr"> 196 </span><span class="Special">-     * p.addLast(new {@link SpdyHttpResponseStreamIdHandler}());</span>
<span id="L197" class="LineNr"> 197 </span><span class="Special">-     * p.addLast(new &lt;i&gt;YourHttpRequestHandler&lt;/i&gt;());</span>
<span id="L198" class="LineNr"> 198 </span><span class="Special">-     * &lt;/pre&gt;</span>
<span id="L199" class="LineNr"> 199 </span><span class="Special">-     * &lt;/p&gt;</span>
<span id="L200" class="LineNr"> 200 </span><span class="Special">-     */</span>
<span id="L201" class="LineNr"> 201 </span><span class="Special">-    protected abstract void configureSpdy(ChannelHandlerContext ctx, SpdyVersion version) throws Exception;</span>
<span id="L202" class="LineNr"> 202 </span><span class="Special">-</span>
<span id="L203" class="LineNr"> 203 </span><span class="Special">-    /**</span>
<span id="L204" class="LineNr"> 204 </span><span class="Special">-     * Configures the {@link Channel} of the specified {@code ctx} for HTTP/1.</span>
<span id="L205" class="LineNr"> 205 </span><span class="Special">-     * &lt;p&gt;</span>
<span id="L206" class="LineNr"> 206 </span><span class="Special">-     * A typical implementation of this method will look like the following:</span>
<span id="L207" class="LineNr"> 207 </span><span class="Special">-     * &lt;pre&gt;</span>
<span id="L208" class="LineNr"> 208 </span><span class="Special">-     * {@link ChannelPipeline} p = ctx.pipeline();</span>
<span id="L209" class="LineNr"> 209 </span><span class="Special">-     * p.addLast(new {@link HttpServerCodec}());</span>
<span id="L210" class="LineNr"> 210 </span><span class="Special">-     * p.addLast(new &lt;i&gt;YourHttpRequestHandler&lt;/i&gt;());</span>
<span id="L211" class="LineNr"> 211 </span><span class="Special">-     * &lt;/pre&gt;</span>
<span id="L212" class="LineNr"> 212 </span><span class="Special">-     * &lt;/p&gt;</span>
<span id="L213" class="LineNr"> 213 </span><span class="Special">-     */</span>
<span id="L214" class="LineNr"> 214 </span><span class="Special">-    protected abstract void configureHttp1(ChannelHandlerContext ctx) throws Exception;</span>
<span id="L215" class="LineNr"> 215 </span><span class="Special">-</span>
<span id="L216" class="LineNr"> 216 </span><span class="Special">-    @Override</span>
<span id="L217" class="LineNr"> 217 </span><span class="Special">-    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception {</span>
<span id="L218" class="LineNr"> 218 </span><span class="Special">-        logger.warn(&quot;{} Failed to select the application-level protocol:&quot;, ctx.channel(), cause);</span>
<span id="L219" class="LineNr"> 219 </span><span class="Special">-        ctx.close();</span>
<span id="L220" class="LineNr"> 220 </span><span class="Special">-    }</span>
<span id="L221" class="LineNr"> 221 </span><span class="Special">-}</span>
<span id="L222" class="LineNr"> 222 </span><span class="Type">diff --git a/codec-http2/src/main/java/io/netty/handler/codec/http2/Http2CodecUtil.java b/codec-http2/src/main/java/io/netty/handler/codec/http2/Http2CodecUtil.java</span>
<span id="L223" class="LineNr"> 223 </span>index 03daf07..27c6984 100644
<span id="L224" class="LineNr"> 224 </span><span class="Type">--- a/codec-http2/src/main/java/io/netty/handler/codec/http2/Http2CodecUtil.java</span>
<span id="L225" class="LineNr"> 225 </span><span class="Type">+++ b/codec-http2/src/main/java/io/netty/handler/codec/http2/Http2CodecUtil.java</span>
<span id="L226" class="LineNr"> 226 </span><span class="Statement">@@ -24,6 +24,7 @@</span><span class="PreProc"> import io.netty.channel.Channel;</span>
<span id="L227" class="LineNr"> 227 </span> import io.netty.channel.ChannelHandlerContext;
<span id="L228" class="LineNr"> 228 </span> import io.netty.channel.ChannelPromise;
<span id="L229" class="LineNr"> 229 </span> import io.netty.channel.DefaultChannelPromise;
<span id="L230" class="LineNr"> 230 </span><span class="Identifier">+import io.netty.handler.ssl.ApplicationProtocolNames;</span>
<span id="L231" class="LineNr"> 231 </span> import io.netty.util.concurrent.EventExecutor;
<span id="L232" class="LineNr"> 232 </span>
<span id="L233" class="LineNr"> 233 </span> /**
<span id="L234" class="LineNr"> 234 </span><span class="Statement">@@ -38,7 +39,7 @@</span><span class="PreProc"> public final class Http2CodecUtil {</span>
<span id="L235" class="LineNr"> 235 </span>     public static final int HTTP_UPGRADE_STREAM_ID = 1;
<span id="L236" class="LineNr"> 236 </span>     public static final String HTTP_UPGRADE_SETTINGS_HEADER = &quot;HTTP2-Settings&quot;;
<span id="L237" class="LineNr"> 237 </span>     public static final String HTTP_UPGRADE_PROTOCOL_NAME = &quot;h2c&quot;;
<span id="L238" class="LineNr"> 238 </span><span class="Special">-    public static final String TLS_UPGRADE_PROTOCOL_NAME = &quot;h2&quot;;</span>
<span id="L239" class="LineNr"> 239 </span><span class="Identifier">+    public static final String TLS_UPGRADE_PROTOCOL_NAME = ApplicationProtocolNames.HTTP_2;</span>
<span id="L240" class="LineNr"> 240 </span>
<span id="L241" class="LineNr"> 241 </span>     public static final int PING_FRAME_PAYLOAD_LENGTH = 8;
<span id="L242" class="LineNr"> 242 </span>     public static final short MAX_UNSIGNED_BYTE = 0xFF;
<span id="L243" class="LineNr"> 243 </span><span class="Type">diff --git a/codec-http2/src/main/java/io/netty/handler/codec/http2/Http2OrHttpChooser.java b/codec-http2/src/main/java/io/netty/handler/codec/http2/Http2OrHttpChooser.java</span>
<span id="L244" class="LineNr"> 244 </span>deleted file mode 100644
<span id="L245" class="LineNr"> 245 </span>index 24a64fb..0000000
<span id="L246" class="LineNr"> 246 </span><span class="Type">--- a/codec-http2/src/main/java/io/netty/handler/codec/http2/Http2OrHttpChooser.java</span>
<span id="L247" class="LineNr"> 247 </span><span class="Type">+++ /dev/null</span>
<span id="L248" class="LineNr"> 248 </span><span class="Statement">@@ -1,170 +0,0 @@</span>
<span id="L249" class="LineNr"> 249 </span><span class="Special">-/*</span>
<span id="L250" class="LineNr"> 250 </span><span class="Special">- * Copyright 2014 The Netty Project</span>
<span id="L251" class="LineNr"> 251 </span><span class="Special">- *</span>
<span id="L252" class="LineNr"> 252 </span><span class="Special">- * The Netty Project licenses this file to you under the Apache License,</span>
<span id="L253" class="LineNr"> 253 </span><span class="Special">- * version 2.0 (the &quot;License&quot;); you may not use this file except in compliance</span>
<span id="L254" class="LineNr"> 254 </span><span class="Special">- * with the License. You may obtain a copy of the License at:</span>
<span id="L255" class="LineNr"> 255 </span><span class="Special">- *</span>
<span id="L256" class="LineNr"> 256 </span><span class="Special">- *   <a href="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</a></span>
<span id="L257" class="LineNr"> 257 </span><span class="Special">- *</span>
<span id="L258" class="LineNr"> 258 </span><span class="Special">- * Unless required by applicable law or agreed to in writing, software</span>
<span id="L259" class="LineNr"> 259 </span><span class="Special">- * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT</span>
<span id="L260" class="LineNr"> 260 </span><span class="Special">- * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the</span>
<span id="L261" class="LineNr"> 261 </span><span class="Special">- * License for the specific language governing permissions and limitations</span>
<span id="L262" class="LineNr"> 262 </span><span class="Special">- * under the License.</span>
<span id="L263" class="LineNr"> 263 </span><span class="Special">- */</span>
<span id="L264" class="LineNr"> 264 </span><span class="Special">-package io.netty.handler.codec.http2;</span>
<span id="L265" class="LineNr"> 265 </span><span class="Special">-</span>
<span id="L266" class="LineNr"> 266 </span><span class="Special">-import io.netty.buffer.ByteBuf;</span>
<span id="L267" class="LineNr"> 267 </span><span class="Special">-import io.netty.channel.Channel;</span>
<span id="L268" class="LineNr"> 268 </span><span class="Special">-import io.netty.channel.ChannelHandler;</span>
<span id="L269" class="LineNr"> 269 </span><span class="Special">-import io.netty.channel.ChannelHandlerContext;</span>
<span id="L270" class="LineNr"> 270 </span><span class="Special">-import io.netty.channel.ChannelPipeline;</span>
<span id="L271" class="LineNr"> 271 </span><span class="Special">-import io.netty.handler.codec.ByteToMessageDecoder;</span>
<span id="L272" class="LineNr"> 272 </span><span class="Special">-import io.netty.handler.codec.http.HttpServerCodec;</span>
<span id="L273" class="LineNr"> 273 </span><span class="Special">-import io.netty.handler.ssl.SslHandler;</span>
<span id="L274" class="LineNr"> 274 </span><span class="Special">-import io.netty.util.internal.logging.InternalLogger;</span>
<span id="L275" class="LineNr"> 275 </span><span class="Special">-import io.netty.util.internal.logging.InternalLoggerFactory;</span>
<span id="L276" class="LineNr"> 276 </span><span class="Special">-</span>
<span id="L277" class="LineNr"> 277 </span><span class="Special">-import java.util.List;</span>
<span id="L278" class="LineNr"> 278 </span><span class="Special">-</span>
<span id="L279" class="LineNr"> 279 </span><span class="Special">-import static io.netty.handler.codec.http2.Http2CodecUtil.*;</span>
<span id="L280" class="LineNr"> 280 </span><span class="Special">-</span>
<span id="L281" class="LineNr"> 281 </span><span class="Special">-/**</span>
<span id="L282" class="LineNr"> 282 </span><span class="Special">- * {@link ChannelHandler} which is responsible to setup the</span>
<span id="L283" class="LineNr"> 283 </span><span class="Special">- * {@link ChannelPipeline} either for HTTP or HTTP2. This offers an easy way for</span>
<span id="L284" class="LineNr"> 284 </span><span class="Special">- * users to support both at the same time while not care to much about the low-level details.</span>
<span id="L285" class="LineNr"> 285 </span><span class="Special">- */</span>
<span id="L286" class="LineNr"> 286 </span><span class="Special">-public abstract class Http2OrHttpChooser extends ByteToMessageDecoder {</span>
<span id="L287" class="LineNr"> 287 </span><span class="Special">-</span>
<span id="L288" class="LineNr"> 288 </span><span class="Special">-    private static final InternalLogger logger = InternalLoggerFactory.getInstance(Http2OrHttpChooser.class);</span>
<span id="L289" class="LineNr"> 289 </span><span class="Special">-</span>
<span id="L290" class="LineNr"> 290 </span><span class="Special">-    public enum SelectedProtocol {</span>
<span id="L291" class="LineNr"> 291 </span><span class="Special">-        /** Must be updated to match the HTTP/2 draft number. */</span>
<span id="L292" class="LineNr"> 292 </span><span class="Special">-        HTTP_2(TLS_UPGRADE_PROTOCOL_NAME),</span>
<span id="L293" class="LineNr"> 293 </span><span class="Special">-        HTTP_1_1(&quot;http/1.1&quot;),</span>
<span id="L294" class="LineNr"> 294 </span><span class="Special">-        HTTP_1_0(&quot;http/1.0&quot;);</span>
<span id="L295" class="LineNr"> 295 </span><span class="Special">-</span>
<span id="L296" class="LineNr"> 296 </span><span class="Special">-        private final String name;</span>
<span id="L297" class="LineNr"> 297 </span><span class="Special">-</span>
<span id="L298" class="LineNr"> 298 </span><span class="Special">-        SelectedProtocol(String defaultName) {</span>
<span id="L299" class="LineNr"> 299 </span><span class="Special">-            name = defaultName;</span>
<span id="L300" class="LineNr"> 300 </span><span class="Special">-        }</span>
<span id="L301" class="LineNr"> 301 </span><span class="Special">-</span>
<span id="L302" class="LineNr"> 302 </span><span class="Special">-        public String protocolName() {</span>
<span id="L303" class="LineNr"> 303 </span><span class="Special">-            return name;</span>
<span id="L304" class="LineNr"> 304 </span><span class="Special">-        }</span>
<span id="L305" class="LineNr"> 305 </span><span class="Special">-</span>
<span id="L306" class="LineNr"> 306 </span><span class="Special">-        /**</span>
<span id="L307" class="LineNr"> 307 </span><span class="Special">-         * Get an instance of this enum based on the protocol name returned by the ALPN server provider</span>
<span id="L308" class="LineNr"> 308 </span><span class="Special">-         *</span>
<span id="L309" class="LineNr"> 309 </span><span class="Special">-         * @param name the protocol name</span>
<span id="L310" class="LineNr"> 310 </span><span class="Special">-         * @return the selected protocol or {@code null} if there is no match</span>
<span id="L311" class="LineNr"> 311 </span><span class="Special">-         */</span>
<span id="L312" class="LineNr"> 312 </span><span class="Special">-        public static SelectedProtocol protocol(String name) {</span>
<span id="L313" class="LineNr"> 313 </span><span class="Special">-            for (SelectedProtocol protocol : SelectedProtocol.values()) {</span>
<span id="L314" class="LineNr"> 314 </span><span class="Special">-                if (protocol.protocolName().equals(name)) {</span>
<span id="L315" class="LineNr"> 315 </span><span class="Special">-                    return protocol;</span>
<span id="L316" class="LineNr"> 316 </span><span class="Special">-                }</span>
<span id="L317" class="LineNr"> 317 </span><span class="Special">-            }</span>
<span id="L318" class="LineNr"> 318 </span><span class="Special">-            return null;</span>
<span id="L319" class="LineNr"> 319 </span><span class="Special">-        }</span>
<span id="L320" class="LineNr"> 320 </span><span class="Special">-    }</span>
<span id="L321" class="LineNr"> 321 </span><span class="Special">-</span>
<span id="L322" class="LineNr"> 322 </span><span class="Special">-    protected Http2OrHttpChooser() { }</span>
<span id="L323" class="LineNr"> 323 </span><span class="Special">-</span>
<span id="L324" class="LineNr"> 324 </span><span class="Special">-    @Override</span>
<span id="L325" class="LineNr"> 325 </span><span class="Special">-    protected void decode(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out) throws Exception {</span>
<span id="L326" class="LineNr"> 326 </span><span class="Special">-        if (configurePipeline(ctx)) {</span>
<span id="L327" class="LineNr"> 327 </span><span class="Special">-            // When we reached here we can remove this handler as its now clear</span>
<span id="L328" class="LineNr"> 328 </span><span class="Special">-            // what protocol we want to use</span>
<span id="L329" class="LineNr"> 329 </span><span class="Special">-            // from this point on. This will also take care of forward all</span>
<span id="L330" class="LineNr"> 330 </span><span class="Special">-            // messages.</span>
<span id="L331" class="LineNr"> 331 </span><span class="Special">-            ctx.pipeline().remove(this);</span>
<span id="L332" class="LineNr"> 332 </span><span class="Special">-        }</span>
<span id="L333" class="LineNr"> 333 </span><span class="Special">-    }</span>
<span id="L334" class="LineNr"> 334 </span><span class="Special">-</span>
<span id="L335" class="LineNr"> 335 </span><span class="Special">-    private boolean configurePipeline(ChannelHandlerContext ctx) {</span>
<span id="L336" class="LineNr"> 336 </span><span class="Special">-        // Get the SslHandler from the ChannelPipeline so we can obtain the</span>
<span id="L337" class="LineNr"> 337 </span><span class="Special">-        // SslEngine from it.</span>
<span id="L338" class="LineNr"> 338 </span><span class="Special">-        SslHandler handler = ctx.pipeline().get(SslHandler.class);</span>
<span id="L339" class="LineNr"> 339 </span><span class="Special">-        if (handler == null) {</span>
<span id="L340" class="LineNr"> 340 </span><span class="Special">-            // HTTP/2 is negotiated through SSL.</span>
<span id="L341" class="LineNr"> 341 </span><span class="Special">-            throw new IllegalStateException(&quot;cannot find a SslHandler in the pipeline (required for HTTP/2)&quot;);</span>
<span id="L342" class="LineNr"> 342 </span><span class="Special">-        }</span>
<span id="L343" class="LineNr"> 343 </span><span class="Special">-</span>
<span id="L344" class="LineNr"> 344 </span><span class="Special">-        if (!handler.handshakeFuture().isDone()) {</span>
<span id="L345" class="LineNr"> 345 </span><span class="Special">-            return false;</span>
<span id="L346" class="LineNr"> 346 </span><span class="Special">-        }</span>
<span id="L347" class="LineNr"> 347 </span><span class="Special">-</span>
<span id="L348" class="LineNr"> 348 </span><span class="Special">-        SelectedProtocol protocol;</span>
<span id="L349" class="LineNr"> 349 </span><span class="Special">-        try {</span>
<span id="L350" class="LineNr"> 350 </span><span class="Special">-            protocol = selectProtocol(handler);</span>
<span id="L351" class="LineNr"> 351 </span><span class="Special">-        } catch (Exception e) {</span>
<span id="L352" class="LineNr"> 352 </span><span class="Special">-            throw new IllegalStateException(&quot;failed to get the selected protocol&quot;, e);</span>
<span id="L353" class="LineNr"> 353 </span><span class="Special">-        }</span>
<span id="L354" class="LineNr"> 354 </span><span class="Special">-</span>
<span id="L355" class="LineNr"> 355 </span><span class="Special">-        if (protocol == null) {</span>
<span id="L356" class="LineNr"> 356 </span><span class="Special">-            throw new IllegalStateException(&quot;unknown protocol&quot;);</span>
<span id="L357" class="LineNr"> 357 </span><span class="Special">-        }</span>
<span id="L358" class="LineNr"> 358 </span><span class="Special">-</span>
<span id="L359" class="LineNr"> 359 </span><span class="Special">-        switch (protocol) {</span>
<span id="L360" class="LineNr"> 360 </span><span class="Special">-            case HTTP_2:</span>
<span id="L361" class="LineNr"> 361 </span><span class="Special">-                try {</span>
<span id="L362" class="LineNr"> 362 </span><span class="Special">-                    configureHttp2(ctx);</span>
<span id="L363" class="LineNr"> 363 </span><span class="Special">-                } catch (Exception e) {</span>
<span id="L364" class="LineNr"> 364 </span><span class="Special">-                    throw new IllegalStateException(&quot;failed to configure a HTTP/2 pipeline&quot;, e);</span>
<span id="L365" class="LineNr"> 365 </span><span class="Special">-                }</span>
<span id="L366" class="LineNr"> 366 </span><span class="Special">-                break;</span>
<span id="L367" class="LineNr"> 367 </span><span class="Special">-            case HTTP_1_0:</span>
<span id="L368" class="LineNr"> 368 </span><span class="Special">-            case HTTP_1_1:</span>
<span id="L369" class="LineNr"> 369 </span><span class="Special">-                try {</span>
<span id="L370" class="LineNr"> 370 </span><span class="Special">-                    configureHttp1(ctx);</span>
<span id="L371" class="LineNr"> 371 </span><span class="Special">-                } catch (Exception e) {</span>
<span id="L372" class="LineNr"> 372 </span><span class="Special">-                    throw new IllegalStateException(&quot;failed to configure a HTTP/1 pipeline&quot;, e);</span>
<span id="L373" class="LineNr"> 373 </span><span class="Special">-                }</span>
<span id="L374" class="LineNr"> 374 </span><span class="Special">-                break;</span>
<span id="L375" class="LineNr"> 375 </span><span class="Special">-        }</span>
<span id="L376" class="LineNr"> 376 </span><span class="Special">-        return true;</span>
<span id="L377" class="LineNr"> 377 </span><span class="Special">-    }</span>
<span id="L378" class="LineNr"> 378 </span><span class="Special">-</span>
<span id="L379" class="LineNr"> 379 </span><span class="Special">-    /**</span>
<span id="L380" class="LineNr"> 380 </span><span class="Special">-     * Returns the {@link SelectedProtocol} for the current SSL session.  By default, this method returns the first</span>
<span id="L381" class="LineNr"> 381 </span><span class="Special">-     * known protocol.</span>
<span id="L382" class="LineNr"> 382 </span><span class="Special">-     *</span>
<span id="L383" class="LineNr"> 383 </span><span class="Special">-     * @return the selected application-level protocol, or {@code null} if the application-level protocol name of</span>
<span id="L384" class="LineNr"> 384 </span><span class="Special">-     *         the specified {@code sslHandler} is neither {@code &quot;http/1.1&quot;}, {@code &quot;http/1.0&quot;} nor {@code &quot;h2&quot;}</span>
<span id="L385" class="LineNr"> 385 </span><span class="Special">-     */</span>
<span id="L386" class="LineNr"> 386 </span><span class="Special">-    protected SelectedProtocol selectProtocol(SslHandler sslHandler) throws Exception {</span>
<span id="L387" class="LineNr"> 387 </span><span class="Special">-        final String appProto = sslHandler.applicationProtocol();</span>
<span id="L388" class="LineNr"> 388 </span><span class="Special">-        return appProto != null? SelectedProtocol.protocol(appProto) : SelectedProtocol.HTTP_1_1;</span>
<span id="L389" class="LineNr"> 389 </span><span class="Special">-    }</span>
<span id="L390" class="LineNr"> 390 </span><span class="Special">-</span>
<span id="L391" class="LineNr"> 391 </span><span class="Special">-    /**</span>
<span id="L392" class="LineNr"> 392 </span><span class="Special">-     * Configures the {@link Channel} of the specified {@code ctx} for HTTP/2.</span>
<span id="L393" class="LineNr"> 393 </span><span class="Special">-     * &lt;p&gt;</span>
<span id="L394" class="LineNr"> 394 </span><span class="Special">-     * A typical implementation of this method will add a new {@link Http2ConnectionHandler} implementation</span>
<span id="L395" class="LineNr"> 395 </span><span class="Special">-     * to the pipeline.</span>
<span id="L396" class="LineNr"> 396 </span><span class="Special">-     * &lt;/p&gt;</span>
<span id="L397" class="LineNr"> 397 </span><span class="Special">-     */</span>
<span id="L398" class="LineNr"> 398 </span><span class="Special">-    protected abstract void configureHttp2(ChannelHandlerContext ctx) throws Exception;</span>
<span id="L399" class="LineNr"> 399 </span><span class="Special">-</span>
<span id="L400" class="LineNr"> 400 </span><span class="Special">-    /**</span>
<span id="L401" class="LineNr"> 401 </span><span class="Special">-     * Configures the {@link Channel} of the specified {@code ctx} for HTTP/1.</span>
<span id="L402" class="LineNr"> 402 </span><span class="Special">-     * &lt;p&gt;</span>
<span id="L403" class="LineNr"> 403 </span><span class="Special">-     * A typical implementation of this method will look like the following:</span>
<span id="L404" class="LineNr"> 404 </span><span class="Special">-     * &lt;pre&gt;</span>
<span id="L405" class="LineNr"> 405 </span><span class="Special">-     * {@link ChannelPipeline} p = ctx.pipeline();</span>
<span id="L406" class="LineNr"> 406 </span><span class="Special">-     * p.addLast(new {@link HttpServerCodec}());</span>
<span id="L407" class="LineNr"> 407 </span><span class="Special">-     * p.addLast(new &lt;i&gt;YourHttpRequestHandler&lt;/i&gt;());</span>
<span id="L408" class="LineNr"> 408 </span><span class="Special">-     * &lt;/pre&gt;</span>
<span id="L409" class="LineNr"> 409 </span><span class="Special">-     * &lt;/p&gt;</span>
<span id="L410" class="LineNr"> 410 </span><span class="Special">-     */</span>
<span id="L411" class="LineNr"> 411 </span><span class="Special">-    protected abstract void configureHttp1(ChannelHandlerContext ctx) throws Exception;</span>
<span id="L412" class="LineNr"> 412 </span><span class="Special">-</span>
<span id="L413" class="LineNr"> 413 </span><span class="Special">-    @Override</span>
<span id="L414" class="LineNr"> 414 </span><span class="Special">-    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception {</span>
<span id="L415" class="LineNr"> 415 </span><span class="Special">-        logger.warn(&quot;{} Failed to select the application-level protocol:&quot;, ctx.channel(), cause);</span>
<span id="L416" class="LineNr"> 416 </span><span class="Special">-        ctx.close();</span>
<span id="L417" class="LineNr"> 417 </span><span class="Special">-    }</span>
<span id="L418" class="LineNr"> 418 </span><span class="Special">-}</span>
<span id="L419" class="LineNr"> 419 </span><span class="Type">diff --git a/example/src/main/java/io/netty/example/http2/helloworld/client/Http2Client.java b/example/src/main/java/io/netty/example/http2/helloworld/client/Http2Client.java</span>
<span id="L420" class="LineNr"> 420 </span>index 35c9dd5..1e4c08a 100644
<span id="L421" class="LineNr"> 421 </span><span class="Type">--- a/example/src/main/java/io/netty/example/http2/helloworld/client/Http2Client.java</span>
<span id="L422" class="LineNr"> 422 </span><span class="Type">+++ b/example/src/main/java/io/netty/example/http2/helloworld/client/Http2Client.java</span>
<span id="L423" class="LineNr"> 423 </span><span class="Statement">@@ -25,12 +25,12 @@</span><span class="PreProc"> import io.netty.handler.codec.http.DefaultFullHttpRequest;</span>
<span id="L424" class="LineNr"> 424 </span> import io.netty.handler.codec.http.FullHttpRequest;
<span id="L425" class="LineNr"> 425 </span> import io.netty.handler.codec.http.HttpHeaderNames;
<span id="L426" class="LineNr"> 426 </span> import io.netty.handler.codec.http.HttpHeaderValues;
<span id="L427" class="LineNr"> 427 </span><span class="Special">-import io.netty.handler.codec.http2.Http2OrHttpChooser.SelectedProtocol;</span>
<span id="L428" class="LineNr"> 428 </span> import io.netty.handler.codec.http2.Http2SecurityUtil;
<span id="L429" class="LineNr"> 429 </span> import io.netty.handler.ssl.ApplicationProtocolConfig;
<span id="L430" class="LineNr"> 430 </span> import io.netty.handler.ssl.ApplicationProtocolConfig.Protocol;
<span id="L431" class="LineNr"> 431 </span> import io.netty.handler.ssl.ApplicationProtocolConfig.SelectedListenerFailureBehavior;
<span id="L432" class="LineNr"> 432 </span> import io.netty.handler.ssl.ApplicationProtocolConfig.SelectorFailureBehavior;
<span id="L433" class="LineNr"> 433 </span><span class="Identifier">+import io.netty.handler.ssl.ApplicationProtocolNames;</span>
<span id="L434" class="LineNr"> 434 </span> import io.netty.handler.ssl.OpenSsl;
<span id="L435" class="LineNr"> 435 </span> import io.netty.handler.ssl.SslContext;
<span id="L436" class="LineNr"> 436 </span> import io.netty.handler.ssl.SslContextBuilder;
<span id="L437" class="LineNr"> 437 </span><span class="Statement">@@ -77,8 +77,8 @@</span><span class="PreProc"> public final class Http2Client {</span>
<span id="L438" class="LineNr"> 438 </span>                     SelectorFailureBehavior.NO_ADVERTISE,
<span id="L439" class="LineNr"> 439 </span>                     // ACCEPT is currently the only mode supported by both OpenSsl and JDK providers.
<span id="L440" class="LineNr"> 440 </span>                     SelectedListenerFailureBehavior.ACCEPT,
<span id="L441" class="LineNr"> 441 </span><span class="Special">-                    SelectedProtocol.HTTP_2.protocolName(),</span>
<span id="L442" class="LineNr"> 442 </span><span class="Special">-                    SelectedProtocol.HTTP_1_1.protocolName()))</span>
<span id="L443" class="LineNr"> 443 </span><span class="Identifier">+                    ApplicationProtocolNames.HTTP_2,</span>
<span id="L444" class="LineNr"> 444 </span><span class="Identifier">+                    ApplicationProtocolNames.HTTP_1_1))</span>
<span id="L445" class="LineNr"> 445 </span>                 .build();
<span id="L446" class="LineNr"> 446 </span>         } else {
<span id="L447" class="LineNr"> 447 </span>             sslCtx = null;
<span id="L448" class="LineNr"> 448 </span><span class="Type">diff --git a/example/src/main/java/io/netty/example/http2/helloworld/server/Http2OrHttpHandler.java b/example/src/main/java/io/netty/example/http2/helloworld/server/Http2OrHttpHandler.java</span>
<span id="L449" class="LineNr"> 449 </span>index 05d61d2..7976fe9 100644
<span id="L450" class="LineNr"> 450 </span><span class="Type">--- a/example/src/main/java/io/netty/example/http2/helloworld/server/Http2OrHttpHandler.java</span>
<span id="L451" class="LineNr"> 451 </span><span class="Type">+++ b/example/src/main/java/io/netty/example/http2/helloworld/server/Http2OrHttpHandler.java</span>
<span id="L452" class="LineNr"> 452 </span><span class="Statement">@@ -17,25 +17,35 @@</span><span class="PreProc"> package io.netty.example.http2.helloworld.server;</span>
<span id="L453" class="LineNr"> 453 </span> import io.netty.channel.ChannelHandlerContext;
<span id="L454" class="LineNr"> 454 </span> import io.netty.handler.codec.http.HttpObjectAggregator;
<span id="L455" class="LineNr"> 455 </span> import io.netty.handler.codec.http.HttpServerCodec;
<span id="L456" class="LineNr"> 456 </span><span class="Special">-import io.netty.handler.codec.http2.Http2OrHttpChooser;</span>
<span id="L457" class="LineNr"> 457 </span><span class="Identifier">+import io.netty.handler.ssl.ApplicationProtocolNames;</span>
<span id="L458" class="LineNr"> 458 </span><span class="Identifier">+import io.netty.handler.ssl.ApplicationProtocolNegotiationHandler;</span>
<span id="L459" class="LineNr"> 459 </span>
<span id="L460" class="LineNr"> 460 </span> /**
<span id="L461" class="LineNr"> 461 </span>  * Negotiates with the browser if HTTP2 or HTTP is going to be used. Once decided, the Netty
<span id="L462" class="LineNr"> 462 </span>  * pipeline is setup with the correct handlers for the selected protocol.
<span id="L463" class="LineNr"> 463 </span>  */
<span id="L464" class="LineNr"> 464 </span><span class="Special">-public class Http2OrHttpHandler extends Http2OrHttpChooser {</span>
<span id="L465" class="LineNr"> 465 </span><span class="Identifier">+public class Http2OrHttpHandler extends ApplicationProtocolNegotiationHandler {</span>
<span id="L466" class="LineNr"> 466 </span>
<span id="L467" class="LineNr"> 467 </span>     private static final int MAX_CONTENT_LENGTH = 1024 * 100;
<span id="L468" class="LineNr"> 468 </span>
<span id="L469" class="LineNr"> 469 </span><span class="Special">-    @Override</span>
<span id="L470" class="LineNr"> 470 </span><span class="Special">-    protected void configureHttp2(ChannelHandlerContext ctx) throws Exception {</span>
<span id="L471" class="LineNr"> 471 </span><span class="Special">-        ctx.pipeline().addLast(new HelloWorldHttp2Handler());</span>
<span id="L472" class="LineNr"> 472 </span><span class="Identifier">+    protected Http2OrHttpHandler() {</span>
<span id="L473" class="LineNr"> 473 </span><span class="Identifier">+        super(ApplicationProtocolNames.HTTP_1_1);</span>
<span id="L474" class="LineNr"> 474 </span>     }
<span id="L475" class="LineNr"> 475 </span>
<span id="L476" class="LineNr"> 476 </span>     @Override
<span id="L477" class="LineNr"> 477 </span><span class="Special">-    protected void configureHttp1(ChannelHandlerContext ctx) throws Exception {</span>
<span id="L478" class="LineNr"> 478 </span><span class="Special">-        ctx.pipeline().addLast(new HttpServerCodec(),</span>
<span id="L479" class="LineNr"> 479 </span><span class="Special">-                               new HttpObjectAggregator(MAX_CONTENT_LENGTH),</span>
<span id="L480" class="LineNr"> 480 </span><span class="Special">-                               new HelloWorldHttp1Handler(&quot;ALPN Negotiation&quot;));</span>
<span id="L481" class="LineNr"> 481 </span><span class="Identifier">+    protected void configurePipeline(ChannelHandlerContext ctx, String protocol) throws Exception {</span>
<span id="L482" class="LineNr"> 482 </span><span class="Identifier">+        if (ApplicationProtocolNames.HTTP_2.equals(protocol)) {</span>
<span id="L483" class="LineNr"> 483 </span><span class="Identifier">+            ctx.pipeline().addLast(new HelloWorldHttp2Handler());</span>
<span id="L484" class="LineNr"> 484 </span><span class="Identifier">+            return;</span>
<span id="L485" class="LineNr"> 485 </span><span class="Identifier">+        }</span>
<span id="L486" class="LineNr"> 486 </span><span class="Identifier">+</span>
<span id="L487" class="LineNr"> 487 </span><span class="Identifier">+        if (ApplicationProtocolNames.HTTP_1_1.equals(protocol)) {</span>
<span id="L488" class="LineNr"> 488 </span><span class="Identifier">+            ctx.pipeline().addLast(new HttpServerCodec(),</span>
<span id="L489" class="LineNr"> 489 </span><span class="Identifier">+                                   new HttpObjectAggregator(MAX_CONTENT_LENGTH),</span>
<span id="L490" class="LineNr"> 490 </span><span class="Identifier">+                                   new HelloWorldHttp1Handler(&quot;ALPN Negotiation&quot;));</span>
<span id="L491" class="LineNr"> 491 </span><span class="Identifier">+            return;</span>
<span id="L492" class="LineNr"> 492 </span><span class="Identifier">+        }</span>
<span id="L493" class="LineNr"> 493 </span><span class="Identifier">+</span>
<span id="L494" class="LineNr"> 494 </span><span class="Identifier">+        throw new IllegalStateException(&quot;unknown protocol: &quot; + protocol);</span>
<span id="L495" class="LineNr"> 495 </span>     }
<span id="L496" class="LineNr"> 496 </span> }
<span id="L497" class="LineNr"> 497 </span><span class="Type">diff --git a/example/src/main/java/io/netty/example/http2/helloworld/server/Http2Server.java b/example/src/main/java/io/netty/example/http2/helloworld/server/Http2Server.java</span>
<span id="L498" class="LineNr"> 498 </span>index 26a10cc..b99b375 100644
<span id="L499" class="LineNr"> 499 </span><span class="Type">--- a/example/src/main/java/io/netty/example/http2/helloworld/server/Http2Server.java</span>
<span id="L500" class="LineNr"> 500 </span><span class="Type">+++ b/example/src/main/java/io/netty/example/http2/helloworld/server/Http2Server.java</span>
<span id="L501" class="LineNr"> 501 </span><span class="Statement">@@ -22,7 +22,6 @@</span><span class="PreProc"> import io.netty.channel.ChannelOption;</span>
<span id="L502" class="LineNr"> 502 </span> import io.netty.channel.EventLoopGroup;
<span id="L503" class="LineNr"> 503 </span> import io.netty.channel.nio.NioEventLoopGroup;
<span id="L504" class="LineNr"> 504 </span> import io.netty.channel.socket.nio.NioServerSocketChannel;
<span id="L505" class="LineNr"> 505 </span><span class="Special">-import io.netty.handler.codec.http2.Http2OrHttpChooser.SelectedProtocol;</span>
<span id="L506" class="LineNr"> 506 </span> import io.netty.handler.codec.http2.Http2SecurityUtil;
<span id="L507" class="LineNr"> 507 </span> import io.netty.handler.logging.LogLevel;
<span id="L508" class="LineNr"> 508 </span> import io.netty.handler.logging.LoggingHandler;
<span id="L509" class="LineNr"> 509 </span><span class="Statement">@@ -30,6 +29,7 @@</span><span class="PreProc"> import io.netty.handler.ssl.ApplicationProtocolConfig;</span>
<span id="L510" class="LineNr"> 510 </span> import io.netty.handler.ssl.ApplicationProtocolConfig.Protocol;
<span id="L511" class="LineNr"> 511 </span> import io.netty.handler.ssl.ApplicationProtocolConfig.SelectedListenerFailureBehavior;
<span id="L512" class="LineNr"> 512 </span> import io.netty.handler.ssl.ApplicationProtocolConfig.SelectorFailureBehavior;
<span id="L513" class="LineNr"> 513 </span><span class="Identifier">+import io.netty.handler.ssl.ApplicationProtocolNames;</span>
<span id="L514" class="LineNr"> 514 </span> import io.netty.handler.ssl.OpenSsl;
<span id="L515" class="LineNr"> 515 </span> import io.netty.handler.ssl.SslContext;
<span id="L516" class="LineNr"> 516 </span> import io.netty.handler.ssl.SslContextBuilder;
<span id="L517" class="LineNr"> 517 </span><span class="Statement">@@ -64,8 +64,8 @@</span><span class="PreProc"> public final class Http2Server {</span>
<span id="L518" class="LineNr"> 518 </span>                     SelectorFailureBehavior.NO_ADVERTISE,
<span id="L519" class="LineNr"> 519 </span>                     // ACCEPT is currently the only mode supported by both OpenSsl and JDK providers.
<span id="L520" class="LineNr"> 520 </span>                     SelectedListenerFailureBehavior.ACCEPT,
<span id="L521" class="LineNr"> 521 </span><span class="Special">-                    SelectedProtocol.HTTP_2.protocolName(),</span>
<span id="L522" class="LineNr"> 522 </span><span class="Special">-                    SelectedProtocol.HTTP_1_1.protocolName()))</span>
<span id="L523" class="LineNr"> 523 </span><span class="Identifier">+                    ApplicationProtocolNames.HTTP_2,</span>
<span id="L524" class="LineNr"> 524 </span><span class="Identifier">+                    ApplicationProtocolNames.HTTP_1_1))</span>
<span id="L525" class="LineNr"> 525 </span>                 .build();
<span id="L526" class="LineNr"> 526 </span>         } else {
<span id="L527" class="LineNr"> 527 </span>             sslCtx = null;
<span id="L528" class="LineNr"> 528 </span><span class="Type">diff --git a/example/src/main/java/io/netty/example/http2/tiles/Http2OrHttpHandler.java b/example/src/main/java/io/netty/example/http2/tiles/Http2OrHttpHandler.java</span>
<span id="L529" class="LineNr"> 529 </span>index 73b2c75..0d19858 100644
<span id="L530" class="LineNr"> 530 </span><span class="Type">--- a/example/src/main/java/io/netty/example/http2/tiles/Http2OrHttpHandler.java</span>
<span id="L531" class="LineNr"> 531 </span><span class="Type">+++ b/example/src/main/java/io/netty/example/http2/tiles/Http2OrHttpHandler.java</span>
<span id="L532" class="LineNr"> 532 </span><span class="Statement">@@ -22,36 +22,55 @@</span><span class="PreProc"> import io.netty.handler.codec.http.HttpServerCodec;</span>
<span id="L533" class="LineNr"> 533 </span> import io.netty.handler.codec.http2.DefaultHttp2Connection;
<span id="L534" class="LineNr"> 534 </span> import io.netty.handler.codec.http2.DefaultHttp2FrameReader;
<span id="L535" class="LineNr"> 535 </span> import io.netty.handler.codec.http2.DefaultHttp2FrameWriter;
<span id="L536" class="LineNr"> 536 </span><span class="Special">-import io.netty.handler.codec.http2.Http2OrHttpChooser;</span>
<span id="L537" class="LineNr"> 537 </span> import io.netty.handler.codec.http2.HttpToHttp2ConnectionHandler;
<span id="L538" class="LineNr"> 538 </span> import io.netty.handler.codec.http2.InboundHttp2ToHttpAdapter;
<span id="L539" class="LineNr"> 539 </span><span class="Identifier">+import io.netty.handler.ssl.ApplicationProtocolNames;</span>
<span id="L540" class="LineNr"> 540 </span><span class="Identifier">+import io.netty.handler.ssl.ApplicationProtocolNegotiationHandler;</span>
<span id="L541" class="LineNr"> 541 </span>
<span id="L542" class="LineNr"> 542 </span> /**
<span id="L543" class="LineNr"> 543 </span>  * Used during protocol negotiation, the main function of this handler is to
<span id="L544" class="LineNr"> 544 </span>  * return the HTTP/1.1 or HTTP/2 handler once the protocol has been negotiated.
<span id="L545" class="LineNr"> 545 </span>  */
<span id="L546" class="LineNr"> 546 </span><span class="Special">-public class Http2OrHttpHandler extends Http2OrHttpChooser {</span>
<span id="L547" class="LineNr"> 547 </span><span class="Identifier">+public class Http2OrHttpHandler extends ApplicationProtocolNegotiationHandler {</span>
<span id="L548" class="LineNr"> 548 </span>
<span id="L549" class="LineNr"> 549 </span>     private static final int MAX_CONTENT_LENGTH = 1024 * 100;
<span id="L550" class="LineNr"> 550 </span>
<span id="L551" class="LineNr"> 551 </span><span class="Identifier">+    protected Http2OrHttpHandler() {</span>
<span id="L552" class="LineNr"> 552 </span><span class="Identifier">+        super(ApplicationProtocolNames.HTTP_1_1);</span>
<span id="L553" class="LineNr"> 553 </span><span class="Identifier">+    }</span>
<span id="L554" class="LineNr"> 554 </span><span class="Identifier">+</span>
<span id="L555" class="LineNr"> 555 </span>     @Override
<span id="L556" class="LineNr"> 556 </span><span class="Special">-    protected void configureHttp2(ChannelHandlerContext ctx) {</span>
<span id="L557" class="LineNr"> 557 </span><span class="Identifier">+    protected void configurePipeline(ChannelHandlerContext ctx, String protocol) throws Exception {</span>
<span id="L558" class="LineNr"> 558 </span><span class="Identifier">+        if (ApplicationProtocolNames.HTTP_2.equals(protocol)) {</span>
<span id="L559" class="LineNr"> 559 </span><span class="Identifier">+            configureHttp2(ctx);</span>
<span id="L560" class="LineNr"> 560 </span><span class="Identifier">+            return;</span>
<span id="L561" class="LineNr"> 561 </span><span class="Identifier">+        }</span>
<span id="L562" class="LineNr"> 562 </span><span class="Identifier">+</span>
<span id="L563" class="LineNr"> 563 </span><span class="Identifier">+        if (ApplicationProtocolNames.HTTP_1_1.equals(protocol)) {</span>
<span id="L564" class="LineNr"> 564 </span><span class="Identifier">+            configureHttp1(ctx);</span>
<span id="L565" class="LineNr"> 565 </span><span class="Identifier">+            return;</span>
<span id="L566" class="LineNr"> 566 </span><span class="Identifier">+        }</span>
<span id="L567" class="LineNr"> 567 </span><span class="Identifier">+</span>
<span id="L568" class="LineNr"> 568 </span><span class="Identifier">+        throw new IllegalStateException(&quot;unknown protocol: &quot; + protocol);</span>
<span id="L569" class="LineNr"> 569 </span><span class="Identifier">+    }</span>
<span id="L570" class="LineNr"> 570 </span><span class="Identifier">+</span>
<span id="L571" class="LineNr"> 571 </span><span class="Identifier">+    private static void configureHttp2(ChannelHandlerContext ctx) {</span>
<span id="L572" class="LineNr"> 572 </span>         DefaultHttp2Connection connection = new DefaultHttp2Connection(true);
<span id="L573" class="LineNr"> 573 </span>         DefaultHttp2FrameWriter writer = new DefaultHttp2FrameWriter();
<span id="L574" class="LineNr"> 574 </span>         DefaultHttp2FrameReader reader = new DefaultHttp2FrameReader();
<span id="L575" class="LineNr"> 575 </span><span class="Special">-        InboundHttp2ToHttpAdapter listener = new InboundHttp2ToHttpAdapter.Builder(connection).propagateSettings(true)</span>
<span id="L576" class="LineNr"> 576 </span><span class="Special">-                .validateHttpHeaders(false).maxContentLength(MAX_CONTENT_LENGTH).build();</span>
<span id="L577" class="LineNr"> 577 </span><span class="Identifier">+        InboundHttp2ToHttpAdapter listener = new InboundHttp2ToHttpAdapter.Builder(connection)</span>
<span id="L578" class="LineNr"> 578 </span><span class="Identifier">+                .propagateSettings(true).validateHttpHeaders(false).maxContentLength(MAX_CONTENT_LENGTH).build();</span>
<span id="L579" class="LineNr"> 579 </span>
<span id="L580" class="LineNr"> 580 </span><span class="Special">-        ctx.pipeline().addLast(&quot;httpToHttp2&quot;, new HttpToHttp2ConnectionHandler(connection,</span>
<span id="L581" class="LineNr"> 581 </span><span class="Identifier">+        ctx.pipeline().addLast(new HttpToHttp2ConnectionHandler(</span>
<span id="L582" class="LineNr"> 582 </span><span class="Identifier">+                connection,</span>
<span id="L583" class="LineNr"> 583 </span>                 // Loggers can be activated for debugging purposes
<span id="L584" class="LineNr"> 584 </span>                 // new Http2InboundFrameLogger(reader, TilesHttp2ToHttpHandler.logger),
<span id="L585" class="LineNr"> 585 </span>                 // new Http2OutboundFrameLogger(writer, TilesHttp2ToHttpHandler.logger)
<span id="L586" class="LineNr"> 586 </span>                 reader, writer, listener));
<span id="L587" class="LineNr"> 587 </span><span class="Special">-        ctx.pipeline().addLast(&quot;fullHttpRequestHandler&quot;, new Http2RequestHandler());</span>
<span id="L588" class="LineNr"> 588 </span><span class="Identifier">+        ctx.pipeline().addLast(new Http2RequestHandler());</span>
<span id="L589" class="LineNr"> 589 </span>     }
<span id="L590" class="LineNr"> 590 </span>
<span id="L591" class="LineNr"> 591 </span><span class="Special">-    @Override</span>
<span id="L592" class="LineNr"> 592 </span><span class="Special">-    protected void configureHttp1(ChannelHandlerContext ctx) throws Exception {</span>
<span id="L593" class="LineNr"> 593 </span><span class="Identifier">+    private static void configureHttp1(ChannelHandlerContext ctx) throws Exception {</span>
<span id="L594" class="LineNr"> 594 </span>         ctx.pipeline().addLast(new HttpServerCodec(),
<span id="L595" class="LineNr"> 595 </span>                                new HttpObjectAggregator(MAX_CONTENT_LENGTH),
<span id="L596" class="LineNr"> 596 </span>                                new FallbackRequestHandler());
<span id="L597" class="LineNr"> 597 </span><span class="Type">diff --git a/example/src/main/java/io/netty/example/http2/tiles/Http2Server.java b/example/src/main/java/io/netty/example/http2/tiles/Http2Server.java</span>
<span id="L598" class="LineNr"> 598 </span>index b870a64..2a50c5a 100644
<span id="L599" class="LineNr"> 599 </span><span class="Type">--- a/example/src/main/java/io/netty/example/http2/tiles/Http2Server.java</span>
<span id="L600" class="LineNr"> 600 </span><span class="Type">+++ b/example/src/main/java/io/netty/example/http2/tiles/Http2Server.java</span>
<span id="L601" class="LineNr"> 601 </span><span class="Statement">@@ -16,8 +16,6 @@</span>
<span id="L602" class="LineNr"> 602 </span>
<span id="L603" class="LineNr"> 603 </span> package io.netty.example.http2.tiles;
<span id="L604" class="LineNr"> 604 </span>
<span id="L605" class="LineNr"> 605 </span><span class="Special">-import static io.netty.handler.codec.http2.Http2OrHttpChooser.SelectedProtocol.HTTP_1_1;</span>
<span id="L606" class="LineNr"> 606 </span><span class="Special">-import static io.netty.handler.codec.http2.Http2OrHttpChooser.SelectedProtocol.HTTP_2;</span>
<span id="L607" class="LineNr"> 607 </span> import static io.netty.handler.codec.http2.Http2SecurityUtil.CIPHERS;
<span id="L608" class="LineNr"> 608 </span> import io.netty.bootstrap.ServerBootstrap;
<span id="L609" class="LineNr"> 609 </span> import io.netty.channel.Channel;
<span id="L610" class="LineNr"> 610 </span><span class="Statement">@@ -31,6 +29,7 @@</span><span class="PreProc"> import io.netty.handler.ssl.ApplicationProtocolConfig;</span>
<span id="L611" class="LineNr"> 611 </span> import io.netty.handler.ssl.ApplicationProtocolConfig.Protocol;
<span id="L612" class="LineNr"> 612 </span> import io.netty.handler.ssl.ApplicationProtocolConfig.SelectedListenerFailureBehavior;
<span id="L613" class="LineNr"> 613 </span> import io.netty.handler.ssl.ApplicationProtocolConfig.SelectorFailureBehavior;
<span id="L614" class="LineNr"> 614 </span><span class="Identifier">+import io.netty.handler.ssl.ApplicationProtocolNames;</span>
<span id="L615" class="LineNr"> 615 </span> import io.netty.handler.ssl.SslContext;
<span id="L616" class="LineNr"> 616 </span> import io.netty.handler.ssl.SslContextBuilder;
<span id="L617" class="LineNr"> 617 </span> import io.netty.handler.ssl.SupportedCipherSuiteFilter;
<span id="L618" class="LineNr"> 618 </span><span class="Statement">@@ -70,17 +69,19 @@</span><span class="PreProc"> public class Http2Server {</span>
<span id="L619" class="LineNr"> 619 </span>         return ch.closeFuture();
<span id="L620" class="LineNr"> 620 </span>     }
<span id="L621" class="LineNr"> 621 </span>
<span id="L622" class="LineNr"> 622 </span><span class="Special">-    private SslContext configureTLS() throws CertificateException, SSLException {</span>
<span id="L623" class="LineNr"> 623 </span><span class="Identifier">+    private static SslContext configureTLS() throws CertificateException, SSLException {</span>
<span id="L624" class="LineNr"> 624 </span>         SelfSignedCertificate ssc = new SelfSignedCertificate();
<span id="L625" class="LineNr"> 625 </span><span class="Special">-        ApplicationProtocolConfig apn = new ApplicationProtocolConfig(Protocol.ALPN,</span>
<span id="L626" class="LineNr"> 626 </span><span class="Special">-                  // NO_ADVERTISE is currently the only mode supported by both OpenSsl and JDK providers.</span>
<span id="L627" class="LineNr"> 627 </span><span class="Special">-                  SelectorFailureBehavior.NO_ADVERTISE,</span>
<span id="L628" class="LineNr"> 628 </span><span class="Special">-                  // ACCEPT is currently the only mode supported by both OpenSsl and JDK providers.</span>
<span id="L629" class="LineNr"> 629 </span><span class="Special">-                  SelectedListenerFailureBehavior.ACCEPT,</span>
<span id="L630" class="LineNr"> 630 </span><span class="Special">-                  HTTP_2.protocolName(), HTTP_1_1.protocolName());</span>
<span id="L631" class="LineNr"> 631 </span><span class="Special">-        final SslContext sslCtx = SslContextBuilder.forServer(ssc.certificate(), ssc.privateKey(), null)</span>
<span id="L632" class="LineNr"> 632 </span><span class="Identifier">+        ApplicationProtocolConfig apn = new ApplicationProtocolConfig(</span>
<span id="L633" class="LineNr"> 633 </span><span class="Identifier">+                Protocol.ALPN,</span>
<span id="L634" class="LineNr"> 634 </span><span class="Identifier">+                // NO_ADVERTISE is currently the only mode supported by both OpenSsl and JDK providers.</span>
<span id="L635" class="LineNr"> 635 </span><span class="Identifier">+                SelectorFailureBehavior.NO_ADVERTISE,</span>
<span id="L636" class="LineNr"> 636 </span><span class="Identifier">+                // ACCEPT is currently the only mode supported by both OpenSsl and JDK providers.</span>
<span id="L637" class="LineNr"> 637 </span><span class="Identifier">+                SelectedListenerFailureBehavior.ACCEPT,</span>
<span id="L638" class="LineNr"> 638 </span><span class="Identifier">+                ApplicationProtocolNames.HTTP_2,</span>
<span id="L639" class="LineNr"> 639 </span><span class="Identifier">+                ApplicationProtocolNames.HTTP_1_1);</span>
<span id="L640" class="LineNr"> 640 </span><span class="Identifier">+</span>
<span id="L641" class="LineNr"> 641 </span><span class="Identifier">+        return SslContextBuilder.forServer(ssc.certificate(), ssc.privateKey(), null)</span>
<span id="L642" class="LineNr"> 642 </span>                                 .ciphers(CIPHERS, SupportedCipherSuiteFilter.INSTANCE)
<span id="L643" class="LineNr"> 643 </span>                                 .applicationProtocolConfig(apn).build();
<span id="L644" class="LineNr"> 644 </span><span class="Special">-        return sslCtx;</span>
<span id="L645" class="LineNr"> 645 </span>     }
<span id="L646" class="LineNr"> 646 </span> }
<span id="L647" class="LineNr"> 647 </span><span class="Type">diff --git a/example/src/main/java/io/netty/example/spdy/client/SpdyClient.java b/example/src/main/java/io/netty/example/spdy/client/SpdyClient.java</span>
<span id="L648" class="LineNr"> 648 </span>index 12062fe..22a2acd 100644
<span id="L649" class="LineNr"> 649 </span><span class="Type">--- a/example/src/main/java/io/netty/example/spdy/client/SpdyClient.java</span>
<span id="L650" class="LineNr"> 650 </span><span class="Type">+++ b/example/src/main/java/io/netty/example/spdy/client/SpdyClient.java</span>
<span id="L651" class="LineNr"> 651 </span><span class="Statement">@@ -27,11 +27,11 @@</span><span class="PreProc"> import io.netty.handler.codec.http.HttpHeaderValues;</span>
<span id="L652" class="LineNr"> 652 </span> import io.netty.handler.codec.http.HttpMethod;
<span id="L653" class="LineNr"> 653 </span> import io.netty.handler.codec.http.HttpRequest;
<span id="L654" class="LineNr"> 654 </span> import io.netty.handler.codec.http.HttpVersion;
<span id="L655" class="LineNr"> 655 </span><span class="Special">-import io.netty.handler.codec.spdy.SpdyOrHttpChooser.SelectedProtocol;</span>
<span id="L656" class="LineNr"> 656 </span> import io.netty.handler.ssl.ApplicationProtocolConfig;
<span id="L657" class="LineNr"> 657 </span> import io.netty.handler.ssl.ApplicationProtocolConfig.Protocol;
<span id="L658" class="LineNr"> 658 </span> import io.netty.handler.ssl.ApplicationProtocolConfig.SelectedListenerFailureBehavior;
<span id="L659" class="LineNr"> 659 </span> import io.netty.handler.ssl.ApplicationProtocolConfig.SelectorFailureBehavior;
<span id="L660" class="LineNr"> 660 </span><span class="Identifier">+import io.netty.handler.ssl.ApplicationProtocolNames;</span>
<span id="L661" class="LineNr"> 661 </span> import io.netty.handler.ssl.SslContext;
<span id="L662" class="LineNr"> 662 </span> import io.netty.handler.ssl.SslContextBuilder;
<span id="L663" class="LineNr"> 663 </span> import io.netty.handler.ssl.util.InsecureTrustManagerFactory;
<span id="L664" class="LineNr"> 664 </span><span class="Statement">@@ -64,8 +64,8 @@</span><span class="PreProc"> public final class SpdyClient {</span>
<span id="L665" class="LineNr"> 665 </span>                         SelectorFailureBehavior.NO_ADVERTISE,
<span id="L666" class="LineNr"> 666 </span>                         // ACCEPT is currently the only mode supported by both OpenSsl and JDK providers.
<span id="L667" class="LineNr"> 667 </span>                         SelectedListenerFailureBehavior.ACCEPT,
<span id="L668" class="LineNr"> 668 </span><span class="Special">-                        SelectedProtocol.SPDY_3_1.protocolName(),</span>
<span id="L669" class="LineNr"> 669 </span><span class="Special">-                        SelectedProtocol.HTTP_1_1.protocolName()))</span>
<span id="L670" class="LineNr"> 670 </span><span class="Identifier">+                        ApplicationProtocolNames.SPDY_3_1,</span>
<span id="L671" class="LineNr"> 671 </span><span class="Identifier">+                        ApplicationProtocolNames.HTTP_1_1))</span>
<span id="L672" class="LineNr"> 672 </span>             .build();
<span id="L673" class="LineNr"> 673 </span>
<span id="L674" class="LineNr"> 674 </span>         HttpResponseClientHandler httpResponseHandler = new HttpResponseClientHandler();
<span id="L675" class="LineNr"> 675 </span><span class="Type">diff --git a/example/src/main/java/io/netty/example/spdy/server/SpdyOrHttpHandler.java b/example/src/main/java/io/netty/example/spdy/server/SpdyOrHttpHandler.java</span>
<span id="L676" class="LineNr"> 676 </span>index 19490a2..bed9bd2 100644
<span id="L677" class="LineNr"> 677 </span><span class="Type">--- a/example/src/main/java/io/netty/example/spdy/server/SpdyOrHttpHandler.java</span>
<span id="L678" class="LineNr"> 678 </span><span class="Type">+++ b/example/src/main/java/io/netty/example/spdy/server/SpdyOrHttpHandler.java</span>
<span id="L679" class="LineNr"> 679 </span><span class="Statement">@@ -23,20 +23,39 @@</span><span class="PreProc"> import io.netty.handler.codec.spdy.SpdyFrameCodec;</span>
<span id="L680" class="LineNr"> 680 </span> import io.netty.handler.codec.spdy.SpdyHttpDecoder;
<span id="L681" class="LineNr"> 681 </span> import io.netty.handler.codec.spdy.SpdyHttpEncoder;
<span id="L682" class="LineNr"> 682 </span> import io.netty.handler.codec.spdy.SpdyHttpResponseStreamIdHandler;
<span id="L683" class="LineNr"> 683 </span><span class="Special">-import io.netty.handler.codec.spdy.SpdyOrHttpChooser;</span>
<span id="L684" class="LineNr"> 684 </span> import io.netty.handler.codec.spdy.SpdySessionHandler;
<span id="L685" class="LineNr"> 685 </span> import io.netty.handler.codec.spdy.SpdyVersion;
<span id="L686" class="LineNr"> 686 </span><span class="Identifier">+import io.netty.handler.ssl.ApplicationProtocolNames;</span>
<span id="L687" class="LineNr"> 687 </span><span class="Identifier">+import io.netty.handler.ssl.ApplicationProtocolNegotiationHandler;</span>
<span id="L688" class="LineNr"> 688 </span>
<span id="L689" class="LineNr"> 689 </span> /**
<span id="L690" class="LineNr"> 690 </span>  * Negotiates with the browser if SPDY or HTTP is going to be used. Once decided, the Netty pipeline is setup with
<span id="L691" class="LineNr"> 691 </span>  * the correct handlers for the selected protocol.
<span id="L692" class="LineNr"> 692 </span>  */
<span id="L693" class="LineNr"> 693 </span><span class="Special">-public class SpdyOrHttpHandler extends SpdyOrHttpChooser {</span>
<span id="L694" class="LineNr"> 694 </span><span class="Identifier">+public class SpdyOrHttpHandler extends ApplicationProtocolNegotiationHandler {</span>
<span id="L695" class="LineNr"> 695 </span>
<span id="L696" class="LineNr"> 696 </span>     private static final int MAX_CONTENT_LENGTH = 1024 * 100;
<span id="L697" class="LineNr"> 697 </span>
<span id="L698" class="LineNr"> 698 </span><span class="Identifier">+    protected SpdyOrHttpHandler() {</span>
<span id="L699" class="LineNr"> 699 </span><span class="Identifier">+        super(ApplicationProtocolNames.HTTP_1_1);</span>
<span id="L700" class="LineNr"> 700 </span><span class="Identifier">+    }</span>
<span id="L701" class="LineNr"> 701 </span><span class="Identifier">+</span>
<span id="L702" class="LineNr"> 702 </span>     @Override
<span id="L703" class="LineNr"> 703 </span><span class="Special">-    protected void configureSpdy(ChannelHandlerContext ctx, SpdyVersion version) throws Exception {</span>
<span id="L704" class="LineNr"> 704 </span><span class="Identifier">+    protected void configurePipeline(ChannelHandlerContext ctx, String protocol) throws Exception {</span>
<span id="L705" class="LineNr"> 705 </span><span class="Identifier">+        if (ApplicationProtocolNames.SPDY_3_1.equals(protocol)) {</span>
<span id="L706" class="LineNr"> 706 </span><span class="Identifier">+            configureSpdy(ctx, SpdyVersion.SPDY_3_1);</span>
<span id="L707" class="LineNr"> 707 </span><span class="Identifier">+            return;</span>
<span id="L708" class="LineNr"> 708 </span><span class="Identifier">+        }</span>
<span id="L709" class="LineNr"> 709 </span><span class="Identifier">+</span>
<span id="L710" class="LineNr"> 710 </span><span class="Identifier">+        if (ApplicationProtocolNames.HTTP_1_1.equals(protocol)) {</span>
<span id="L711" class="LineNr"> 711 </span><span class="Identifier">+            configureHttp1(ctx);</span>
<span id="L712" class="LineNr"> 712 </span><span class="Identifier">+            return;</span>
<span id="L713" class="LineNr"> 713 </span><span class="Identifier">+        }</span>
<span id="L714" class="LineNr"> 714 </span><span class="Identifier">+</span>
<span id="L715" class="LineNr"> 715 </span><span class="Identifier">+        throw new IllegalStateException(&quot;unknown protocol: &quot; + protocol);</span>
<span id="L716" class="LineNr"> 716 </span><span class="Identifier">+    }</span>
<span id="L717" class="LineNr"> 717 </span><span class="Identifier">+</span>
<span id="L718" class="LineNr"> 718 </span><span class="Identifier">+    private static void configureSpdy(ChannelHandlerContext ctx, SpdyVersion version) throws Exception {</span>
<span id="L719" class="LineNr"> 719 </span>         ChannelPipeline p = ctx.pipeline();
<span id="L720" class="LineNr"> 720 </span>         p.addLast(new SpdyFrameCodec(version));
<span id="L721" class="LineNr"> 721 </span>         p.addLast(new SpdySessionHandler(version, true));
<span id="L722" class="LineNr"> 722 </span><span class="Statement">@@ -46,8 +65,7 @@</span><span class="PreProc"> public class SpdyOrHttpHandler extends SpdyOrHttpChooser {</span>
<span id="L723" class="LineNr"> 723 </span>         p.addLast(new SpdyServerHandler());
<span id="L724" class="LineNr"> 724 </span>     }
<span id="L725" class="LineNr"> 725 </span>
<span id="L726" class="LineNr"> 726 </span><span class="Special">-    @Override</span>
<span id="L727" class="LineNr"> 727 </span><span class="Special">-    protected void configureHttp1(ChannelHandlerContext ctx) throws Exception {</span>
<span id="L728" class="LineNr"> 728 </span><span class="Identifier">+    private static void configureHttp1(ChannelHandlerContext ctx) throws Exception {</span>
<span id="L729" class="LineNr"> 729 </span>         ChannelPipeline p = ctx.pipeline();
<span id="L730" class="LineNr"> 730 </span>         p.addLast(new HttpServerCodec());
<span id="L731" class="LineNr"> 731 </span>         p.addLast(new HttpObjectAggregator(MAX_CONTENT_LENGTH));
<span id="L732" class="LineNr"> 732 </span><span class="Type">diff --git a/example/src/main/java/io/netty/example/spdy/server/SpdyServer.java b/example/src/main/java/io/netty/example/spdy/server/SpdyServer.java</span>
<span id="L733" class="LineNr"> 733 </span>index 67d3cf2..827988d 100644
<span id="L734" class="LineNr"> 734 </span><span class="Type">--- a/example/src/main/java/io/netty/example/spdy/server/SpdyServer.java</span>
<span id="L735" class="LineNr"> 735 </span><span class="Type">+++ b/example/src/main/java/io/netty/example/spdy/server/SpdyServer.java</span>
<span id="L736" class="LineNr"> 736 </span><span class="Statement">@@ -21,13 +21,13 @@</span><span class="PreProc"> import io.netty.channel.ChannelOption;</span>
<span id="L737" class="LineNr"> 737 </span> import io.netty.channel.EventLoopGroup;
<span id="L738" class="LineNr"> 738 </span> import io.netty.channel.nio.NioEventLoopGroup;
<span id="L739" class="LineNr"> 739 </span> import io.netty.channel.socket.nio.NioServerSocketChannel;
<span id="L740" class="LineNr"> 740 </span><span class="Special">-import io.netty.handler.codec.spdy.SpdyOrHttpChooser.SelectedProtocol;</span>
<span id="L741" class="LineNr"> 741 </span> import io.netty.handler.logging.LogLevel;
<span id="L742" class="LineNr"> 742 </span> import io.netty.handler.logging.LoggingHandler;
<span id="L743" class="LineNr"> 743 </span> import io.netty.handler.ssl.ApplicationProtocolConfig;
<span id="L744" class="LineNr"> 744 </span> import io.netty.handler.ssl.ApplicationProtocolConfig.Protocol;
<span id="L745" class="LineNr"> 745 </span> import io.netty.handler.ssl.ApplicationProtocolConfig.SelectedListenerFailureBehavior;
<span id="L746" class="LineNr"> 746 </span> import io.netty.handler.ssl.ApplicationProtocolConfig.SelectorFailureBehavior;
<span id="L747" class="LineNr"> 747 </span><span class="Identifier">+import io.netty.handler.ssl.ApplicationProtocolNames;</span>
<span id="L748" class="LineNr"> 748 </span> import io.netty.handler.ssl.SslContext;
<span id="L749" class="LineNr"> 749 </span> import io.netty.handler.ssl.SslContextBuilder;
<span id="L750" class="LineNr"> 750 </span> import io.netty.handler.ssl.util.SelfSignedCertificate;
<span id="L751" class="LineNr"> 751 </span><span class="Statement">@@ -64,8 +64,8 @@</span><span class="PreProc"> public final class SpdyServer {</span>
<span id="L752" class="LineNr"> 752 </span>                         SelectorFailureBehavior.NO_ADVERTISE,
<span id="L753" class="LineNr"> 753 </span>                         // ACCEPT is currently the only mode supported by both OpenSsl and JDK providers.
<span id="L754" class="LineNr"> 754 </span>                         SelectedListenerFailureBehavior.ACCEPT,
<span id="L755" class="LineNr"> 755 </span><span class="Special">-                        SelectedProtocol.SPDY_3_1.protocolName(),</span>
<span id="L756" class="LineNr"> 756 </span><span class="Special">-                        SelectedProtocol.HTTP_1_1.protocolName()))</span>
<span id="L757" class="LineNr"> 757 </span><span class="Identifier">+                        ApplicationProtocolNames.SPDY_3_1,</span>
<span id="L758" class="LineNr"> 758 </span><span class="Identifier">+                        ApplicationProtocolNames.HTTP_1_1))</span>
<span id="L759" class="LineNr"> 759 </span>             .build();
<span id="L760" class="LineNr"> 760 </span>
<span id="L761" class="LineNr"> 761 </span>         // Configure the server.
<span id="L762" class="LineNr"> 762 </span><span class="Type">diff --git a/handler/src/main/java/io/netty/handler/ssl/ApplicationProtocolAccessor.java b/handler/src/main/java/io/netty/handler/ssl/ApplicationProtocolAccessor.java</span>
<span id="L763" class="LineNr"> 763 </span>index 812762d..8835bc8 100644
<span id="L764" class="LineNr"> 764 </span><span class="Type">--- a/handler/src/main/java/io/netty/handler/ssl/ApplicationProtocolAccessor.java</span>
<span id="L765" class="LineNr"> 765 </span><span class="Type">+++ b/handler/src/main/java/io/netty/handler/ssl/ApplicationProtocolAccessor.java</span>
<span id="L766" class="LineNr"> 766 </span><span class="Statement">@@ -20,5 +20,11 @@</span><span class="PreProc"> package io.netty.handler.ssl;</span>
<span id="L767" class="LineNr"> 767 </span>  * Provides a way to get the application-level protocol name from ALPN or NPN.
<span id="L768" class="LineNr"> 768 </span>  */
<span id="L769" class="LineNr"> 769 </span> interface ApplicationProtocolAccessor {
<span id="L770" class="LineNr"> 770 </span><span class="Identifier">+    /**</span>
<span id="L771" class="LineNr"> 771 </span><span class="Identifier">+     * Returns the name of the negotiated application-level protocol.</span>
<span id="L772" class="LineNr"> 772 </span><span class="Identifier">+     *</span>
<span id="L773" class="LineNr"> 773 </span><span class="Identifier">+     * @return the application-level protocol name or</span>
<span id="L774" class="LineNr"> 774 </span><span class="Identifier">+     *         {@code null} if the negotiation failed or the client does not have ALPN/NPN extension</span>
<span id="L775" class="LineNr"> 775 </span><span class="Identifier">+     */</span>
<span id="L776" class="LineNr"> 776 </span>     String getApplicationProtocol();
<span id="L777" class="LineNr"> 777 </span> }
<span id="L778" class="LineNr"> 778 </span><span class="Type">diff --git a/handler/src/main/java/io/netty/handler/ssl/ApplicationProtocolNames.java b/handler/src/main/java/io/netty/handler/ssl/ApplicationProtocolNames.java</span>
<span id="L779" class="LineNr"> 779 </span>new file mode 100644
<span id="L780" class="LineNr"> 780 </span>index 0000000..b17fd69
<span id="L781" class="LineNr"> 781 </span><span class="Type">--- /dev/null</span>
<span id="L782" class="LineNr"> 782 </span><span class="Type">+++ b/handler/src/main/java/io/netty/handler/ssl/ApplicationProtocolNames.java</span>
<span id="L783" class="LineNr"> 783 </span><span class="Statement">@@ -0,0 +1,59 @@</span>
<span id="L784" class="LineNr"> 784 </span><span class="Identifier">+/*</span>
<span id="L785" class="LineNr"> 785 </span><span class="Identifier">+ * Copyright 2015 The Netty Project</span>
<span id="L786" class="LineNr"> 786 </span><span class="Identifier">+ *</span>
<span id="L787" class="LineNr"> 787 </span><span class="Identifier">+ * The Netty Project licenses this file to you under the Apache License,</span>
<span id="L788" class="LineNr"> 788 </span><span class="Identifier">+ * version 2.0 (the &quot;License&quot;); you may not use this file except in compliance</span>
<span id="L789" class="LineNr"> 789 </span><span class="Identifier">+ * with the License. You may obtain a copy of the License at:</span>
<span id="L790" class="LineNr"> 790 </span><span class="Identifier">+ *</span>
<span id="L791" class="LineNr"> 791 </span><span class="Identifier">+ *   <a href="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</a></span>
<span id="L792" class="LineNr"> 792 </span><span class="Identifier">+ *</span>
<span id="L793" class="LineNr"> 793 </span><span class="Identifier">+ * Unless required by applicable law or agreed to in writing, software</span>
<span id="L794" class="LineNr"> 794 </span><span class="Identifier">+ * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT</span>
<span id="L795" class="LineNr"> 795 </span><span class="Identifier">+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the</span>
<span id="L796" class="LineNr"> 796 </span><span class="Identifier">+ * License for the specific language governing permissions and limitations</span>
<span id="L797" class="LineNr"> 797 </span><span class="Identifier">+ * under the License.</span>
<span id="L798" class="LineNr"> 798 </span><span class="Identifier">+ */</span>
<span id="L799" class="LineNr"> 799 </span><span class="Identifier">+</span>
<span id="L800" class="LineNr"> 800 </span><span class="Identifier">+package io.netty.handler.ssl;</span>
<span id="L801" class="LineNr"> 801 </span><span class="Identifier">+</span>
<span id="L802" class="LineNr"> 802 </span><span class="Identifier">+/**</span>
<span id="L803" class="LineNr"> 803 </span><span class="Identifier">+ * Provides a set of protocol names used in ALPN and NPN.</span>
<span id="L804" class="LineNr"> 804 </span><span class="Identifier">+ *</span>
<span id="L805" class="LineNr"> 805 </span><span class="Identifier">+ * @see &lt;a href=&quot;<a href="https://tools.ietf.org/html/rfc7540#section-11.1">https://tools.ietf.org/html/rfc7540#section-11.1</a>&quot;&gt;RFC7540 (HTTP/2)&lt;/a&gt;</span>
<span id="L806" class="LineNr"> 806 </span><span class="Identifier">+ * @see &lt;a href=&quot;<a href="https://tools.ietf.org/html/rfc7301#section-6">https://tools.ietf.org/html/rfc7301#section-6</a>&quot;&gt;RFC7301 (TLS ALPN Extension)&lt;/a&gt;</span>
<span id="L807" class="LineNr"> 807 </span><span class="Identifier">+ * @see &lt;a href=&quot;<a href="https://tools.ietf.org/html/draft-agl-tls-nextprotoneg-04#section-7">https://tools.ietf.org/html/draft-agl-tls-nextprotoneg-04#section-7</a>&quot;&gt;TLS NPN Extension Draft&lt;/a&gt;</span>
<span id="L808" class="LineNr"> 808 </span><span class="Identifier">+ */</span>
<span id="L809" class="LineNr"> 809 </span><span class="Identifier">+public final class ApplicationProtocolNames {</span>
<span id="L810" class="LineNr"> 810 </span><span class="Identifier">+</span>
<span id="L811" class="LineNr"> 811 </span><span class="Identifier">+    /**</span>
<span id="L812" class="LineNr"> 812 </span><span class="Identifier">+     * {@code &quot;h2&quot;}: HTTP version 2</span>
<span id="L813" class="LineNr"> 813 </span><span class="Identifier">+     */</span>
<span id="L814" class="LineNr"> 814 </span><span class="Identifier">+    public static final String HTTP_2 = &quot;h2&quot;;</span>
<span id="L815" class="LineNr"> 815 </span><span class="Identifier">+</span>
<span id="L816" class="LineNr"> 816 </span><span class="Identifier">+    /**</span>
<span id="L817" class="LineNr"> 817 </span><span class="Identifier">+     * {@code &quot;http/1.1&quot;}: HTTP version 1.1</span>
<span id="L818" class="LineNr"> 818 </span><span class="Identifier">+     */</span>
<span id="L819" class="LineNr"> 819 </span><span class="Identifier">+    public static final String HTTP_1_1 = &quot;http/1.1&quot;;</span>
<span id="L820" class="LineNr"> 820 </span><span class="Identifier">+</span>
<span id="L821" class="LineNr"> 821 </span><span class="Identifier">+    /**</span>
<span id="L822" class="LineNr"> 822 </span><span class="Identifier">+     * {@code &quot;spdy/3.1&quot;}: SPDY version 3.1</span>
<span id="L823" class="LineNr"> 823 </span><span class="Identifier">+     */</span>
<span id="L824" class="LineNr"> 824 </span><span class="Identifier">+    public static final String SPDY_3_1 = &quot;spdy/3.1&quot;;</span>
<span id="L825" class="LineNr"> 825 </span><span class="Identifier">+</span>
<span id="L826" class="LineNr"> 826 </span><span class="Identifier">+    /**</span>
<span id="L827" class="LineNr"> 827 </span><span class="Identifier">+     * {@code &quot;spdy/3&quot;}: SPDY version 3</span>
<span id="L828" class="LineNr"> 828 </span><span class="Identifier">+     */</span>
<span id="L829" class="LineNr"> 829 </span><span class="Identifier">+    public static final String SPDY_3 = &quot;spdy/3&quot;;</span>
<span id="L830" class="LineNr"> 830 </span><span class="Identifier">+</span>
<span id="L831" class="LineNr"> 831 </span><span class="Identifier">+    /**</span>
<span id="L832" class="LineNr"> 832 </span><span class="Identifier">+     * {@code &quot;spdy/2&quot;}: SPDY version 2</span>
<span id="L833" class="LineNr"> 833 </span><span class="Identifier">+     */</span>
<span id="L834" class="LineNr"> 834 </span><span class="Identifier">+    public static final String SPDY_2 = &quot;spdy/2&quot;;</span>
<span id="L835" class="LineNr"> 835 </span><span class="Identifier">+</span>
<span id="L836" class="LineNr"> 836 </span><span class="Identifier">+    /**</span>
<span id="L837" class="LineNr"> 837 </span><span class="Identifier">+     * {@code &quot;spdy/1&quot;}: SPDY version 1</span>
<span id="L838" class="LineNr"> 838 </span><span class="Identifier">+     */</span>
<span id="L839" class="LineNr"> 839 </span><span class="Identifier">+    public static final String SPDY_1 = &quot;spdy/1&quot;;</span>
<span id="L840" class="LineNr"> 840 </span><span class="Identifier">+</span>
<span id="L841" class="LineNr"> 841 </span><span class="Identifier">+    private ApplicationProtocolNames() { }</span>
<span id="L842" class="LineNr"> 842 </span><span class="Identifier">+}</span>
<span id="L843" class="LineNr"> 843 </span><span class="Type">diff --git a/handler/src/main/java/io/netty/handler/ssl/ApplicationProtocolNegotiationHandler.java b/handler/src/main/java/io/netty/handler/ssl/ApplicationProtocolNegotiationHandler.java</span>
<span id="L844" class="LineNr"> 844 </span>new file mode 100644
<span id="L845" class="LineNr"> 845 </span>index 0000000..48a6327
<span id="L846" class="LineNr"> 846 </span><span class="Type">--- /dev/null</span>
<span id="L847" class="LineNr"> 847 </span><span class="Type">+++ b/handler/src/main/java/io/netty/handler/ssl/ApplicationProtocolNegotiationHandler.java</span>
<span id="L848" class="LineNr"> 848 </span><span class="Statement">@@ -0,0 +1,125 @@</span>
<span id="L849" class="LineNr"> 849 </span><span class="Identifier">+/*</span>
<span id="L850" class="LineNr"> 850 </span><span class="Identifier">+ * Copyright 2015 The Netty Project</span>
<span id="L851" class="LineNr"> 851 </span><span class="Identifier">+ *</span>
<span id="L852" class="LineNr"> 852 </span><span class="Identifier">+ * The Netty Project licenses this file to you under the Apache License,</span>
<span id="L853" class="LineNr"> 853 </span><span class="Identifier">+ * version 2.0 (the &quot;License&quot;); you may not use this file except in compliance</span>
<span id="L854" class="LineNr"> 854 </span><span class="Identifier">+ * with the License. You may obtain a copy of the License at:</span>
<span id="L855" class="LineNr"> 855 </span><span class="Identifier">+ *</span>
<span id="L856" class="LineNr"> 856 </span><span class="Identifier">+ *   <a href="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</a></span>
<span id="L857" class="LineNr"> 857 </span><span class="Identifier">+ *</span>
<span id="L858" class="LineNr"> 858 </span><span class="Identifier">+ * Unless required by applicable law or agreed to in writing, software</span>
<span id="L859" class="LineNr"> 859 </span><span class="Identifier">+ * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT</span>
<span id="L860" class="LineNr"> 860 </span><span class="Identifier">+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the</span>
<span id="L861" class="LineNr"> 861 </span><span class="Identifier">+ * License for the specific language governing permissions and limitations</span>
<span id="L862" class="LineNr"> 862 </span><span class="Identifier">+ * under the License.</span>
<span id="L863" class="LineNr"> 863 </span><span class="Identifier">+ */</span>
<span id="L864" class="LineNr"> 864 </span><span class="Identifier">+package io.netty.handler.ssl;</span>
<span id="L865" class="LineNr"> 865 </span><span class="Identifier">+</span>
<span id="L866" class="LineNr"> 866 </span><span class="Identifier">+import io.netty.channel.Channel;</span>
<span id="L867" class="LineNr"> 867 </span><span class="Identifier">+import io.netty.channel.ChannelHandlerContext;</span>
<span id="L868" class="LineNr"> 868 </span><span class="Identifier">+import io.netty.channel.ChannelInboundHandlerAdapter;</span>
<span id="L869" class="LineNr"> 869 </span><span class="Identifier">+import io.netty.channel.ChannelInitializer;</span>
<span id="L870" class="LineNr"> 870 </span><span class="Identifier">+import io.netty.channel.ChannelPipeline;</span>
<span id="L871" class="LineNr"> 871 </span><span class="Identifier">+import io.netty.util.internal.ObjectUtil;</span>
<span id="L872" class="LineNr"> 872 </span><span class="Identifier">+import io.netty.util.internal.logging.InternalLogger;</span>
<span id="L873" class="LineNr"> 873 </span><span class="Identifier">+import io.netty.util.internal.logging.InternalLoggerFactory;</span>
<span id="L874" class="LineNr"> 874 </span><span class="Identifier">+</span>
<span id="L875" class="LineNr"> 875 </span><span class="Identifier">+/**</span>
<span id="L876" class="LineNr"> 876 </span><span class="Identifier">+ * Configures a {@link ChannelPipeline} depending on the application-level protocol negotiation result of</span>
<span id="L877" class="LineNr"> 877 </span><span class="Identifier">+ * {@link SslHandler}.  For example, you could configure your HTTP pipeline depending on the result of ALPN:</span>
<span id="L878" class="LineNr"> 878 </span><span class="Identifier">+ * &lt;pre&gt;</span>
<span id="L879" class="LineNr"> 879 </span><span class="Identifier">+ * public class MyInitializer extends {@link ChannelInitializer}&amp;lt;{@link Channel}&amp;gt; {</span>
<span id="L880" class="LineNr"> 880 </span><span class="Identifier">+ *     private final {@link SslContext} sslCtx;</span>
<span id="L881" class="LineNr"> 881 </span><span class="Identifier">+ *</span>
<span id="L882" class="LineNr"> 882 </span><span class="Identifier">+ *     public MyInitializer({@link SslContext} sslCtx) {</span>
<span id="L883" class="LineNr"> 883 </span><span class="Identifier">+ *         this.sslCtx = sslCtx;</span>
<span id="L884" class="LineNr"> 884 </span><span class="Identifier">+ *     }</span>
<span id="L885" class="LineNr"> 885 </span><span class="Identifier">+ *</span>
<span id="L886" class="LineNr"> 886 </span><span class="Identifier">+ *     protected void initChannel({@link Channel} ch) {</span>
<span id="L887" class="LineNr"> 887 </span><span class="Identifier">+ *         {@link ChannelPipeline} p = ch.pipeline();</span>
<span id="L888" class="LineNr"> 888 </span><span class="Identifier">+ *         p.addLast(sslCtx.newHandler(...)); // Adds {@link SslHandler}</span>
<span id="L889" class="LineNr"> 889 </span><span class="Identifier">+ *         p.addLast(new MyNegotiationHandler());</span>
<span id="L890" class="LineNr"> 890 </span><span class="Identifier">+ *     }</span>
<span id="L891" class="LineNr"> 891 </span><span class="Identifier">+ * }</span>
<span id="L892" class="LineNr"> 892 </span><span class="Identifier">+ *</span>
<span id="L893" class="LineNr"> 893 </span><span class="Identifier">+ * public class MyNegotiationHandler extends {@link ApplicationProtocolNegotiationHandler} {</span>
<span id="L894" class="LineNr"> 894 </span><span class="Identifier">+ *     public MyNegotiationHandler() {</span>
<span id="L895" class="LineNr"> 895 </span><span class="Identifier">+ *         super({@link ApplicationProtocolNames}.HTTP_1_1);</span>
<span id="L896" class="LineNr"> 896 </span><span class="Identifier">+ *     }</span>
<span id="L897" class="LineNr"> 897 </span><span class="Identifier">+ *</span>
<span id="L898" class="LineNr"> 898 </span><span class="Identifier">+ *     protected void configurePipeline({@link ChannelHandlerContext} ctx, String protocol) {</span>
<span id="L899" class="LineNr"> 899 </span><span class="Identifier">+ *         if ({@link ApplicationProtocolNames}.HTTP_2.equals(protocol) {</span>
<span id="L900" class="LineNr"> 900 </span><span class="Identifier">+ *             configureHttp2(ctx);</span>
<span id="L901" class="LineNr"> 901 </span><span class="Identifier">+ *         } else if ({@link ApplicationProtocolNames}.HTTP_1_1.equals(protocol)) {</span>
<span id="L902" class="LineNr"> 902 </span><span class="Identifier">+ *             configureHttp1(ctx);</span>
<span id="L903" class="LineNr"> 903 </span><span class="Identifier">+ *         } else {</span>
<span id="L904" class="LineNr"> 904 </span><span class="Identifier">+ *             throw new IllegalStateException(&quot;unknown protocol: &quot; + protocol);</span>
<span id="L905" class="LineNr"> 905 </span><span class="Identifier">+ *         }</span>
<span id="L906" class="LineNr"> 906 </span><span class="Identifier">+ *     }</span>
<span id="L907" class="LineNr"> 907 </span><span class="Identifier">+ * }</span>
<span id="L908" class="LineNr"> 908 </span><span class="Identifier">+ * &lt;/pre&gt;</span>
<span id="L909" class="LineNr"> 909 </span><span class="Identifier">+ */</span>
<span id="L910" class="LineNr"> 910 </span><span class="Identifier">+public abstract class ApplicationProtocolNegotiationHandler extends ChannelInboundHandlerAdapter {</span>
<span id="L911" class="LineNr"> 911 </span><span class="Identifier">+</span>
<span id="L912" class="LineNr"> 912 </span><span class="Identifier">+    private static final InternalLogger logger =</span>
<span id="L913" class="LineNr"> 913 </span><span class="Identifier">+            InternalLoggerFactory.getInstance(ApplicationProtocolNegotiationHandler.class);</span>
<span id="L914" class="LineNr"> 914 </span><span class="Identifier">+</span>
<span id="L915" class="LineNr"> 915 </span><span class="Identifier">+    private final String fallbackProtocol;</span>
<span id="L916" class="LineNr"> 916 </span><span class="Identifier">+    private SslHandler sslHandler;</span>
<span id="L917" class="LineNr"> 917 </span><span class="Identifier">+</span>
<span id="L918" class="LineNr"> 918 </span><span class="Identifier">+    /**</span>
<span id="L919" class="LineNr"> 919 </span><span class="Identifier">+     * Creates a new instance with the specified fallback protocol name.</span>
<span id="L920" class="LineNr"> 920 </span><span class="Identifier">+     *</span>
<span id="L921" class="LineNr"> 921 </span><span class="Identifier">+     * @param fallbackProtocol the name of the protocol to use when</span>
<span id="L922" class="LineNr"> 922 </span><span class="Identifier">+     *                         ALPN/NPN negotiation fails or the client does not support ALPN/NPN</span>
<span id="L923" class="LineNr"> 923 </span><span class="Identifier">+     */</span>
<span id="L924" class="LineNr"> 924 </span><span class="Identifier">+    protected ApplicationProtocolNegotiationHandler(String fallbackProtocol) {</span>
<span id="L925" class="LineNr"> 925 </span><span class="Identifier">+        this.fallbackProtocol = ObjectUtil.checkNotNull(fallbackProtocol, &quot;fallbackProtocol&quot;);</span>
<span id="L926" class="LineNr"> 926 </span><span class="Identifier">+    }</span>
<span id="L927" class="LineNr"> 927 </span><span class="Identifier">+</span>
<span id="L928" class="LineNr"> 928 </span><span class="Identifier">+    @Override</span>
<span id="L929" class="LineNr"> 929 </span><span class="Identifier">+    public void handlerAdded(ChannelHandlerContext ctx) throws Exception {</span>
<span id="L930" class="LineNr"> 930 </span><span class="Identifier">+        // FIXME: There is no way to tell if the SSL handler is placed before the negotiation handler.</span>
<span id="L931" class="LineNr"> 931 </span><span class="Identifier">+        final SslHandler sslHandler = ctx.pipeline().get(SslHandler.class);</span>
<span id="L932" class="LineNr"> 932 </span><span class="Identifier">+        if (sslHandler == null) {</span>
<span id="L933" class="LineNr"> 933 </span><span class="Identifier">+            throw new IllegalStateException(</span>
<span id="L934" class="LineNr"> 934 </span><span class="Identifier">+                    &quot;cannot find a SslHandler in the pipeline (required for application-level protocol negotiation)&quot;);</span>
<span id="L935" class="LineNr"> 935 </span><span class="Identifier">+        }</span>
<span id="L936" class="LineNr"> 936 </span><span class="Identifier">+</span>
<span id="L937" class="LineNr"> 937 </span><span class="Identifier">+        this.sslHandler = sslHandler;</span>
<span id="L938" class="LineNr"> 938 </span><span class="Identifier">+    }</span>
<span id="L939" class="LineNr"> 939 </span><span class="Identifier">+</span>
<span id="L940" class="LineNr"> 940 </span><span class="Identifier">+    @Override</span>
<span id="L941" class="LineNr"> 941 </span><span class="Identifier">+    public void userEventTriggered(ChannelHandlerContext ctx, Object evt) throws Exception {</span>
<span id="L942" class="LineNr"> 942 </span><span class="Identifier">+        if (evt instanceof SslHandshakeCompletionEvent) {</span>
  <p>This class is quite 'simple' because the ssl handler will perform handshaking and package the result in the event
  that can be handled here. All that's needed is to parse the result and configure the pipeline. It is amazing to see
  how event-processing model makes this handler so simple to write.</p>
<span id="L943" class="LineNr"> 943 </span><span class="Identifier">+            ctx.pipeline().remove(this);</span>
<span id="L944" class="LineNr"> 944 </span><span class="Identifier">+</span>
<span id="L945" class="LineNr"> 945 </span><span class="Identifier">+            SslHandshakeCompletionEvent handshakeEvent = (SslHandshakeCompletionEvent) evt;</span>
<span id="L946" class="LineNr"> 946 </span><span class="Identifier">+            if (handshakeEvent.isSuccess()) {</span>
<span id="L947" class="LineNr"> 947 </span><span class="Identifier">+                String protocol = sslHandler.applicationProtocol();</span>
<span id="L948" class="LineNr"> 948 </span><span class="Identifier">+                configurePipeline(ctx, protocol != null? protocol : fallbackProtocol);</span>
<span id="L949" class="LineNr"> 949 </span><span class="Identifier">+            } else {</span>
<span id="L950" class="LineNr"> 950 </span><span class="Identifier">+                logger.warn(&quot;{} TLS handshake failed:&quot;, ctx.channel(), handshakeEvent.cause());</span>
<span id="L951" class="LineNr"> 951 </span><span class="Identifier">+                ctx.close();</span>
<span id="L952" class="LineNr"> 952 </span><span class="Identifier">+            }</span>
<span id="L953" class="LineNr"> 953 </span><span class="Identifier">+        }</span>
<span id="L954" class="LineNr"> 954 </span><span class="Identifier">+</span>
<span id="L955" class="LineNr"> 955 </span><span class="Identifier">+        ctx.fireUserEventTriggered(evt);</span>
<span id="L956" class="LineNr"> 956 </span><span class="Identifier">+    }</span>
<span id="L957" class="LineNr"> 957 </span><span class="Identifier">+</span>
<span id="L958" class="LineNr"> 958 </span><span class="Identifier">+    /**</span>
<span id="L959" class="LineNr"> 959 </span><span class="Identifier">+     * Invoked on successful initial SSL/TLS handshake. Implement this method to configure your pipeline</span>
<span id="L960" class="LineNr"> 960 </span><span class="Identifier">+     * for the negotiated application-level protocol.</span>
<span id="L961" class="LineNr"> 961 </span><span class="Identifier">+     *</span>
<span id="L962" class="LineNr"> 962 </span><span class="Identifier">+     * @param protocol the name of the negotiated application-level protocol, or</span>
<span id="L963" class="LineNr"> 963 </span><span class="Identifier">+     *                 the fallback protocol name specified in the constructor call if negotiation failed or the client</span>
<span id="L964" class="LineNr"> 964 </span><span class="Identifier">+     *                 isn't aware of ALPN/NPN extension</span>
<span id="L965" class="LineNr"> 965 </span><span class="Identifier">+     */</span>
<span id="L966" class="LineNr"> 966 </span><span class="Identifier">+    protected abstract void configurePipeline(ChannelHandlerContext ctx, String protocol) throws Exception;</span>
<span id="L967" class="LineNr"> 967 </span><span class="Identifier">+</span>
<span id="L968" class="LineNr"> 968 </span><span class="Identifier">+    @Override</span>
<span id="L969" class="LineNr"> 969 </span><span class="Identifier">+    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception {</span>
<span id="L970" class="LineNr"> 970 </span><span class="Identifier">+        logger.warn(&quot;{} Failed to select the application-level protocol:&quot;, ctx.channel(), cause);</span>
<span id="L971" class="LineNr"> 971 </span><span class="Identifier">+        ctx.close();</span>
<span id="L972" class="LineNr"> 972 </span><span class="Identifier">+    }</span>
<span id="L973" class="LineNr"> 973 </span><span class="Identifier">+}</span>
<span id="L974" class="LineNr"> 974 </span><span class="Type">diff --git a/handler/src/main/java/io/netty/handler/ssl/ApplicationProtocolUtil.java b/handler/src/main/java/io/netty/handler/ssl/ApplicationProtocolUtil.java</span>
<span id="L975" class="LineNr"> 975 </span>index 03a077e..0581e9b 100644
<span id="L976" class="LineNr"> 976 </span><span class="Type">--- a/handler/src/main/java/io/netty/handler/ssl/ApplicationProtocolUtil.java</span>
<span id="L977" class="LineNr"> 977 </span><span class="Type">+++ b/handler/src/main/java/io/netty/handler/ssl/ApplicationProtocolUtil.java</span>
<span id="L978" class="LineNr"> 978 </span><span class="Statement">@@ -22,7 +22,6 @@</span><span class="PreProc"> import java.util.List;</span>
<span id="L979" class="LineNr"> 979 </span>  * Utility class for application protocol common operations.
<span id="L980" class="LineNr"> 980 </span>  */
<span id="L981" class="LineNr"> 981 </span> final class ApplicationProtocolUtil {
<span id="L982" class="LineNr"> 982 </span><span class="Special">-</span>
<span id="L983" class="LineNr"> 983 </span>     private static final int DEFAULT_LIST_SIZE = 2;
<span id="L984" class="LineNr"> 984 </span>
<span id="L985" class="LineNr"> 985 </span>     private ApplicationProtocolUtil() {
<span id="L986" class="LineNr"> 986 </span><span class="Type">diff --git a/handler/src/main/java/io/netty/handler/ssl/SslHandshakeCompletionEvent.java b/handler/src/main/java/io/netty/handler/ssl/SslHandshakeCompletionEvent.java</span>
<span id="L987" class="LineNr"> 987 </span>index b2a1de0..a81e087 100644
<span id="L988" class="LineNr"> 988 </span><span class="Type">--- a/handler/src/main/java/io/netty/handler/ssl/SslHandshakeCompletionEvent.java</span>
<span id="L989" class="LineNr"> 989 </span><span class="Type">+++ b/handler/src/main/java/io/netty/handler/ssl/SslHandshakeCompletionEvent.java</span>
<span id="L990" class="LineNr"> 990 </span><span class="Statement">@@ -61,11 +61,7 @@</span><span class="PreProc"> public final class SslHandshakeCompletionEvent {</span>
<span id="L991" class="LineNr"> 991 </span>
<span id="L992" class="LineNr"> 992 </span>     @Override
<span id="L993" class="LineNr"> 993 </span>     public String toString() {
<span id="L994" class="LineNr"> 994 </span><span class="Special">-        Throwable cause = cause();</span>
<span id="L995" class="LineNr"> 995 </span><span class="Special">-        if (cause == null) {</span>
<span id="L996" class="LineNr"> 996 </span><span class="Special">-            return &quot;SslHandshakeCompletionEvent(SUCCESS)&quot;;</span>
<span id="L997" class="LineNr"> 997 </span><span class="Special">-        } else {</span>
<span id="L998" class="LineNr"> 998 </span><span class="Special">-            return &quot;SslHandshakeCompletionEvent(&quot; + cause + ')';</span>
<span id="L999" class="LineNr"> 999 </span><span class="Special">-        }</span>
<span id="L1000" class="LineNr">1000 </span><span class="Identifier">+        final Throwable cause = cause();</span>
<span id="L1001" class="LineNr">1001 </span><span class="Identifier">+        return cause == null? &quot;SslHandshakeCompletionEvent(SUCCESS)&quot; : &quot;SslHandshakeCompletionEvent(&quot; + cause + ')';</span>
<span id="L1002" class="LineNr">1002 </span>     }
<span id="L1003" class="LineNr">1003 </span> }
</pre>
</body>
</html>
<!-- vim: set foldmethod=manual : -->
