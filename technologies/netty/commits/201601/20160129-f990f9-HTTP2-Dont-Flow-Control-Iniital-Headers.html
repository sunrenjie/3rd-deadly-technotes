<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>20160129-f990f9-HTTP2-Dont-Flow-Control-Iniital-Headers.html</title>
<meta name="Generator" content="Vim/7.4">
<meta name="plugin-version" content="vim7.4_v1">
<meta name="syntax" content="git">
<meta name="settings" content="number_lines,use_css,pre_wrap,no_foldcolumn,expand_tabs,line_ids,prevent_copy=">
<meta name="colorscheme" content="none">
<style type="text/css">
<!--
pre { white-space: pre-wrap; font-family: monospace; color: #000000; background-color: #ffffff; }
body { font-family: monospace; color: #000000; background-color: #ffffff; }
* { font-size: 1em; }
.Special { color: #c000c0; }
.Constant { color: #c00000; }
.LineNr { color: #af5f00; }
.Identifier { color: #008080; }
.Statement { color: #af5f00; }
.PreProc { color: #c000c0; }
.Type { color: #008000; }
.comment {
  font-weight: bold;
  font-size: 16px;
  background: #00FF00;
}
p {
  font-weight: bold;
  background: #00FF00;
}
.defect {
  font-weight: bold;
  background: #FF00FF;
}
-->
</style>

<script type='text/javascript'>
<!--

/* function to open any folds containing a jumped-to line before jumping to it */
function JumpToLine()
{
  var lineNum;
  lineNum = window.location.hash;
  lineNum = lineNum.substr(1); /* strip off '#' */

  if (lineNum.indexOf('L') == -1) {
    lineNum = 'L'+lineNum;
  }
  lineElem = document.getElementById(lineNum);
  /* Always jump to new location even if the line was hidden inside a fold, or
   * we corrected the raw number to a line ID.
   */
  if (lineElem) {
    lineElem.scrollIntoView(true);
  }
  return true;
}
if ('onhashchange' in window) {
  window.onhashchange = JumpToLine;
}

-->
</script>
</head>
<body onload='JumpToLine();'>
<pre id='vimCodeElement'>
<span id="L1" class="LineNr">  1 </span><span class="Statement">commit</span> <span class="Identifier">f990f9983dd0e33fb4efb2212856ce5f9749cf85</span>
<span id="L2" class="LineNr">  2 </span><span class="Statement">Author:</span> <span class="Constant">Scott Mitchell </span><span class="Special">&lt;</span><span class="Special">scott_mitchell@apple.com</span><span class="Special">&gt;</span>
<span id="L3" class="LineNr">  3 </span><span class="Statement">Date:</span>   <span class="Constant">Fri Jan 29 00:45:12 2016 -0800</span>
<span id="L4" class="LineNr">  4 </span>
<span id="L5" class="LineNr">  5 </span>    HTTP/2 Don't Flow Control Iniital Headers
<span id="L6" class="LineNr">  6 </span>
<span id="L7" class="LineNr">  7 </span>    Motivation:
<span id="L8" class="LineNr">  8 </span>    Currently the initial headers for every stream is queued in the flow controller. Since the initial header frame may create streams the peer must receive these frames in the order in which they were created, or else this will be a protocol error and the connection will be closed. Tolerating the initial headers being queued would increase the complexity of the WeightedFairQueueByteDistributor and there is benefit of doing so is not clear.
<span id="L9" class="LineNr">  9 </span>
<span id="L10" class="LineNr"> 10 </span>    Modifications:
<span id="L11" class="LineNr"> 11 </span>    - The initial headers will no longer be queued in the flow controllers
  <p>That means all data structures, code related to flow control of initial headers are removed.
  One bonus is that package-ignoring logic is captured and made into a dedicated function.</p>
<span id="L12" class="LineNr"> 12 </span>
<span id="L13" class="LineNr"> 13 </span>    Result:
<span id="L14" class="LineNr"> 14 </span>    Fixes <a href="https://github.com/netty/netty/issues/4758">https://github.com/netty/netty/issues/4758</a>
<span id="L15" class="LineNr"> 15 </span>---
<span id="L16" class="LineNr"> 16 </span> codec-http2/src/main/java/io/netty/handler/codec/http2/DefaultHttp2Connection.java            | 22 ----------------------
<span id="L17" class="LineNr"> 17 </span> codec-http2/src/main/java/io/netty/handler/codec/http2/DefaultHttp2ConnectionDecoder.java     | 87 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++---------------------
<span id="L18" class="LineNr"> 18 </span> codec-http2/src/main/java/io/netty/handler/codec/http2/DefaultHttp2ConnectionEncoder.java     | 41 +++++++++++++++++++++++++++++------------
<span id="L19" class="LineNr"> 19 </span> codec-http2/src/main/java/io/netty/handler/codec/http2/DefaultHttp2RemoteFlowController.java  |  5 +++++
<span id="L20" class="LineNr"> 20 </span> codec-http2/src/main/java/io/netty/handler/codec/http2/Http2ConnectionHandler.java            |  2 +-
<span id="L21" class="LineNr"> 21 </span> codec-http2/src/main/java/io/netty/handler/codec/http2/Http2RemoteFlowController.java         |  7 +++++++
<span id="L22" class="LineNr"> 22 </span> codec-http2/src/main/java/io/netty/handler/codec/http2/Http2Stream.java                       | 12 ------------
<span id="L23" class="LineNr"> 23 </span> codec-http2/src/test/java/io/netty/handler/codec/http2/DefaultHttp2ConnectionDecoderTest.java | 33 +++++++++++++++++++++++++++++----
<span id="L24" class="LineNr"> 24 </span> codec-http2/src/test/java/io/netty/handler/codec/http2/DefaultHttp2ConnectionEncoderTest.java |  5 +++--
<span id="L25" class="LineNr"> 25 </span> codec-http2/src/test/java/io/netty/handler/codec/http2/Http2ConnectionHandlerTest.java        |  1 -
<span id="L26" class="LineNr"> 26 </span> microbench/src/main/java/io/netty/microbench/http2/NoopHttp2RemoteFlowController.java         |  5 +++++
<span id="L27" class="LineNr"> 27 </span> 11 files changed, 145 insertions(+), 75 deletions(-)
<span id="L28" class="LineNr"> 28 </span>
<span id="L29" class="LineNr"> 29 </span><span class="Type">diff --git a/codec-http2/src/main/java/io/netty/handler/codec/http2/DefaultHttp2Connection.java b/codec-http2/src/main/java/io/netty/handler/codec/http2/DefaultHttp2Connection.java</span>
<span id="L30" class="LineNr"> 30 </span>index 7ce5de2..589546d 100644
<span id="L31" class="LineNr"> 31 </span><span class="Type">--- a/codec-http2/src/main/java/io/netty/handler/codec/http2/DefaultHttp2Connection.java</span>
<span id="L32" class="LineNr"> 32 </span><span class="Type">+++ b/codec-http2/src/main/java/io/netty/handler/codec/http2/DefaultHttp2Connection.java</span>
<span id="L33" class="LineNr"> 33 </span><span class="Statement">@@ -296,7 +296,6 @@</span><span class="PreProc"> public class DefaultHttp2Connection implements Http2Connection {</span>
<span id="L34" class="LineNr"> 34 </span>         private IntObjectMap&lt;DefaultStream&gt; children = IntCollections.emptyMap();
<span id="L35" class="LineNr"> 35 </span>         private int prioritizableForTree = 1;
<span id="L36" class="LineNr"> 36 </span>         private boolean resetSent;
<span id="L37" class="LineNr"> 37 </span><span class="Special">-        private boolean headerSent;</span>
<span id="L38" class="LineNr"> 38 </span>
<span id="L39" class="LineNr"> 39 </span>         DefaultStream(int id, State state) {
<span id="L40" class="LineNr"> 40 </span>             this.id = id;
<span id="L41" class="LineNr"> 41 </span><span class="Statement">@@ -325,17 +324,6 @@</span><span class="PreProc"> public class DefaultHttp2Connection implements Http2Connection {</span>
<span id="L42" class="LineNr"> 42 </span>         }
<span id="L43" class="LineNr"> 43 </span>
<span id="L44" class="LineNr"> 44 </span>         @Override
<span id="L45" class="LineNr"> 45 </span><span class="Special">-        public boolean isHeaderSent() {</span>
<span id="L46" class="LineNr"> 46 </span><span class="Special">-            return headerSent;</span>
<span id="L47" class="LineNr"> 47 </span><span class="Special">-        }</span>
<span id="L48" class="LineNr"> 48 </span><span class="Special">-</span>
<span id="L49" class="LineNr"> 49 </span><span class="Special">-        @Override</span>
<span id="L50" class="LineNr"> 50 </span><span class="Special">-        public Http2Stream headerSent() {</span>
<span id="L51" class="LineNr"> 51 </span><span class="Special">-            headerSent = true;</span>
<span id="L52" class="LineNr"> 52 </span><span class="Special">-            return this;</span>
<span id="L53" class="LineNr"> 53 </span><span class="Special">-        }</span>
<span id="L54" class="LineNr"> 54 </span><span class="Special">-</span>
<span id="L55" class="LineNr"> 55 </span><span class="Special">-        @Override</span>
<span id="L56" class="LineNr"> 56 </span>         public final &lt;V&gt; V setProperty(PropertyKey key, V value) {
<span id="L57" class="LineNr"> 57 </span>             return properties.add(verifyKey(key), value);
<span id="L58" class="LineNr"> 58 </span>         }
<span id="L59" class="LineNr"> 59 </span><span class="Statement">@@ -794,16 +782,6 @@</span><span class="PreProc"> public class DefaultHttp2Connection implements Http2Connection {</span>
<span id="L60" class="LineNr"> 60 </span>         }
<span id="L61" class="LineNr"> 61 </span>
<span id="L62" class="LineNr"> 62 </span>         @Override
<span id="L63" class="LineNr"> 63 </span><span class="Special">-        public boolean isHeaderSent() {</span>
<span id="L64" class="LineNr"> 64 </span><span class="Special">-            return false;</span>
<span id="L65" class="LineNr"> 65 </span><span class="Special">-        }</span>
<span id="L66" class="LineNr"> 66 </span><span class="Special">-</span>
<span id="L67" class="LineNr"> 67 </span><span class="Special">-        @Override</span>
<span id="L68" class="LineNr"> 68 </span><span class="Special">-        public Http2Stream headerSent() {</span>
<span id="L69" class="LineNr"> 69 </span><span class="Special">-            throw new UnsupportedOperationException();</span>
<span id="L70" class="LineNr"> 70 </span><span class="Special">-        }</span>
<span id="L71" class="LineNr"> 71 </span><span class="Special">-</span>
<span id="L72" class="LineNr"> 72 </span><span class="Special">-        @Override</span>
<span id="L73" class="LineNr"> 73 </span>         public Http2Stream setPriority(int parentStreamId, short weight, boolean exclusive) {
<span id="L74" class="LineNr"> 74 </span>             throw new UnsupportedOperationException();
<span id="L75" class="LineNr"> 75 </span>         }
<span id="L76" class="LineNr"> 76 </span><span class="Type">diff --git a/codec-http2/src/main/java/io/netty/handler/codec/http2/DefaultHttp2ConnectionDecoder.java b/codec-http2/src/main/java/io/netty/handler/codec/http2/DefaultHttp2ConnectionDecoder.java</span>
<span id="L77" class="LineNr"> 77 </span>index ccb189f..a138854 100644
<span id="L78" class="LineNr"> 78 </span><span class="Type">--- a/codec-http2/src/main/java/io/netty/handler/codec/http2/DefaultHttp2ConnectionDecoder.java</span>
<span id="L79" class="LineNr"> 79 </span><span class="Type">+++ b/codec-http2/src/main/java/io/netty/handler/codec/http2/DefaultHttp2ConnectionDecoder.java</span>
<span id="L80" class="LineNr"> 80 </span><span class="Statement">@@ -14,6 +14,14 @@</span>
<span id="L81" class="LineNr"> 81 </span>  */
<span id="L82" class="LineNr"> 82 </span> package io.netty.handler.codec.http2;
<span id="L83" class="LineNr"> 83 </span>
<span id="L84" class="LineNr"> 84 </span><span class="Identifier">+import io.netty.buffer.ByteBuf;</span>
<span id="L85" class="LineNr"> 85 </span><span class="Identifier">+import io.netty.channel.ChannelHandlerContext;</span>
<span id="L86" class="LineNr"> 86 </span><span class="Identifier">+import io.netty.handler.codec.http2.Http2Exception.ClosedStreamCreationException;</span>
<span id="L87" class="LineNr"> 87 </span><span class="Identifier">+import io.netty.util.internal.logging.InternalLogger;</span>
<span id="L88" class="LineNr"> 88 </span><span class="Identifier">+import io.netty.util.internal.logging.InternalLoggerFactory;</span>
<span id="L89" class="LineNr"> 89 </span><span class="Identifier">+</span>
<span id="L90" class="LineNr"> 90 </span><span class="Identifier">+import java.util.List;</span>
<span id="L91" class="LineNr"> 91 </span><span class="Identifier">+</span>
<span id="L92" class="LineNr"> 92 </span> import static io.netty.handler.codec.http2.Http2CodecUtil.DEFAULT_PRIORITY_WEIGHT;
<span id="L93" class="LineNr"> 93 </span> import static io.netty.handler.codec.http2.Http2Error.PROTOCOL_ERROR;
<span id="L94" class="LineNr"> 94 </span> import static io.netty.handler.codec.http2.Http2Error.STREAM_CLOSED;
<span id="L95" class="LineNr"> 95 </span><span class="Statement">@@ -23,11 +31,6 @@</span><span class="PreProc"> import static io.netty.handler.codec.http2.Http2PromisedRequestVerifier.ALWAYS_V</span>
<span id="L96" class="LineNr"> 96 </span> import static io.netty.handler.codec.http2.Http2Stream.State.CLOSED;
<span id="L97" class="LineNr"> 97 </span> import static io.netty.handler.codec.http2.Http2Stream.State.HALF_CLOSED_REMOTE;
<span id="L98" class="LineNr"> 98 </span> import static io.netty.util.internal.ObjectUtil.checkNotNull;
<span id="L99" class="LineNr"> 99 </span><span class="Special">-import io.netty.buffer.ByteBuf;</span>
<span id="L100" class="LineNr">100 </span><span class="Special">-import io.netty.channel.ChannelHandlerContext;</span>
<span id="L101" class="LineNr">101 </span><span class="Special">-import io.netty.handler.codec.http2.Http2Exception.ClosedStreamCreationException;</span>
<span id="L102" class="LineNr">102 </span><span class="Special">-</span>
<span id="L103" class="LineNr">103 </span><span class="Special">-import java.util.List;</span>
<span id="L104" class="LineNr">104 </span>
<span id="L105" class="LineNr">105 </span> /**
<span id="L106" class="LineNr">106 </span>  * Provides the default implementation for processing inbound frame events and delegates to a
<span id="L107" class="LineNr">107 </span><span class="Statement">@@ -39,6 +42,7 @@</span><span class="PreProc"> import java.util.List;</span>
<span id="L108" class="LineNr">108 </span>  * {@link Http2LocalFlowController}
<span id="L109" class="LineNr">109 </span>  */
<span id="L110" class="LineNr">110 </span> public class DefaultHttp2ConnectionDecoder implements Http2ConnectionDecoder {
<span id="L111" class="LineNr">111 </span><span class="Identifier">+    private static final InternalLogger logger = InternalLoggerFactory.getInstance(DefaultHttp2ConnectionDecoder.class);</span>
<span id="L112" class="LineNr">112 </span>     private Http2FrameListener internalFrameListener = new PrefaceFrameListener();
<span id="L113" class="LineNr">113 </span>     private final Http2Connection connection;
<span id="L114" class="LineNr">114 </span>     private Http2LifecycleManager lifecycleManager;
<span id="L115" class="LineNr">115 </span><span class="Statement">@@ -185,23 +189,28 @@</span><span class="PreProc"> public class DefaultHttp2ConnectionDecoder implements Http2ConnectionDecoder {</span>
<span id="L116" class="LineNr">116 </span>      */
<span id="L117" class="LineNr">117 </span>     private final class FrameReadListener implements Http2FrameListener {
<span id="L118" class="LineNr">118 </span>         @Override
<span id="L119" class="LineNr">119 </span><span class="Special">-        public int onDataRead(final ChannelHandlerContext ctx, int streamId, ByteBuf data,</span>
<span id="L120" class="LineNr">120 </span><span class="Special">-                int padding, boolean endOfStream) throws Http2Exception {</span>
<span id="L121" class="LineNr">121 </span><span class="Identifier">+        public int onDataRead(final ChannelHandlerContext ctx, int streamId, ByteBuf data, int padding,</span>
<span id="L122" class="LineNr">122 </span><span class="Identifier">+                              boolean endOfStream) throws Http2Exception {</span>
<span id="L123" class="LineNr">123 </span>             Http2Stream stream = connection.stream(streamId);
<span id="L124" class="LineNr">124 </span>             Http2LocalFlowController flowController = flowController();
<span id="L125" class="LineNr">125 </span>             int bytesToReturn = data.readableBytes() + padding;
<span id="L126" class="LineNr">126 </span>
<span id="L127" class="LineNr">127 </span><span class="Special">-            if (stream == null || stream.isResetSent() || streamCreatedAfterGoAwaySent(streamId)) {</span>
<span id="L128" class="LineNr">128 </span><span class="Special">-                // Ignoring this frame. We still need to count the frame towards the connection flow control</span>
<span id="L129" class="LineNr">129 </span><span class="Special">-                // window, but we immediately mark all bytes as consumed.</span>
<span id="L130" class="LineNr">130 </span><span class="Special">-                flowController.receiveFlowControlledFrame(stream, data, padding, endOfStream);</span>
<span id="L131" class="LineNr">131 </span><span class="Special">-                flowController.consumeBytes(stream, bytesToReturn);</span>
<span id="L132" class="LineNr">132 </span><span class="Identifier">+            boolean shouldIgnore = true;</span>
<span id="L133" class="LineNr">133 </span><span class="Identifier">+            try {</span>
<span id="L134" class="LineNr">134 </span><span class="Identifier">+                shouldIgnore = shouldIgnoreHeadersOrDataFrame(ctx, streamId, stream, &quot;DATA&quot;);</span>
<span id="L135" class="LineNr">135 </span><span class="Identifier">+            } finally {</span>
<span id="L136" class="LineNr">136 </span><span class="Identifier">+                if (shouldIgnore) {</span>
<span id="L137" class="LineNr">137 </span><span class="Identifier">+                    // Ignoring this frame. We still need to count the frame towards the connection flow control</span>
<span id="L138" class="LineNr">138 </span><span class="Identifier">+                    // window, but we immediately mark all bytes as consumed.</span>
<span id="L139" class="LineNr">139 </span><span class="Identifier">+                    flowController.receiveFlowControlledFrame(stream, data, padding, endOfStream);</span>
<span id="L140" class="LineNr">140 </span><span class="Identifier">+                    flowController.consumeBytes(stream, bytesToReturn);</span>
<span id="L141" class="LineNr">141 </span>
<span id="L142" class="LineNr">142 </span><span class="Special">-                // Verify that the stream may have existed after we apply flow control.</span>
<span id="L143" class="LineNr">143 </span><span class="Special">-                verifyStreamMayHaveExisted(streamId);</span>
<span id="L144" class="LineNr">144 </span><span class="Identifier">+                    // Verify that the stream may have existed after we apply flow control.</span>
<span id="L145" class="LineNr">145 </span><span class="Identifier">+                    verifyStreamMayHaveExisted(streamId);</span>
<span id="L146" class="LineNr">146 </span>
<span id="L147" class="LineNr">147 </span><span class="Special">-                // All bytes have been consumed.</span>
<span id="L148" class="LineNr">148 </span><span class="Special">-                return bytesToReturn;</span>
<span id="L149" class="LineNr">149 </span><span class="Identifier">+                    // All bytes have been consumed.</span>
<span id="L150" class="LineNr">150 </span><span class="Identifier">+                    return bytesToReturn;</span>
<span id="L151" class="LineNr">151 </span><span class="Identifier">+                }</span>
<span id="L152" class="LineNr">152 </span>             }
  <p>The change is essentially to use the newly created function shouldIgnoreHeadersOrDataFrame() to determine
  whether this DATA frame shall be ignored.</p>
<span id="L153" class="LineNr">153 </span>
<span id="L154" class="LineNr">154 </span>             Http2Exception error = null;
<span id="L155" class="LineNr">155 </span><span class="Statement">@@ -276,8 +285,7 @@</span><span class="PreProc"> public class DefaultHttp2ConnectionDecoder implements Http2ConnectionDecoder {</span>
<span id="L156" class="LineNr">156 </span>                 allowHalfClosedRemote = stream.state() == HALF_CLOSED_REMOTE;
<span id="L157" class="LineNr">157 </span>             }
<span id="L158" class="LineNr">158 </span>
<span id="L159" class="LineNr">159 </span><span class="Special">-            if (stream == null || stream.isResetSent() || streamCreatedAfterGoAwaySent(streamId)) {</span>
<span id="L160" class="LineNr">160 </span><span class="Special">-                // Ignore this frame.</span>
<span id="L161" class="LineNr">161 </span><span class="Identifier">+            if (shouldIgnoreHeadersOrDataFrame(ctx, streamId, stream, &quot;HEADERS&quot;)) {</span>
  <p>And the HEADERS frames.</p>
<span id="L162" class="LineNr">162 </span>                 return;
<span id="L163" class="LineNr">163 </span>             }
<span id="L164" class="LineNr">164 </span>
<span id="L165" class="LineNr">165 </span><span class="Statement">@@ -329,7 +337,10 @@</span><span class="PreProc"> public class DefaultHttp2ConnectionDecoder implements Http2ConnectionDecoder {</span>
<span id="L166" class="LineNr">166 </span>             try {
<span id="L167" class="LineNr">167 </span>                 if (stream == null) {
<span id="L168" class="LineNr">168 </span>                     if (connection.streamMayHaveExisted(streamId)) {
<span id="L169" class="LineNr">169 </span><span class="Special">-                        // Ignore this frame.</span>
<span id="L170" class="LineNr">170 </span><span class="Identifier">+                        if (logger.isInfoEnabled()) {</span>
<span id="L171" class="LineNr">171 </span><span class="Identifier">+                            logger.info(&quot;%s ignoring PRIORITY frame for stream id %d. Stream doesn't exist but may &quot; +</span>
<span id="L172" class="LineNr">172 </span><span class="Identifier">+                                        &quot; have existed&quot;, ctx.channel(), streamId);</span>
<span id="L173" class="LineNr">173 </span><span class="Identifier">+                        }</span>
<span id="L174" class="LineNr">174 </span>                         return;
<span id="L175" class="LineNr">175 </span>                     }
<span id="L176" class="LineNr">176 </span>
<span id="L177" class="LineNr">177 </span><span class="Statement">@@ -337,7 +348,11 @@</span><span class="PreProc"> public class DefaultHttp2ConnectionDecoder implements Http2ConnectionDecoder {</span>
<span id="L178" class="LineNr">178 </span>                     // first frame to be received for a stream that we must create the stream.
<span id="L179" class="LineNr">179 </span>                     stream = connection.remote().createIdleStream(streamId);
<span id="L180" class="LineNr">180 </span>                 } else if (streamCreatedAfterGoAwaySent(streamId)) {
<span id="L181" class="LineNr">181 </span><span class="Special">-                    // Ignore this frame.</span>
<span id="L182" class="LineNr">182 </span><span class="Identifier">+                    if (logger.isInfoEnabled()) {</span>
<span id="L183" class="LineNr">183 </span><span class="Identifier">+                        logger.info(&quot;%s ignoring PRIORITY frame for stream id %d. Stream created after GOAWAY sent. &quot; +</span>
<span id="L184" class="LineNr">184 </span><span class="Identifier">+                                    &quot;Last known stream by peer &quot; + connection.remote().lastStreamKnownByPeer(),</span>
<span id="L185" class="LineNr">185 </span><span class="Identifier">+                                    ctx.channel(), streamId);</span>
<span id="L186" class="LineNr">186 </span><span class="Identifier">+                    }</span>
<span id="L187" class="LineNr">187 </span>                     return;
<span id="L188" class="LineNr">188 </span>                 }
<span id="L189" class="LineNr">189 </span>
  <p>And priority frames.</p>
<span id="L190" class="LineNr">190 </span><span class="Statement">@@ -457,7 +472,7 @@</span><span class="PreProc"> public class DefaultHttp2ConnectionDecoder implements Http2ConnectionDecoder {</span>
<span id="L191" class="LineNr">191 </span>                 Http2Headers headers, int padding) throws Http2Exception {
<span id="L192" class="LineNr">192 </span>             Http2Stream parentStream = connection.stream(streamId);
<span id="L193" class="LineNr">193 </span>
<span id="L194" class="LineNr">194 </span><span class="Special">-            if (streamCreatedAfterGoAwaySent(streamId)) {</span>
<span id="L195" class="LineNr">195 </span><span class="Identifier">+            if (shouldIgnoreHeadersOrDataFrame(ctx, streamId, parentStream, &quot;PUSH_PROMISE&quot;)) {</span>
<span id="L196" class="LineNr">196 </span>                 return;
<span id="L197" class="LineNr">197 </span>             }
<span id="L198" class="LineNr">198 </span>
  <p>And PushPromise frames.</p>
<span id="L199" class="LineNr">199 </span><span class="Statement">@@ -528,6 +543,36 @@</span><span class="PreProc"> public class DefaultHttp2ConnectionDecoder implements Http2ConnectionDecoder {</span>
<span id="L200" class="LineNr">200 </span>         }
<span id="L201" class="LineNr">201 </span>
<span id="L202" class="LineNr">202 </span>         /**
<span id="L203" class="LineNr">203 </span><span class="Identifier">+         * Helper method to determine if a frame that has the semantics of headers or data should be ignored for the</span>
<span id="L204" class="LineNr">204 </span><span class="Identifier">+         * {@code stream} (which may be {@code null}) associated with {@code streamId}.</span>
<span id="L205" class="LineNr">205 </span><span class="Identifier">+         */</span>
<span id="L206" class="LineNr">206 </span><span class="Identifier">+        private boolean shouldIgnoreHeadersOrDataFrame(ChannelHandlerContext ctx, int streamId, Http2Stream stream,</span>
<span id="L207" class="LineNr">207 </span><span class="Identifier">+                String frameName) throws Http2Exception {</span>
<span id="L208" class="LineNr">208 </span><span class="Identifier">+            if (stream == null) {</span>
<span id="L209" class="LineNr">209 </span><span class="Identifier">+                if (streamCreatedAfterGoAwaySent(streamId)) {</span>
<span id="L210" class="LineNr">210 </span><span class="Identifier">+                    if (logger.isInfoEnabled()) {</span>
<span id="L211" class="LineNr">211 </span><span class="Identifier">+                        logger.info(&quot;%s ignoring %s frame for stream id %d. Stream sent after GOAWAY sent&quot;,</span>
<span id="L212" class="LineNr">212 </span><span class="Identifier">+                                ctx.channel(), frameName, streamId);</span>
<span id="L213" class="LineNr">213 </span><span class="Identifier">+                    }</span>
<span id="L214" class="LineNr">214 </span><span class="Identifier">+                    return true;</span>
<span id="L215" class="LineNr">215 </span><span class="Identifier">+                }</span>
<span id="L216" class="LineNr">216 </span><span class="Identifier">+                // Its possible that this frame would result in stream ID out of order creation (PROTOCOL ERROR) and its</span>
<span id="L217" class="LineNr">217 </span><span class="Identifier">+                // also possible that this frame is received on a CLOSED stream (STREAM_CLOSED after a RST_STREAM is</span>
<span id="L218" class="LineNr">218 </span><span class="Identifier">+                // sent). We don't have enough information to know for sure, so we choose the lesser of the two errors.</span>
<span id="L219" class="LineNr">219 </span><span class="Identifier">+                throw streamError(streamId, STREAM_CLOSED, &quot;Received HEADERS frame for an unknown stream %d&quot;, streamId);</span>
<span id="L220" class="LineNr">220 </span><span class="Identifier">+            } else if (stream.isResetSent() || streamCreatedAfterGoAwaySent(streamId)) {</span>
<span id="L221" class="LineNr">221 </span><span class="Identifier">+                if (logger.isInfoEnabled()) {</span>
<span id="L222" class="LineNr">222 </span><span class="Identifier">+                    logger.info(&quot;%s ignoring %s frame for stream id %d. %s&quot;, ctx.channel(), frameName,</span>
<span id="L223" class="LineNr">223 </span><span class="Identifier">+                            stream.isResetSent() ? &quot;RST_STREAM sent.&quot; :</span>
<span id="L224" class="LineNr">224 </span><span class="Identifier">+                                (&quot;Stream created after GOAWAY sent. Last known stream by peer &quot; +</span>
<span id="L225" class="LineNr">225 </span><span class="Identifier">+                                 connection.remote().lastStreamKnownByPeer()));</span>
<span id="L226" class="LineNr">226 </span><span class="Identifier">+                }</span>
<span id="L227" class="LineNr">227 </span><span class="Identifier">+                return true;</span>
<span id="L228" class="LineNr">228 </span><span class="Identifier">+            }</span>
<span id="L229" class="LineNr">229 </span><span class="Identifier">+            return false;</span>
<span id="L230" class="LineNr">230 </span><span class="Identifier">+        }</span>
<span id="L231" class="LineNr">231 </span><span class="Identifier">+</span>
  <a class="defect">This function captures the frame ignoring logic. TODO: the error throwing?</a>
<span id="L232" class="LineNr">232 </span><span class="Identifier">+        /**</span>
<span id="L233" class="LineNr">233 </span>          * Helper method for determining whether or not to ignore inbound frames. A stream is considered to be created
<span id="L234" class="LineNr">234 </span>          * after a {@code GOAWAY} is sent if the following conditions hold:
<span id="L235" class="LineNr">235 </span>          * &lt;p/&gt;
<span id="L236" class="LineNr">236 </span><span class="Type">diff --git a/codec-http2/src/main/java/io/netty/handler/codec/http2/DefaultHttp2ConnectionEncoder.java b/codec-http2/src/main/java/io/netty/handler/codec/http2/DefaultHttp2ConnectionEncoder.java</span>
<span id="L237" class="LineNr">237 </span>index 8c5718a..6ee351c 100644
<span id="L238" class="LineNr">238 </span><span class="Type">--- a/codec-http2/src/main/java/io/netty/handler/codec/http2/DefaultHttp2ConnectionEncoder.java</span>
<span id="L239" class="LineNr">239 </span><span class="Type">+++ b/codec-http2/src/main/java/io/netty/handler/codec/http2/DefaultHttp2ConnectionEncoder.java</span>
<span id="L240" class="LineNr">240 </span><span class="Statement">@@ -14,12 +14,6 @@</span>
<span id="L241" class="LineNr">241 </span>  */
<span id="L242" class="LineNr">242 </span> package io.netty.handler.codec.http2;
<span id="L243" class="LineNr">243 </span>
<span id="L244" class="LineNr">244 </span><span class="Special">-import static io.netty.handler.codec.http2.Http2CodecUtil.DEFAULT_PRIORITY_WEIGHT;</span>
<span id="L245" class="LineNr">245 </span><span class="Special">-import static io.netty.handler.codec.http2.Http2Error.PROTOCOL_ERROR;</span>
<span id="L246" class="LineNr">246 </span><span class="Special">-import static io.netty.handler.codec.http2.Http2Exception.connectionError;</span>
<span id="L247" class="LineNr">247 </span><span class="Special">-import static io.netty.util.internal.ObjectUtil.checkNotNull;</span>
<span id="L248" class="LineNr">248 </span><span class="Special">-import static java.lang.Math.min;</span>
<span id="L249" class="LineNr">249 </span><span class="Special">-</span>
<span id="L250" class="LineNr">250 </span> import io.netty.buffer.ByteBuf;
<span id="L251" class="LineNr">251 </span> import io.netty.channel.ChannelFuture;
<span id="L252" class="LineNr">252 </span> import io.netty.channel.ChannelFutureListener;
<span id="L253" class="LineNr">253 </span><span class="Statement">@@ -30,6 +24,12 @@</span><span class="PreProc"> import io.netty.handler.codec.http2.Http2Exception.ClosedStreamCreationException</span>
<span id="L254" class="LineNr">254 </span>
<span id="L255" class="LineNr">255 </span> import java.util.ArrayDeque;
<span id="L256" class="LineNr">256 </span>
<span id="L257" class="LineNr">257 </span><span class="Identifier">+import static io.netty.handler.codec.http2.Http2CodecUtil.DEFAULT_PRIORITY_WEIGHT;</span>
<span id="L258" class="LineNr">258 </span><span class="Identifier">+import static io.netty.handler.codec.http2.Http2Error.PROTOCOL_ERROR;</span>
<span id="L259" class="LineNr">259 </span><span class="Identifier">+import static io.netty.handler.codec.http2.Http2Exception.connectionError;</span>
<span id="L260" class="LineNr">260 </span><span class="Identifier">+import static io.netty.util.internal.ObjectUtil.checkNotNull;</span>
<span id="L261" class="LineNr">261 </span><span class="Identifier">+import static java.lang.Math.min;</span>
<span id="L262" class="LineNr">262 </span><span class="Identifier">+</span>
<span id="L263" class="LineNr">263 </span> /**
<span id="L264" class="LineNr">264 </span>  * Default implementation of {@link Http2ConnectionEncoder}.
<span id="L265" class="LineNr">265 </span>  */
<span id="L266" class="LineNr">266 </span><span class="Statement">@@ -167,11 +167,29 @@</span><span class="PreProc"> public class DefaultHttp2ConnectionEncoder implements Http2ConnectionEncoder {</span>
<span id="L267" class="LineNr">267 </span>                 }
<span id="L268" class="LineNr">268 </span>             }
<span id="L269" class="LineNr">269 </span>
<span id="L270" class="LineNr">270 </span><span class="Special">-            // Pass headers to the flow-controller so it can maintain their sequence relative to DATA frames.</span>
<span id="L271" class="LineNr">271 </span><span class="Special">-            flowController().addFlowControlled(stream,</span>
<span id="L272" class="LineNr">272 </span><span class="Special">-                    new FlowControlledHeaders(stream, headers, streamDependency, weight, exclusive, padding,</span>
<span id="L273" class="LineNr">273 </span><span class="Special">-                            endOfStream, promise));</span>
<span id="L274" class="LineNr">274 </span><span class="Special">-            return promise;</span>
<span id="L275" class="LineNr">275 </span><span class="Identifier">+            // Trailing headers must go through flow control if there are other frames queued in flow control</span>
<span id="L276" class="LineNr">276 </span><span class="Identifier">+            // for this stream.</span>
<span id="L277" class="LineNr">277 </span><span class="Identifier">+            Http2RemoteFlowController flowController = flowController();</span>
<span id="L278" class="LineNr">278 </span><span class="Identifier">+            if (!endOfStream || !flowController.hasFlowControlled(stream)) {</span>
<span id="L279" class="LineNr">279 </span><span class="Identifier">+                ChannelFuture future = frameWriter.writeHeaders(ctx, streamId, headers, streamDependency, weight,</span>
<span id="L280" class="LineNr">280 </span><span class="Identifier">+                                                                exclusive, padding, endOfStream, promise);</span>
<span id="L281" class="LineNr">281 </span><span class="Identifier">+                if (endOfStream) {</span>
<span id="L282" class="LineNr">282 </span><span class="Identifier">+                    final Http2Stream finalStream = stream;</span>
<span id="L283" class="LineNr">283 </span><span class="Identifier">+                    future.addListener(new ChannelFutureListener() {</span>
<span id="L284" class="LineNr">284 </span><span class="Identifier">+                        @Override</span>
<span id="L285" class="LineNr">285 </span><span class="Identifier">+                        public void operationComplete(ChannelFuture future) throws Exception {</span>
<span id="L286" class="LineNr">286 </span><span class="Identifier">+                            lifecycleManager.closeStreamLocal(finalStream, promise);</span>
<span id="L287" class="LineNr">287 </span><span class="Identifier">+                        }</span>
<span id="L288" class="LineNr">288 </span><span class="Identifier">+                    });</span>
<span id="L289" class="LineNr">289 </span><span class="Identifier">+                }</span>
<span id="L290" class="LineNr">290 </span><span class="Identifier">+                return future;</span>
<span id="L291" class="LineNr">291 </span><span class="Identifier">+            } else {</span>
<span id="L292" class="LineNr">292 </span><span class="Identifier">+                // Pass headers to the flow-controller so it can maintain their sequence relative to DATA frames.</span>
<span id="L293" class="LineNr">293 </span><span class="Identifier">+                flowController.addFlowControlled(stream,</span>
<span id="L294" class="LineNr">294 </span><span class="Identifier">+                        new FlowControlledHeaders(stream, headers, streamDependency, weight, exclusive, padding,</span>
<span id="L295" class="LineNr">295 </span><span class="Identifier">+                                                 endOfStream, promise));</span>
<span id="L296" class="LineNr">296 </span><span class="Identifier">+                return promise;</span>
<span id="L297" class="LineNr">297 </span><span class="Identifier">+            }</span>
  <p>This piece is the core of this commit; it changes the writeHeaders()'s flow control logic
  such that initial headers are not flow-controlled.
  Previously, all headers are flow-controlled addFlowControlled()'ed.
  Now, only HEADERS frames that are end of stream and that its stream has pending frames (hasFlowControlled())
  will still be flow-controlled; others are immediately arranged for writing out (frameWriter.writeHeaders()).
  </p>
<span id="L298" class="LineNr">298 </span>         } catch (Http2NoMoreStreamIdsException e) {
<span id="L299" class="LineNr">299 </span>             lifecycleManager.onError(ctx, e);
<span id="L300" class="LineNr">300 </span>             return promise.setFailure(e);
<span id="L301" class="LineNr">301 </span><span class="Statement">@@ -410,7 +428,6 @@</span><span class="PreProc"> public class DefaultHttp2ConnectionEncoder implements Http2ConnectionEncoder {</span>
<span id="L302" class="LineNr">302 </span>             }
<span id="L303" class="LineNr">303 </span>             promise.addListener(this);
<span id="L304" class="LineNr">304 </span>
<span id="L305" class="LineNr">305 </span><span class="Special">-            stream.headerSent();</span>
<span id="L306" class="LineNr">306 </span>             frameWriter.writeHeaders(ctx, stream.id(), headers, streamDependency, weight, exclusive,
<span id="L307" class="LineNr">307 </span>                     padding, endOfStream, promise);
<span id="L308" class="LineNr">308 </span>         }
<span id="L309" class="LineNr">309 </span><span class="Type">diff --git a/codec-http2/src/main/java/io/netty/handler/codec/http2/DefaultHttp2RemoteFlowController.java b/codec-http2/src/main/java/io/netty/handler/codec/http2/DefaultHttp2RemoteFlowController.java</span>
<span id="L310" class="LineNr">310 </span>index 0acedeb..dd33ce8 100644
<span id="L311" class="LineNr">311 </span><span class="Type">--- a/codec-http2/src/main/java/io/netty/handler/codec/http2/DefaultHttp2RemoteFlowController.java</span>
<span id="L312" class="LineNr">312 </span><span class="Type">+++ b/codec-http2/src/main/java/io/netty/handler/codec/http2/DefaultHttp2RemoteFlowController.java</span>
<span id="L313" class="LineNr">313 </span><span class="Statement">@@ -231,6 +231,11 @@</span><span class="PreProc"> public class DefaultHttp2RemoteFlowController implements Http2RemoteFlowControll</span>
<span id="L314" class="LineNr">314 </span>         }
<span id="L315" class="LineNr">315 </span>     }
<span id="L316" class="LineNr">316 </span>
<span id="L317" class="LineNr">317 </span><span class="Identifier">+    @Override</span>
<span id="L318" class="LineNr">318 </span><span class="Identifier">+    public boolean hasFlowControlled(Http2Stream stream) {</span>
<span id="L319" class="LineNr">319 </span><span class="Identifier">+        return state(stream).hasFrame();</span>
<span id="L320" class="LineNr">320 </span><span class="Identifier">+    }</span>
<span id="L321" class="LineNr">321 </span><span class="Identifier">+</span>
<span id="L322" class="LineNr">322 </span>     private AbstractState state(Http2Stream stream) {
<span id="L323" class="LineNr">323 </span>         return (AbstractState) checkNotNull(stream, &quot;stream&quot;).getProperty(stateKey);
<span id="L324" class="LineNr">324 </span>     }
<span id="L325" class="LineNr">325 </span><span class="Type">diff --git a/codec-http2/src/main/java/io/netty/handler/codec/http2/Http2ConnectionHandler.java b/codec-http2/src/main/java/io/netty/handler/codec/http2/Http2ConnectionHandler.java</span>
<span id="L326" class="LineNr">326 </span>index 28c1804..0dfd1ff 100644
<span id="L327" class="LineNr">327 </span><span class="Type">--- a/codec-http2/src/main/java/io/netty/handler/codec/http2/Http2ConnectionHandler.java</span>
<span id="L328" class="LineNr">328 </span><span class="Type">+++ b/codec-http2/src/main/java/io/netty/handler/codec/http2/Http2ConnectionHandler.java</span>
<span id="L329" class="LineNr">329 </span><span class="Statement">@@ -616,7 +616,7 @@</span><span class="PreProc"> public class Http2ConnectionHandler extends ByteToMessageDecoder implements Http</span>
<span id="L330" class="LineNr">330 </span>         }
<span id="L331" class="LineNr">331 </span>
<span id="L332" class="LineNr">332 </span>         final ChannelFuture future;
<span id="L333" class="LineNr">333 </span><span class="Special">-        if (stream.state() == IDLE || (connection().local().created(stream) &amp;&amp; !stream.isHeaderSent())) {</span>
<span id="L334" class="LineNr">334 </span><span class="Identifier">+        if (stream.state() == IDLE || connection().local().created(stream)) {</span>
  <span class="defect">This change seems to be an innocent one. But it introduces a bug by widening the condition of not sending the RST_STREAM frame:
    <a href="https://github.com/netty/netty/issues/4856">https://github.com/netty/netty/issues/4856</a>.</span>
<span id="L335" class="LineNr">335 </span>             // The other endpoint doesn't know about the stream yet, so we can't actually send
<span id="L336" class="LineNr">336 </span>             // the RST_STREAM frame. The HTTP/2 spec also disallows sending RST_STREAM for IDLE streams.
<span id="L337" class="LineNr">337 </span>             future = promise.setSuccess();
<span id="L338" class="LineNr">338 </span><span class="Type">diff --git a/codec-http2/src/main/java/io/netty/handler/codec/http2/Http2RemoteFlowController.java b/codec-http2/src/main/java/io/netty/handler/codec/http2/Http2RemoteFlowController.java</span>
<span id="L339" class="LineNr">339 </span>index 83fe96d..b586c16 100644
<span id="L340" class="LineNr">340 </span><span class="Type">--- a/codec-http2/src/main/java/io/netty/handler/codec/http2/Http2RemoteFlowController.java</span>
<span id="L341" class="LineNr">341 </span><span class="Type">+++ b/codec-http2/src/main/java/io/netty/handler/codec/http2/Http2RemoteFlowController.java</span>
<span id="L342" class="LineNr">342 </span><span class="Statement">@@ -42,6 +42,13 @@</span><span class="PreProc"> public interface Http2RemoteFlowController extends Http2FlowController {</span>
<span id="L343" class="LineNr">343 </span>     void addFlowControlled(Http2Stream stream, FlowControlled payload);
<span id="L344" class="LineNr">344 </span>
<span id="L345" class="LineNr">345 </span>     /**
<span id="L346" class="LineNr">346 </span><span class="Identifier">+     * Determine if {@code stream} has any {@link FlowControlled} frames currently queued.</span>
<span id="L347" class="LineNr">347 </span><span class="Identifier">+     * @param stream the stream to check if it has flow controlled frames.</span>
<span id="L348" class="LineNr">348 </span><span class="Identifier">+     * @return {@code true} if {@code stream} has any {@link FlowControlled} frames currently queued.</span>
<span id="L349" class="LineNr">349 </span><span class="Identifier">+     */</span>
<span id="L350" class="LineNr">350 </span><span class="Identifier">+    boolean hasFlowControlled(Http2Stream stream);</span>
<span id="L351" class="LineNr">351 </span><span class="Identifier">+</span>
<span id="L352" class="LineNr">352 </span><span class="Identifier">+    /**</span>
<span id="L353" class="LineNr">353 </span>      * Write all data pending in the flow controller up to the flow-control limits.
<span id="L354" class="LineNr">354 </span>      *
<span id="L355" class="LineNr">355 </span>      * @throws Http2Exception throws if a protocol-related error occurred.
<span id="L356" class="LineNr">356 </span><span class="Type">diff --git a/codec-http2/src/main/java/io/netty/handler/codec/http2/Http2Stream.java b/codec-http2/src/main/java/io/netty/handler/codec/http2/Http2Stream.java</span>
<span id="L357" class="LineNr">357 </span>index b1ab5c5..92f57dd 100644
<span id="L358" class="LineNr">358 </span><span class="Type">--- a/codec-http2/src/main/java/io/netty/handler/codec/http2/Http2Stream.java</span>
<span id="L359" class="LineNr">359 </span><span class="Type">+++ b/codec-http2/src/main/java/io/netty/handler/codec/http2/Http2Stream.java</span>
<span id="L360" class="LineNr">360 </span><span class="Statement">@@ -111,18 +111,6 @@</span><span class="PreProc"> public interface Http2Stream {</span>
<span id="L361" class="LineNr">361 </span>     Http2Stream resetSent();
<span id="L362" class="LineNr">362 </span>
<span id="L363" class="LineNr">363 </span>     /**
<span id="L364" class="LineNr">364 </span><span class="Special">-     * Indicates whether or not at least one {@code HEADERS} frame has been sent from the local endpoint</span>
<span id="L365" class="LineNr">365 </span><span class="Special">-     * for this stream.</span>
<span id="L366" class="LineNr">366 </span><span class="Special">-     */</span>
<span id="L367" class="LineNr">367 </span><span class="Special">-    boolean isHeaderSent();</span>
<span id="L368" class="LineNr">368 </span><span class="Special">-</span>
<span id="L369" class="LineNr">369 </span><span class="Special">-    /**</span>
<span id="L370" class="LineNr">370 </span><span class="Special">-     * Sets the flag indicating that a {@code HEADERS} frame has been sent from the local endpoint</span>
<span id="L371" class="LineNr">371 </span><span class="Special">-     * for this stream. This does not affect the stream state.</span>
<span id="L372" class="LineNr">372 </span><span class="Special">-     */</span>
<span id="L373" class="LineNr">373 </span><span class="Special">-    Http2Stream headerSent();</span>
<span id="L374" class="LineNr">374 </span><span class="Special">-</span>
<span id="L375" class="LineNr">375 </span><span class="Special">-    /**</span>
<span id="L376" class="LineNr">376 </span>      * Associates the application-defined data with this stream.
<span id="L377" class="LineNr">377 </span>      * @return The value that was previously associated with {@code key}, or {@code null} if there was none.
<span id="L378" class="LineNr">378 </span>      */
<span id="L379" class="LineNr">379 </span><span class="Type">diff --git a/codec-http2/src/test/java/io/netty/handler/codec/http2/DefaultHttp2ConnectionDecoderTest.java b/codec-http2/src/test/java/io/netty/handler/codec/http2/DefaultHttp2ConnectionDecoderTest.java</span>
<span id="L380" class="LineNr">380 </span>index 042a399..cfca1f8 100644
<span id="L381" class="LineNr">381 </span><span class="Type">--- a/codec-http2/src/test/java/io/netty/handler/codec/http2/DefaultHttp2ConnectionDecoderTest.java</span>
<span id="L382" class="LineNr">382 </span><span class="Type">+++ b/codec-http2/src/test/java/io/netty/handler/codec/http2/DefaultHttp2ConnectionDecoderTest.java</span>
<span id="L383" class="LineNr">383 </span><span class="Statement">@@ -32,6 +32,7 @@</span><span class="PreProc"> import static org.mockito.Matchers.anyInt;</span>
<span id="L384" class="LineNr">384 </span> import static org.mockito.Matchers.anyLong;
<span id="L385" class="LineNr">385 </span> import static org.mockito.Matchers.anyShort;
<span id="L386" class="LineNr">386 </span> import static org.mockito.Matchers.eq;
<span id="L387" class="LineNr">387 </span><span class="Identifier">+import static org.mockito.Matchers.isNull;</span>
<span id="L388" class="LineNr">388 </span> import static org.mockito.Mockito.doAnswer;
<span id="L389" class="LineNr">389 </span> import static org.mockito.Mockito.doNothing;
<span id="L390" class="LineNr">390 </span> import static org.mockito.Mockito.never;
<span id="L391" class="LineNr">391 </span><span class="Statement">@@ -298,6 +299,21 @@</span><span class="PreProc"> public class DefaultHttp2ConnectionDecoderTest {</span>
<span id="L392" class="LineNr">392 </span>     }
<span id="L393" class="LineNr">393 </span>
<span id="L394" class="LineNr">394 </span>     @Test
<span id="L395" class="LineNr">395 </span><span class="Identifier">+    public void dataReadAfterGoAwaySentOnUknownStreamShouldIgnore() throws Exception {</span>
<span id="L396" class="LineNr">396 </span><span class="Identifier">+        // Throw an exception when checking stream state.</span>
<span id="L397" class="LineNr">397 </span><span class="Identifier">+        when(connection.stream(STREAM_ID)).thenReturn(null);</span>
<span id="L398" class="LineNr">398 </span><span class="Identifier">+        mockGoAwaySent();</span>
<span id="L399" class="LineNr">399 </span><span class="Identifier">+        final ByteBuf data = dummyData();</span>
<span id="L400" class="LineNr">400 </span><span class="Identifier">+        try {</span>
<span id="L401" class="LineNr">401 </span><span class="Identifier">+            decode().onDataRead(ctx, STREAM_ID, data, 10, true);</span>
<span id="L402" class="LineNr">402 </span><span class="Identifier">+            verify(localFlow).receiveFlowControlledFrame((Http2Stream) isNull(), eq(data), eq(10), eq(true));</span>
<span id="L403" class="LineNr">403 </span><span class="Identifier">+            verify(listener, never()).onDataRead(eq(ctx), anyInt(), any(ByteBuf.class), anyInt(), anyBoolean());</span>
<span id="L404" class="LineNr">404 </span><span class="Identifier">+        } finally {</span>
<span id="L405" class="LineNr">405 </span><span class="Identifier">+            data.release();</span>
<span id="L406" class="LineNr">406 </span><span class="Identifier">+        }</span>
<span id="L407" class="LineNr">407 </span><span class="Identifier">+    }</span>
<span id="L408" class="LineNr">408 </span><span class="Identifier">+</span>
<span id="L409" class="LineNr">409 </span><span class="Identifier">+    @Test</span>
<span id="L410" class="LineNr">410 </span>     public void dataReadAfterRstStreamForStreamInInvalidStateShouldIgnore() throws Exception {
<span id="L411" class="LineNr">411 </span>         // Throw an exception when checking stream state.
<span id="L412" class="LineNr">412 </span>         when(stream.state()).thenReturn(Http2Stream.State.CLOSED);
<span id="L413" class="LineNr">413 </span><span class="Statement">@@ -369,21 +385,30 @@</span><span class="PreProc"> public class DefaultHttp2ConnectionDecoderTest {</span>
<span id="L414" class="LineNr">414 </span>         }
<span id="L415" class="LineNr">415 </span>     }
<span id="L416" class="LineNr">416 </span>
<span id="L417" class="LineNr">417 </span><span class="Identifier">+    @Test(expected = Http2Exception.class)</span>
<span id="L418" class="LineNr">418 </span><span class="Identifier">+    public void headersReadForUnknownStreamShouldThrow() throws Exception {</span>
<span id="L419" class="LineNr">419 </span><span class="Identifier">+        when(connection.stream(STREAM_ID)).thenReturn(null);</span>
<span id="L420" class="LineNr">420 </span><span class="Identifier">+        decode().onHeadersRead(ctx, STREAM_ID, EmptyHttp2Headers.INSTANCE, 0, false);</span>
<span id="L421" class="LineNr">421 </span><span class="Identifier">+    }</span>
<span id="L422" class="LineNr">422 </span><span class="Identifier">+</span>
<span id="L423" class="LineNr">423 </span>     @Test
<span id="L424" class="LineNr">424 </span><span class="Special">-    public void headersReadAfterGoAwayShouldBeIgnored() throws Exception {</span>
<span id="L425" class="LineNr">425 </span><span class="Special">-        when(connection.goAwaySent()).thenReturn(true);</span>
<span id="L426" class="LineNr">426 </span><span class="Identifier">+    public void headersReadForStreamThatAlreadySentResetShouldBeIgnored() throws Exception {</span>
<span id="L427" class="LineNr">427 </span><span class="Identifier">+        when(stream.isResetSent()).thenReturn(true);</span>
<span id="L428" class="LineNr">428 </span>         decode().onHeadersRead(ctx, STREAM_ID, EmptyHttp2Headers.INSTANCE, 0, false);
<span id="L429" class="LineNr">429 </span><span class="Special">-        verify(remote, never()).createIdleStream(eq(STREAM_ID));</span>
<span id="L430" class="LineNr">430 </span><span class="Identifier">+        verify(remote, never()).createIdleStream(anyInt());</span>
<span id="L431" class="LineNr">431 </span><span class="Identifier">+        verify(remote, never()).createStream(anyInt(), anyBoolean());</span>
<span id="L432" class="LineNr">432 </span>         verify(stream, never()).open(anyBoolean());
<span id="L433" class="LineNr">433 </span>
<span id="L434" class="LineNr">434 </span>         // Verify that the event was absorbed and not propagated to the oberver.
<span id="L435" class="LineNr">435 </span>         verify(listener, never()).onHeadersRead(eq(ctx), anyInt(), any(Http2Headers.class), anyInt(), anyBoolean());
<span id="L436" class="LineNr">436 </span>         verify(remote, never()).createIdleStream(anyInt());
<span id="L437" class="LineNr">437 </span><span class="Identifier">+        verify(remote, never()).createStream(anyInt(), anyBoolean());</span>
<span id="L438" class="LineNr">438 </span>         verify(stream, never()).open(anyBoolean());
<span id="L439" class="LineNr">439 </span>     }
<span id="L440" class="LineNr">440 </span>
<span id="L441" class="LineNr">441 </span>     @Test
<span id="L442" class="LineNr">442 </span><span class="Special">-    public void headersReadForUnknownStreamShouldBeIgnored() throws Exception {</span>
<span id="L443" class="LineNr">443 </span><span class="Identifier">+    public void headersReadForUnknownStreamAfterGoAwayShouldBeIgnored() throws Exception {</span>
<span id="L444" class="LineNr">444 </span><span class="Identifier">+        mockGoAwaySent();</span>
<span id="L445" class="LineNr">445 </span>         when(connection.stream(STREAM_ID)).thenReturn(null);
<span id="L446" class="LineNr">446 </span>         decode().onHeadersRead(ctx, STREAM_ID, EmptyHttp2Headers.INSTANCE, 0, false);
<span id="L447" class="LineNr">447 </span>         verify(remote, never()).createStream(anyInt(), anyBoolean());
<span id="L448" class="LineNr">448 </span><span class="Type">diff --git a/codec-http2/src/test/java/io/netty/handler/codec/http2/DefaultHttp2ConnectionEncoderTest.java b/codec-http2/src/test/java/io/netty/handler/codec/http2/DefaultHttp2ConnectionEncoderTest.java</span>
<span id="L449" class="LineNr">449 </span>index 9158d2b..236fb92 100644
<span id="L450" class="LineNr">450 </span><span class="Type">--- a/codec-http2/src/test/java/io/netty/handler/codec/http2/DefaultHttp2ConnectionEncoderTest.java</span>
<span id="L451" class="LineNr">451 </span><span class="Type">+++ b/codec-http2/src/test/java/io/netty/handler/codec/http2/DefaultHttp2ConnectionEncoderTest.java</span>
<span id="L452" class="LineNr">452 </span><span class="Statement">@@ -265,8 +265,9 @@</span><span class="PreProc"> public class DefaultHttp2ConnectionEncoderTest {</span>
<span id="L453" class="LineNr">453 </span>     public void dataFramesDontMergeWithHeaders() throws Exception {
<span id="L454" class="LineNr">454 </span>         createStream(STREAM_ID, false);
<span id="L455" class="LineNr">455 </span>         final ByteBuf data = dummyData().retain();
<span id="L456" class="LineNr">456 </span><span class="Special">-        encoder.writeData(ctx, STREAM_ID, data, 0, true, newPromise());</span>
<span id="L457" class="LineNr">457 </span><span class="Special">-        encoder.writeHeaders(ctx, STREAM_ID, EmptyHttp2Headers.INSTANCE, 0, false, newPromise());</span>
<span id="L458" class="LineNr">458 </span><span class="Identifier">+        encoder.writeData(ctx, STREAM_ID, data, 0, false, newPromise());</span>
<span id="L459" class="LineNr">459 </span><span class="Identifier">+        when(remoteFlow.hasFlowControlled(any(Http2Stream.class))).thenReturn(true);</span>
<span id="L460" class="LineNr">460 </span><span class="Identifier">+        encoder.writeHeaders(ctx, STREAM_ID, EmptyHttp2Headers.INSTANCE, 0, true, newPromise());</span>
<span id="L461" class="LineNr">461 </span>         List&lt;FlowControlled&gt; capturedWrites = payloadCaptor.getAllValues();
<span id="L462" class="LineNr">462 </span>         assertFalse(capturedWrites.get(0).merge(ctx, capturedWrites.get(1)));
<span id="L463" class="LineNr">463 </span>     }
<span id="L464" class="LineNr">464 </span><span class="Type">diff --git a/codec-http2/src/test/java/io/netty/handler/codec/http2/Http2ConnectionHandlerTest.java b/codec-http2/src/test/java/io/netty/handler/codec/http2/Http2ConnectionHandlerTest.java</span>
<span id="L465" class="LineNr">465 </span>index ac9e8a1..5dcd0cc 100644
<span id="L466" class="LineNr">466 </span><span class="Type">--- a/codec-http2/src/test/java/io/netty/handler/codec/http2/Http2ConnectionHandlerTest.java</span>
<span id="L467" class="LineNr">467 </span><span class="Type">+++ b/codec-http2/src/test/java/io/netty/handler/codec/http2/Http2ConnectionHandlerTest.java</span>
<span id="L468" class="LineNr">468 </span><span class="Statement">@@ -315,7 +315,6 @@</span><span class="PreProc"> public class Http2ConnectionHandlerTest {</span>
<span id="L469" class="LineNr">469 </span>         when(frameWriter.writeRstStream(eq(ctx), eq(STREAM_ID),
<span id="L470" class="LineNr">470 </span>                 anyLong(), any(ChannelPromise.class))).thenReturn(future);
<span id="L471" class="LineNr">471 </span>         when(stream.state()).thenReturn(CLOSED);
<span id="L472" class="LineNr">472 </span><span class="Special">-        when(stream.isHeaderSent()).thenReturn(true);</span>
<span id="L473" class="LineNr">473 </span>         // The stream is &quot;closed&quot; but is still known about by the connection (connection().stream(..)
<span id="L474" class="LineNr">474 </span>         // will return the stream). We should still write a RST_STREAM frame in this scenario.
<span id="L475" class="LineNr">475 </span>         handler.resetStream(ctx, STREAM_ID, STREAM_CLOSED.code(), promise);
<span id="L476" class="LineNr">476 </span><span class="Type">diff --git a/microbench/src/main/java/io/netty/microbench/http2/NoopHttp2RemoteFlowController.java b/microbench/src/main/java/io/netty/microbench/http2/NoopHttp2RemoteFlowController.java</span>
<span id="L477" class="LineNr">477 </span>index ede3a9b..85ba52c 100644
<span id="L478" class="LineNr">478 </span><span class="Type">--- a/microbench/src/main/java/io/netty/microbench/http2/NoopHttp2RemoteFlowController.java</span>
<span id="L479" class="LineNr">479 </span><span class="Type">+++ b/microbench/src/main/java/io/netty/microbench/http2/NoopHttp2RemoteFlowController.java</span>
<span id="L480" class="LineNr">480 </span><span class="Statement">@@ -72,6 +72,11 @@</span><span class="PreProc"> public final class NoopHttp2RemoteFlowController implements Http2RemoteFlowContr</span>
<span id="L481" class="LineNr">481 </span>     }
<span id="L482" class="LineNr">482 </span>
<span id="L483" class="LineNr">483 </span>     @Override
<span id="L484" class="LineNr">484 </span><span class="Identifier">+    public boolean hasFlowControlled(Http2Stream stream) {</span>
<span id="L485" class="LineNr">485 </span><span class="Identifier">+        return false;</span>
<span id="L486" class="LineNr">486 </span><span class="Identifier">+    }</span>
<span id="L487" class="LineNr">487 </span><span class="Identifier">+</span>
<span id="L488" class="LineNr">488 </span><span class="Identifier">+    @Override</span>
<span id="L489" class="LineNr">489 </span>     public void channelHandlerContext(ChannelHandlerContext ctx) throws Http2Exception {
<span id="L490" class="LineNr">490 </span>         this.ctx = ctx;
<span id="L491" class="LineNr">491 </span>     }
</pre>
</body>
</html>
<!-- vim: set foldmethod=manual : -->
